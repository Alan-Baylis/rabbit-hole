!function(t,e,n){"use strict";function i(t,e,n,i,r,s){var a=0;return t>e&&t>n?(r<t&&(a|=2),s<t&&(a|=1)):e>n?(i<e&&(a|=4),s<e&&(a|=1)):(i<n&&(a|=4),r<n&&(a|=2)),a}function r(t,e,n,i){var r=void 0,s=0;return e<n?(r=e,s=0):(r=n,s=1),i<r&&(s=2),Ot[t][s]}function s(t,e,n,a,o,l,u,h,c){var d=t.children,v=void 0,y=void 0,f=void 0,m=void 0;if(o>=0&&l>=0&&u>=0)if(null===d)c.push(t);else{v=i(e,n,a,y=.5*(e+o),f=.5*(n+l),m=.5*(a+u));do{switch(v){case 0:s(d[It[8]],e,n,a,y,f,m,h,c),v=r(v,y,f,m);break;case 1:s(d[It[8]^It[1]],e,n,m,y,f,u,h,c),v=r(v,y,f,u);break;case 2:s(d[It[8]^It[2]],e,f,a,y,l,m,h,c),v=r(v,y,l,m);break;case 3:s(d[It[8]^It[3]],e,f,m,y,l,u,h,c),v=r(v,y,l,u);break;case 4:s(d[It[8]^It[4]],y,n,a,o,f,m,h,c),v=r(v,o,f,m);break;case 5:s(d[It[8]^It[5]],y,n,m,o,f,u,h,c),v=r(v,o,f,u);break;case 6:s(d[It[8]^It[6]],y,f,a,o,l,m,h,c),v=r(v,o,l,m);break;case 7:s(d[It[8]^It[7]],y,f,m,o,l,u,h,c),v=8}}while(v<8)}}function a(t){var e=t.children,n=0,i=void 0,r=void 0,s=void 0;if(null!==e)for(i=0,r=e.length;i<r;++i)(s=1+a(e[i]))>n&&(n=s);return n}function o(t,e,n){var i=t.children,r=void 0,s=void 0;if(qt.min=t.min,qt.max=t.max,e.intersectsBox(qt))if(null!==i)for(r=0,s=i.length;r<s;++r)o(i[r],e,n);else n.push(t)}function l(t,e,n,i){var r=t.children,s=void 0,a=void 0;if(n===e)i.push(t);else if(null!==r)for(++n,s=0,a=r.length;s<a;++s)l(r[s],e,n,i)}function u(t){var e=t.children,n=0,i=void 0,r=void 0;if(null!==e)for(i=0,r=e.length;i<r;++i)n+=u(e[i]);else null!==t.points&&(n=t.points.length);return n}function h(t,e,n,i,r){var s=i.children,a=!1,o=!1,l=void 0,u=void 0;if(i.contains(t,n.bias)){if(null===s){if(null===i.points)i.points=[],i.data=[];else for(l=0,u=i.points.length;!a&&l<u;++l)a=i.points[l].equals(t);a?(i.data[l-1]=e,o=!0):i.points.length<n.maxPoints||r===n.maxDepth?(i.points.push(t.clone()),i.data.push(e),++n.pointCount,o=!0):(i.split(),i.redistribute(n.bias),s=i.children)}if(null!==s)for(++r,l=0,u=s.length;!o&&l<u;++l)o=h(t,e,n,s[l],r)}return o}function c(t,e,n,i){var r=n.children,s=null,a=void 0,o=void 0,l=void 0,h=void 0,d=void 0;if(n.contains(t,e.bias))if(null!==r)for(a=0,o=r.length;null===s&&a<o;++a)s=c(t,e,r[a],n);else if(null!==n.points)for(l=n.points,h=n.data,a=0,o=l.length;a<o;++a)if(l[a].equals(t)){d=o-1,s=h[a],a<d&&(l[a]=l[d],h[a]=h[d]),l.pop(),h.pop(),--e.pointCount,null!==i&&u(i)<=e.maxPoints&&i.merge();break}return s}function d(t,e,n){var i=n.children,r=null,s=void 0,a=void 0,o=void 0;if(n.contains(t,e.bias))if(null!==i)for(s=0,a=i.length;null===r&&s<a;++s)r=d(t,e,i[s]);else for(s=0,a=(o=n.points).length;null===r&&s<a;++s)t.distanceToSquared(o[s])<=Zt&&(r=n.data[s]);return r}function v(t,e,n,i,r,s){var a=i.children,o=null,l=void 0,u=void 0,d=void 0;if(i.contains(t,n.bias))if(i.contains(e,n.bias)){if(null!==a)for(++s,l=0,u=a.length;null===o&&l<u;++l)o=v(t,e,n,a[l],i,s);else for(l=0,u=(d=i.points).length;l<u;++l)if(t.distanceToSquared(d[l])<=Zt){d[l].copy(e),o=i.data[l];break}}else h(e,o=c(t,n,i,r),n,r,s-1);return o}function y(t,e,n,i){var r=i.points,s=i.children,a=null,o=e,l=void 0,u=void 0,h=void 0,c=void 0,d=void 0,v=void 0,f=void 0;if(null!==s)for(l=0,u=(d=s.map(function(e){return{octant:e,distance:e.distanceToCenterSquared(t)}}).sort(function(t,e){return t.distance-e.distance})).length;l<u;++l)(v=d[l].octant).contains(t,o)&&null!==(f=y(t,o,n,v))&&(c=f.point.distanceToSquared(t),(!n||c>0)&&c<o&&(o=c,a=f));else if(null!==r)for(l=0,u=r.length;l<u;++l)h=r[l],c=t.distanceToSquared(h),(!n||c>0)&&c<o&&(o=c,a={point:h.clone(),data:i.data[l]});return a}function f(t,e,n,i,r){var s=i.points,a=i.children,o=e*e,l=void 0,u=void 0,h=void 0,c=void 0,d=void 0;if(null!==a)for(l=0,u=a.length;l<u;++l)(d=a[l]).contains(t,e)&&f(t,e,n,d,r);else if(null!==s)for(l=0,u=s.length;l<u;++l)h=s[l],c=t.distanceToSquared(h),(!n||c>0)&&c<=o&&r.push({point:h.clone(),data:i.data[l]})}function m(t,e){var n=t.elements,i=e.elements,r=void 0;0!==n[1]&&(r=oe.calculateCoefficients(n[0],n[1],n[3]),le.rotateQXY(ve.set(n[0],n[3]),n[1],r),n[0]=ve.x,n[3]=ve.y,le.rotateXY(ve.set(n[2],n[4]),r),n[2]=ve.x,n[4]=ve.y,n[1]=0,le.rotateXY(ve.set(i[0],i[3]),r),i[0]=ve.x,i[3]=ve.y,le.rotateXY(ve.set(i[1],i[4]),r),i[1]=ve.x,i[4]=ve.y,le.rotateXY(ve.set(i[2],i[5]),r),i[2]=ve.x,i[5]=ve.y)}function p(t,e){var n=t.elements,i=e.elements,r=void 0;0!==n[2]&&(r=oe.calculateCoefficients(n[0],n[2],n[5]),le.rotateQXY(ve.set(n[0],n[5]),n[2],r),n[0]=ve.x,n[5]=ve.y,le.rotateXY(ve.set(n[1],n[4]),r),n[1]=ve.x,n[4]=ve.y,n[2]=0,le.rotateXY(ve.set(i[0],i[6]),r),i[0]=ve.x,i[6]=ve.y,le.rotateXY(ve.set(i[1],i[7]),r),i[1]=ve.x,i[7]=ve.y,le.rotateXY(ve.set(i[2],i[8]),r),i[2]=ve.x,i[8]=ve.y)}function g(t,e){var n=t.elements,i=e.elements,r=void 0;0!==n[4]&&(r=oe.calculateCoefficients(n[3],n[4],n[5]),le.rotateQXY(ve.set(n[3],n[5]),n[4],r),n[3]=ve.x,n[5]=ve.y,le.rotateXY(ve.set(n[1],n[2]),r),n[1]=ve.x,n[2]=ve.y,n[4]=0,le.rotateXY(ve.set(i[3],i[6]),r),i[3]=ve.x,i[6]=ve.y,le.rotateXY(ve.set(i[4],i[7]),r),i[4]=ve.x,i[7]=ve.y,le.rotateXY(ve.set(i[5],i[8]),r),i[5]=ve.x,i[8]=ve.y)}function x(t,e){var n=t.elements,i=void 0;for(i=0;i<he;++i)m(t,e),p(t,e),g(t,e);return ye.set(n[0],n[3],n[5])}function w(t){var e=1/t;return Math.abs(t)<ue||Math.abs(e)<ue?0:e}function k(t,e){var n=t.elements,i=n[0],r=n[3],s=n[6],a=n[1],o=n[4],l=n[7],u=n[2],h=n[5],c=n[8],d=w(e.x),v=w(e.y),y=w(e.z);return t.set(i*d*i+r*v*r+s*y*s,i*d*a+r*v*o+s*y*l,i*d*u+r*v*h+s*y*c,a*d*i+o*v*r+l*y*s,a*d*a+o*v*o+l*y*l,a*d*u+o*v*h+l*y*c,u*d*i+h*v*r+c*y*s,u*d*a+h*v*o+c*y*l,u*d*u+h*v*h+c*y*c)}function b(t){var e=ke,n=re.resolution,i=new H(0,0,0),r=new H(n,n,n),s=new W(be,be.clone().addScalar(ke));return t.type!==L.INTERSECTION&&(t.boundingBox.intersectsBox(s)?(i.copy(t.boundingBox.min).max(s.min).sub(s.min),i.x=Math.ceil(i.x*n/e),i.y=Math.ceil(i.y*n/e),i.z=Math.ceil(i.z*n/e),r.copy(t.boundingBox.max).min(s.max).sub(s.min),r.x=Math.floor(r.x*n/e),r.y=Math.floor(r.y*n/e),r.z=Math.floor(r.z*n/e)):(i.set(n,n,n),r.set(0,0,0))),new W(i,r)}function z(t,e,n,i){var r=re.resolution+1,s=r*r,a=i.max.x,o=i.max.y,l=i.max.z,u=void 0,h=void 0,c=void 0;for(c=i.min.z;c<=l;++c)for(h=i.min.y;h<=o;++h)for(u=i.min.x;u<=a;++u)t.updateMaterialIndex(c*s+h*r+u,e,n)}function _(t,e,n){var i=ke,r=re.resolution,s=r+1,a=s*s,o=e.materialIndices,l=be,u=new H,h=new H,c=n.max.x,d=n.max.y,v=n.max.z,y=void 0,f=0,m=void 0,p=void 0,g=void 0;for(g=n.min.z;g<=v;++g)for(u.z=g*i/r,p=n.min.y;p<=d;++p)for(u.y=p*i/r,m=n.min.x;m<=c;++m)u.x=m*i/r,(y=t.generateMaterialIndex(h.addVectors(l,u)))!==J.AIR&&(o[g*a+p*s+m]=y,++f);e.materials=f}function M(t,e,n){var i=re.resolution,r=i+1,s=r*r,a=new Uint32Array([1,r,s]),o=e.materialIndices,l=new Qt,u=new Qt,h=n.edgeData,c=e.edgeData,d=new Uint32Array(3),v=ee.calculate1DEdgeCount(i),y=new ee(Math.min(v,c.indices[0].length+h.indices[0].length),Math.min(v,c.indices[1].length+h.indices[1].length),Math.min(v,c.indices[2].length+h.indices[2].length)),f=void 0,m=void 0,p=void 0,g=void 0,x=void 0,w=void 0,k=void 0,b=void 0,z=void 0,_=void 0,M=void 0,A=void 0,E=void 0,S=void 0,D=void 0,P=void 0,I=void 0,O=void 0,C=void 0,U=void 0,R=void 0,N=void 0;for(I=0,O=0;O<3;I=0,++O){for(f=h.indices[O],g=c.indices[O],k=y.indices[O],m=h.zeroCrossings[O],x=c.zeroCrossings[O],b=y.zeroCrossings[O],p=h.normals[O],w=c.normals[O],z=y.normals[O],R=f.length,N=g.length,C=0,U=0;C<R;++C)if(_=f[C],M=_+a[O],S=o[_],D=o[M],S!==D&&(S===J.AIR||D===J.AIR)){for(l.t=m[C],l.n.x=p[3*C],l.n.y=p[3*C+1],l.n.z=p[3*C+2],t.type===L.DIFFERENCE&&l.n.negate(),P=l;U<N&&g[U]<=_;)E=(A=g[U])+a[O],u.t=x[U],u.n.x=w[3*U],u.n.y=w[3*U+1],u.n.z=w[3*U+2],S=o[A],A<_?S===(D=o[E])||S!==J.AIR&&D!==J.AIR||(k[I]=A,b[I]=u.t,z[3*I]=u.n.x,z[3*I+1]=u.n.y,z[3*I+2]=u.n.z,++I):P=t.selectEdge(u,l,S===J.SOLID),++U;k[I]=_,b[I]=P.t,z[3*I]=P.n.x,z[3*I+1]=P.n.y,z[3*I+2]=P.n.z,++I}for(;U<N;)E=(A=g[U])+a[O],(S=o[A])===(D=o[E])||S!==J.AIR&&D!==J.AIR||(k[I]=A,b[I]=x[U],z[3*I]=w[3*U],z[3*I+1]=w[3*U+1],z[3*I+2]=w[3*U+2],++I),++U;d[O]=I}return{edgeData:y,lengths:d}}function A(t,e,n){var i=ke,r=re.resolution,s=r+1,a=s*s,o=new Uint32Array([1,s,a]),l=e.materialIndices,u=be,h=new H,c=new H,d=new Qt,v=new Uint32Array(3),y=new ee(ee.calculate1DEdgeCount(r)),f=void 0,m=void 0,p=void 0,g=void 0,x=void 0,w=void 0,k=void 0,b=void 0,z=void 0,_=void 0,M=void 0,A=void 0,E=void 0,S=void 0,D=void 0,P=void 0,I=void 0,O=void 0;for(S=4,A=0,E=0;E<3;S>>=1,A=0,++E){switch(D=Mt[S],f=y.indices[E],m=y.zeroCrossings[E],p=y.normals[E],w=n.min.x,z=n.max.x,k=n.min.y,_=n.max.y,b=n.min.z,M=n.max.z,E){case 0:w=Math.max(w-1,0),z=Math.min(z,r-1);break;case 1:k=Math.max(k-1,0),_=Math.min(_,r-1);break;case 2:b=Math.max(b-1,0),M=Math.min(M,r-1)}for(O=b;O<=M;++O)for(I=k;I<=_;++I)for(P=w;P<=z;++P)x=(g=O*a+I*s+P)+o[E],l[g]!==l[x]&&(h.set(P*i/r,I*i/r,O*i/r),c.set((P+D[0])*i/r,(I+D[1])*i/r,(O+D[2])*i/r),d.a.addVectors(u,h),d.b.addVectors(u,c),t.generateEdge(d),f[A]=g,m[A]=d.t,p[3*A]=d.n.x,p[3*A+1]=d.n.y,p[3*A+2]=d.n.z,++A);v[E]=A}return{edgeData:y,lengths:v}}function E(t,e,n){var i=b(t),r=void 0,s=void 0,a=void 0,o=void 0,l=!1;if(t.type===L.DENSITY_FUNCTION?_(t,e,i):e.empty?t.type===L.UNION&&(e.set(n),l=!0):e.full&&t.type===L.UNION||z(t,e,n,i),!l&&!e.empty&&!e.full){for(s=(r=t.type===L.DENSITY_FUNCTION?A(t,e,i):M(t,e,n)).edgeData,a=r.lengths,o=0;o<3;++o)s.indices[o]=s.indices[o].slice(0,a[o]),s.zeroCrossings[o]=s.zeroCrossings[o].slice(0,a[o]),s.normals[o]=s.normals[o].slice(0,3*a[o]);e.edgeData=s}}function S(t){var e=t.children,n=void 0,i=void 0,r=void 0,s=void 0;for(t.type===L.DENSITY_FUNCTION&&E(t,n=new re),r=0,s=e.length;r<s&&(i=S(e[r]),void 0===n?n=i:null!==i?null===n?t.type===L.UNION&&(n=i):E(t,n,i):t.type===L.INTERSECTION&&(n=null),null!==n||t.type===L.UNION);++r);return null!==n&&n.empty?null:n}function D(t,e,n,i,r){var s=t+1,a=s*s,o=new we,l=void 0,u=void 0,h=void 0,c=void 0,d=void 0;for(l=0,d=0;d<8;++d)c=(i+(h=Mt[d])[2])*a+(n+h[1])*s+(e+h[0]),l|=Math.min(r[c],J.SOLID)<<d;for(u=0,d=0;d<12;++d)(l>>At[d][0]&1)!==(l>>At[d][1]&1)&&++u;return o.materials=l,o.edgeCount=u,o.qefData=new ge,o}e=e&&e.hasOwnProperty("default")?e.default:e,n=n&&n.hasOwnProperty("default")?n.default:n;var P=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},I=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),O=function t(e,n,i){null===e&&(e=Function.prototype);var r=Object.getOwnPropertyDescriptor(e,n);if(void 0===r){var s=Object.getPrototypeOf(e);return null===s?void 0:t(s,n,i)}if("value"in r)return r.value;var a=r.get;if(void 0!==a)return a.call(i)},C=function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)},U=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e},R=function(t){if(Array.isArray(t)){for(var e=0,n=Array(t.length);e<t.length;e++)n[e]=t[e];return n}return Array.from(t)},N=(function(){function t(){P(this,t)}I(t,[{key:"serialize",value:function(){throw new Error("Serializable#serialise method not implemented!")}}])}(),function(){function t(){P(this,t)}I(t,[{key:"deserialize",value:function(t){throw new Error("Deserializable#deserialise method not implemented!")}}])}(),function(){function t(){P(this,t)}I(t,[{key:"createTransferList",value:function(){arguments.length>0&&void 0!==arguments[0]&&arguments[0];throw new Error("TransferableContainer#createTransferList method not implemented!")}}])}(),function t(){P(this,t)}),L={UNION:"csg.union",DIFFERENCE:"csg.difference",INTERSECTION:"csg.intersection",DENSITY_FUNCTION:"csg.densityfunction"},T=function(){function t(){P(this,t),this.elements=[]}return I(t,[{key:"push",value:function(t){return this.elements.push(t)}},{key:"pop",value:function(){return this.elements.pop()}},{key:"combine",value:function(){var t=this.elements,e=null,n=null,i=void 0,r=void 0;for(i=0,r=t.length;i<r;++i)if(n=t[i],null!==e)switch(n.operation){case L.UNION:e.union(n);break;case L.DIFFERENCE:e.subtract(n);break;case L.INTERSECTION:e.intersect(n)}else e=n;return e}},{key:"clear",value:function(){this.elements=[]}}]),t}(),B=function(){function t(){P(this,t),this.elements=[],this.head=0,this.size=0}return I(t,[{key:"add",value:function(t){var e=this.elements.length;return this.elements.push(t),++this.size,e}},{key:"remove",value:function(t){var e=this.elements,n=e.length,i=null;if(this.size>0&&t>=0&&t<n&&null!==(i=e[t]))if(e[t]=null,--this.size>0){for(;this.head<n&&null===e[this.head];)++this.head;this.head===n&&this.clear()}else this.clear();return i}},{key:"peek",value:function(){return this.size>0?this.elements[this.head]:null}},{key:"poll",value:function(){var t=this.elements,e=t.length,n=null;if(this.size>0){for(n=t[this.head++];this.head<e&&null===t[this.head];)++this.head;this.head===e?this.clear():--this.size}return n}},{key:"clear",value:function(){this.elements=[],this.head=0,this.size=0}}]),t}(),F=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;P(this,e);var n=U(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));for(t=Math.max(1,t);t-- >0;)n.elements.push(new B);return n}return C(e,B),I(e,[{key:"add",value:function(t,e){var n=-1;return e>=0&&e<this.elements.length&&(n=this.elements[e].add(t),e>this.head&&(this.head=e),++this.size),n}},{key:"remove",value:function(t,e){var n=null;if(e>=0&&e<this.elements.length&&null!==(n=this.elements[e].remove(t)))for(--this.size;this.head>0&&0===this.elements[this.head].size;)--this.head;return n}},{key:"peek",value:function(){return this.size>0?this.elements[this.head].peek():null}},{key:"poll",value:function(){var t=null;if(this.size>0)for(t=this.elements[this.head].poll(),--this.size;this.head>0&&0===this.elements[this.head].size;)--this.head;return t}},{key:"clear",value:function(){var t=void 0;for(t=this.elements.length-1;t>=0;--t)this.elements[t].clear();this.head=0,this.size=0}},{key:"tiers",get:function(){return this.elements.length}}]),e}(),q=(function(t){function e(t){P(this,e);var n=U(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));return n.registry=new WeakMap,n.maxPriority=n.tiers-1,n}C(e,F),I(e,[{key:"cancel",value:function(t){var e=this.registry.has(t),n=void 0;return e&&(n=this.registry.get(t),this.remove(n.index,n.priority),this.registry.delete(t)),e}},{key:"schedule",value:function(t,e){var n=!this.registry.has(t);return n&&(null!==e&&(this.remove(e.index,e.priority),this.registry.delete(t)),e.index=this.add(e,e.priority),this.registry.set(t,e)),n}},{key:"hasTask",value:function(t){return this.registry.has(t)}},{key:"getTask",value:function(t){return this.registry.get(t)}},{key:"poll",value:function(){var t=O(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"poll",this).call(this);return null!==t&&this.registry.delete(t.chunk),t}},{key:"clear",value:function(){O(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"clear",this).call(this),this.registry=new WeakMap}}])}(),function t(e){P(this,t),this.type=e,this.target=null}),V=function(){function t(){P(this,t),this.listenerFunctions=new Map,this.listenerObjects=new Map}return I(t,[{key:"addEventListener",value:function(t,e){var n="function"==typeof e?this.listenerFunctions:this.listenerObjects;n.has(t)?n.get(t).add(e):n.set(t,new Set([e]))}},{key:"removeEventListener",value:function(t,e){var n="function"==typeof e?this.listenerFunctions:this.listenerObjects,i=void 0;n.has(t)&&((i=n.get(t)).delete(e),0===i.size&&n.delete(t))}},{key:"dispatchEvent",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this,n=e.listenerFunctions,i=e.listenerObjects,r=void 0;if(t.target=e,n.has(t.type)){r=n.get(t.type);var s=!0,a=!1,o=void 0;try{for(var l,u=r[Symbol.iterator]();!(s=(l=u.next()).done);s=!0)l.value.call(e,t)}catch(t){a=!0,o=t}finally{try{!s&&u.return&&u.return()}finally{if(a)throw o}}}if(i.has(t.type)){r=i.get(t.type);var h=!0,c=!1,d=void 0;try{for(var v,y=r[Symbol.iterator]();!(h=(v=y.next()).done);h=!0)v.value.handleEvent(t)}catch(t){c=!0,d=t}finally{try{!h&&y.return&&y.return()}finally{if(c)throw d}}}}}]),t}(),j="#define PHYSICAL\r\n\r\nuniform vec3 diffuse;\r\nuniform vec3 emissive;\r\nuniform float roughness;\r\nuniform float metalness;\r\nuniform float opacity;\r\n\r\n#ifndef STANDARD\r\n\tuniform float clearCoat;\r\n\tuniform float clearCoatRoughness;\r\n#endif\r\n\r\nvarying vec3 vViewPosition;\r\n\r\n#ifndef FLAT_SHADED\r\n\r\n\tvarying vec3 vNormal;\r\n\r\n#endif\r\n\r\n#include <common>\r\n#include <packing>\r\n#include <color_pars_fragment>\r\n#include <map_triplanar_pars_fragment>\r\n#include <alphamap_pars_fragment>\r\n#include <specularmap_pars_fragment>\r\n#include <lightmap_pars_fragment>\r\n#include <emissivemap_pars_fragment>\r\n#include <envmap_pars_fragment>\r\n#include <fog_pars_fragment>\r\n#include <bsdfs>\r\n#include <cube_uv_reflection_fragment>\r\n#include <lights_pars>\r\n#include <lights_physical_pars_fragment>\r\n#include <shadowmap_pars_fragment>\r\n#include <triplanar_pars_fragment>\r\n#include <normalmap_triplanar_pars_fragment>\r\n#include <roughnessmap_pars_fragment>\r\n#include <metalnessmap_pars_fragment>\r\n#include <logdepthbuf_pars_fragment>\r\n#include <clipping_planes_pars_fragment>\r\n\r\nvoid main() {\r\n\r\n\t#include <clipping_planes_fragment>\r\n\r\n\tvec4 diffuseColor = vec4( diffuse, opacity );\r\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\r\n\tvec3 totalEmissiveRadiance = emissive;\r\n\r\n\t#include <logdepthbuf_fragment>\r\n\t#include <normal_triplanar_fragment>\r\n\t#include <map_triplanar_fragment>\r\n\t#include <color_fragment>\r\n\t#include <alphamap_triplanar_fragment>\r\n\t#include <alphatest_fragment>\r\n\t#include <specularmap_triplanar_fragment>\r\n\t#include <roughnessmap_triplanar_fragment>\r\n\t#include <metalnessmap_triplanar_fragment>\r\n\t#include <emissivemap_triplanar_fragment>\r\n\r\n\t// accumulation\r\n\t#include <lights_physical_fragment>\r\n\t#include <lights_template>\r\n\r\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveRadiance;\r\n\r\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\r\n\r\n\t#include <premultiplied_alpha_fragment>\r\n\t#include <tonemapping_fragment>\r\n\t#include <encodings_fragment>\r\n\t#include <fog_fragment>\r\n\r\n}\r\n",Y="#define PHYSICAL\r\n\r\nvarying vec3 vViewPosition;\r\n\r\n#ifndef FLAT_SHADED\r\n\r\n\tvarying vec3 vNormal;\r\n\r\n#endif\r\n\r\n#include <common>\r\n#include <uv_pars_vertex> // offsetRepeat\r\n#include <color_pars_vertex>\r\n#include <fog_pars_vertex>\r\n#include <morphtarget_pars_vertex>\r\n#include <skinning_pars_vertex>\r\n#include <shadowmap_pars_vertex>\r\n#include <logdepthbuf_pars_vertex>\r\n#include <clipping_planes_pars_vertex>\r\n#include <triplanar_pars_vertex>\r\n\r\nvoid main() {\r\n\r\n\t#include <color_vertex>\r\n\r\n\t#include <beginnormal_vertex>\r\n\t#include <morphnormal_vertex>\r\n\t#include <skinbase_vertex>\r\n\t#include <skinnormal_vertex>\r\n\t#include <defaultnormal_vertex>\r\n\r\n#ifndef FLAT_SHADED // Normal computed with derivatives when FLAT_SHADED\r\n\r\n\tvNormal = normalize( transformedNormal );\r\n\r\n#endif\r\n\r\n\t#include <begin_vertex>\r\n\t#include <morphtarget_vertex>\r\n\t#include <skinning_vertex>\r\n\t#include <project_vertex>\r\n\t#include <logdepthbuf_vertex>\r\n\t#include <clipping_planes_vertex>\r\n\r\n\tvViewPosition = - mvPosition.xyz;\r\n\r\n\t#include <worldpos_vertex>\r\n\t#include <shadowmap_vertex>\r\n\t#include <fog_vertex>\r\n\t#include <triplanar_vertex>\r\n\r\n}\r\n";Object.assign(t.ShaderChunk,{alphamap_triplanar_fragment:"#ifdef USE_ALPHAMAP\r\n\r\n\tdiffuseColor.a *= t3( alphaMap ).g;\r\n\r\n#endif\r\n",emissivemap_triplanar_fragment:"#ifdef USE_EMISSIVEMAP\r\n\r\n\tvec4 emissiveColor = t3( emissiveMap );\r\n\r\n\temissiveColor.rgb = emissiveMapTexelToLinear( emissiveColor ).rgb;\r\n\r\n\ttotalEmissiveRadiance *= emissiveColor.rgb;\r\n\r\n#endif\r\n",map_triplanar_pars_fragment:"#ifdef USE_MAP\r\n\r\n\tuniform sampler2D map;\r\n\r\n\t#ifdef USE_MAP_Y\r\n\r\n\t\tuniform sampler2D mapY;\r\n\r\n\t#endif\r\n\r\n\t#ifdef USE_MAP_Z\r\n\r\n\t\tuniform sampler2D mapZ;\r\n\r\n\t#endif\r\n\r\n#endif\r\n",map_triplanar_fragment:"#ifdef USE_MAP\r\n\r\n\t#ifdef USE_MAP_Z\r\n\r\n\t\tvec4 texelColor = t3( map, mapY, mapZ );\r\n\r\n\t#elif USE_MAP_Y\r\n\r\n\t\tvec4 texelColor = t3( map, mapY );\r\n\r\n\t#else\r\n\r\n\t\tvec4 texelColor = t3( map );\r\n\r\n\t#endif\r\n\r\n\ttexelColor = mapTexelToLinear( texelColor );\r\n\tdiffuseColor *= texelColor;\r\n\r\n#endif\r\n",metalnessmap_triplanar_fragment:"float metalnessFactor = metalness;\r\n\r\n#ifdef USE_METALNESSMAP\r\n\r\n\tvec4 texelMetalness = t3( metalnessMap );\r\n\tmetalnessFactor *= texelMetalness.r;\r\n\r\n#endif\r\n",normal_triplanar_fragment:"#ifdef FLAT_SHADED\r\n\r\n\t// Workaround for Adreno/Nexus5 not able able to do dFdx( vViewPosition ) ...\r\n\r\n\tvec3 fdx = vec3( dFdx( vViewPosition.x ), dFdx( vViewPosition.y ), dFdx( vViewPosition.z ) );\r\n\tvec3 fdy = vec3( dFdy( vViewPosition.x ), dFdy( vViewPosition.y ), dFdy( vViewPosition.z ) );\r\n\tvec3 normal = normalize( cross( fdx, fdy ) );\r\n\r\n#else\r\n\r\n\tvec3 normal = normalize( vNormal );\r\n\r\n\t#ifdef DOUBLE_SIDED\r\n\r\n\t\tnormal = normal * ( float( gl_FrontFacing ) * 2.0 - 1.0 );\r\n\r\n\t#endif\r\n\r\n#endif\r\n\r\n#ifdef USE_NORMALMAP\r\n\r\n\tnormal = perturbNormal2Arb( normal );\r\n\r\n#endif\r\n",normalmap_triplanar_pars_fragment:"#ifdef USE_NORMALMAP\r\n\r\n\tuniform sampler2D normalMap;\r\n\tuniform vec2 normalScale;\r\n\r\n\t#ifdef USE_NORMALMAP_Y\r\n\r\n\t\tuniform sampler2D normalMapY;\r\n\r\n\t#endif\r\n\r\n\t#ifdef USE_NORMALMAP_Z\r\n\r\n\t\tuniform sampler2D normalMapZ;\r\n\r\n\t#endif\r\n\r\n\t// Triplanar Tangent Space Normal Mapping\r\n\t// Jaume Sánchez (https://www.clicktorelease.com/code/bumpy-metaballs/)\r\n\t// Mel (http://irrlicht.sourceforge.net/forum/viewtopic.php?t=48043)\r\n\r\n\tvec3 perturbNormal2Arb( vec3 normal ) {\r\n\r\n\t\t// Not sure why this doesn't work. Needs more testing!\r\n\t\t/*vec3 tangentX = vec3( normal.x, - normal.z, normal.y );\r\n\t\tvec3 tangentY = vec3( normal.z, normal.y, - normal.x );\r\n\t\tvec3 tangentZ = vec3( - normal.y, normal.x, normal.z );\r\n\r\n\t\tvec3 tangent = (\r\n\t\t\ttangentX * vBlend.x +\r\n\t\t\ttangentY * vBlend.y +\r\n\t\t\ttangentZ * vBlend.z\r\n\t\t); \r\n\r\n\t\tmat3 tsb = mat3(\r\n\t\t\tnormalize( tangent ),\r\n\t\t\tnormalize( cross( normal, tangent ) ),\r\n\t\t\tnormalize( normal )\r\n\t\t);*/\r\n\r\n\t\tmat3 tbn = mat3(\r\n\t\t\tnormalize( vec3( normal.y + normal.z, 0.0, normal.x ) ),\r\n\t\t\tnormalize( vec3( 0.0, normal.x + normal.z, normal.y ) ),\r\n\t\t\tnormal\r\n\t\t);\r\n\r\n\t\t#ifdef USE_NORMALMAP_Z\r\n\r\n\t\t\tvec3 mapN = t3( normalMap, normalMapY, normalMapZ ).xyz;\r\n\r\n\t\t#elif USE_NORMALMAP_Y\r\n\r\n\t\t\tvec3 mapN = t3( normalMap, normalMapY ).xyz;\r\n\r\n\t\t#else\r\n\r\n\t\t\tvec3 mapN = t3( normalMap ).xyz;\r\n\r\n\t\t#endif\r\n\r\n\t\t// Expand and scale the vector.\r\n\t\tmapN = mapN * 2.0 - 1.0;\r\n\t\tmapN.xy *= normalScale;\r\n\r\n\t\treturn normalize( tbn * mapN );\r\n\r\n\t}\r\n\r\n#endif\r\n",roughnessmap_triplanar_fragment:"float roughnessFactor = roughness;\r\n\r\n#ifdef USE_ROUGHNESSMAP\r\n\r\n\tvec4 texelRoughness = t3( roughnessMap );\r\n\troughnessFactor *= texelRoughness.r;\r\n\r\n#endif\r\n",specularmap_triplanar_fragment:"float specularStrength;\r\n\r\n#ifdef USE_SPECULARMAP\r\n\r\n\tvec4 texelSpecular = t3( specularMap );\r\n\tspecularStrength = texelSpecular.r;\r\n\r\n#else\r\n\r\n\tspecularStrength = 1.0;\r\n\r\n#endif",triplanar_pars_fragment:"#if defined( USE_MAP ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( USE_SPECULARMAP ) || defined( USE_ALPHAMAP ) || defined( USE_EMISSIVEMAP ) || defined( USE_ROUGHNESSMAP ) || defined( USE_METALNESSMAP )\r\n\r\n\tvarying vec3 vBlend;\r\n\tvarying vec2 vCoords[3];\r\n\r\n\tvec4 t3( sampler2D mapX, sampler2D mapY, sampler2D mapZ ) {\r\n\r\n\t\tvec4 xAxis = texture2D( mapX, vCoords[0] );\r\n\t\tvec4 yAxis = texture2D( mapY, vCoords[1] );\r\n\t\tvec4 zAxis = texture2D( mapZ, vCoords[2] );\r\n\r\n\t\treturn (\r\n\t\t\txAxis * vBlend.x +\r\n\t\t\tyAxis * vBlend.y +\r\n\t\t\tzAxis * vBlend.z\r\n\t\t);\r\n\r\n\t}\r\n\r\n\tvec4 t3( sampler2D mapX, sampler2D mapYZ ) {\r\n\r\n\t\treturn t3( mapX, mapYZ, mapYZ );\r\n\r\n\t}\r\n\r\n\tvec4 t3( sampler2D mapXYZ ) {\r\n\r\n\t\treturn t3( mapXYZ, mapXYZ, mapXYZ );\r\n\r\n\t}\r\n\r\n#endif\r\n",triplanar_pars_vertex:"#if defined( USE_MAP ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( USE_SPECULARMAP ) || defined( USE_ALPHAMAP ) || defined( USE_EMISSIVEMAP ) || defined( USE_ROUGHNESSMAP ) || defined( USE_METALNESSMAP )\r\n\r\n\tvarying vec3 vBlend;\r\n\tvarying vec2 vCoords[3];\r\n\r\n\tvec3 computeTriplanarBlend( vec3 normal ) {\r\n\r\n\t\t// Voxel-Based Terrain for Real-Time Virtual Simulations (Ch. 5).\r\n\t\tvec3 blend = saturate( abs( normal ) - 0.5 );\r\n\r\n\t\t// Raise each component of the normal vector to the 4th power.\r\n\t\tblend *= blend;\r\n\t\tblend *= blend;\r\n\r\n\t\t// Normalize the result by dividing by the sum of its components.\r\n\t\tblend /= dot( blend, vec3( 1.0 ) );\r\n\r\n\t\t// GPU Gems 3 (Ch. 1).\r\n\t\t//vec3 blend = abs( normal );\r\n\t\t//blend = ( blend - 0.2 ) * 7.0;  \r\n\t\t//blend = max( blend, 0.0 );\r\n\t\t//blend /= ( blend.x + blend.y + blend.z );\r\n\r\n\t\treturn blend;\r\n\r\n\t}\r\n\r\n#endif\r\n",triplanar_vertex:"#if defined( USE_MAP ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( USE_SPECULARMAP ) || defined( USE_ALPHAMAP ) || defined( USE_EMISSIVEMAP ) || defined( USE_ROUGHNESSMAP ) || defined( USE_METALNESSMAP )\r\n\r\n\tvCoords[0] = worldPosition.yz * offsetRepeat.zw + offsetRepeat.xy;\r\n\tvCoords[1] = worldPosition.zx * offsetRepeat.zw + offsetRepeat.xy;\r\n\tvCoords[2] = worldPosition.xy * offsetRepeat.zw + offsetRepeat.xy;\r\n\r\n\tvBlend = computeTriplanarBlend( normal );\r\n\r\n#endif\r\n"});var X=function(e){function n(){P(this,n);var e=U(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,{type:"MeshTriplanarPhysicalMaterial",defines:{PHYSICAL:""},uniforms:{mapY:new t.Uniform(null),mapZ:new t.Uniform(null),normalMapY:new t.Uniform(null),normalMapZ:new t.Uniform(null)},fragmentShader:j,vertexShader:Y,lights:!0,fog:!0})),i=t.ShaderLib.physical.uniforms,r=e.uniforms;return Object.keys(i).forEach(function(e){var n=i[e].value,s=new t.Uniform(n);Object.defineProperty(r,e,{value:null===n?s:s.clone()})}),e.envMap=null,e}return C(n,e),I(n,[{key:"setMaps",value:function(t,e,n){var i=this.defines,r=this.uniforms;void 0!==t&&(i.USE_MAP="",r.map.value=t),void 0!==e&&(i.USE_MAP_Y="",r.mapY.value=e),void 0!==n&&(i.USE_MAP_Z="",r.mapZ.value=n),this.needsUpdate=!0}},{key:"setNormalMaps",value:function(t,e,n){var i=this.defines,r=this.uniforms;void 0!==t&&(i.USE_NORMALMAP="",r.normalMap.value=t),void 0!==e&&(i.USE_NORMALMAP_Y="",r.normalMapY.value=e),void 0!==n&&(i.USE_NORMALMAP_Z="",r.normalMapZ.value=n),this.needsUpdate=!0}}]),n}(t.ShaderMaterial),Z={SPHERE:"sdf.sphere",BOX:"sdf.box",TORUS:"sdf.torus",PLANE:"sdf.plane",HEIGHTFIELD:"sdf.heightfield"},G=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;P(this,t),this.x=e,this.y=n}return I(t,[{key:"set",value:function(t,e){return this.x=t,this.y=e,this}},{key:"copy",value:function(t){return this.x=t.x,this.y=t.y,this}},{key:"fromArray",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return this.x=t[e],this.y=t[e+1],this}},{key:"toArray",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return t[e]=this.x,t[e+1]=this.y,t}},{key:"equals",value:function(t){return t.x===this.x&&t.y===this.y}},{key:"clone",value:function(){return new this.constructor(this.x,this.y)}},{key:"add",value:function(t){return this.x+=t.x,this.y+=t.y,this}},{key:"addScaledVector",value:function(t,e){return this.x+=t.x*e,this.y+=t.y*e,this}},{key:"addScalar",value:function(t){return this.x+=t,this.y+=t,this}},{key:"addVectors",value:function(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this}},{key:"sub",value:function(t){return this.x-=t.x,this.y-=t.y,this}},{key:"subScalar",value:function(t){return this.x-=t,this.y-=t,this}},{key:"subVectors",value:function(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this}},{key:"multiply",value:function(t){return this.x*=t.x,this.y*=t.y,this}},{key:"multiplyScalar",value:function(t){return isFinite(t)?(this.x*=t,this.y*=t):(this.x=0,this.y=0),this}},{key:"multiplyVectors",value:function(t,e){return this.x=t.x*e.x,this.y=t.y*e.y,this}},{key:"divide",value:function(t){return this.x/=t.x,this.y/=t.y,this}},{key:"divideScalar",value:function(t){return this.multiplyScalar(1/t)}},{key:"divideVectors",value:function(t,e){return this.x=t.x/e.x,this.y=t.y/e.y,this}},{key:"negate",value:function(){return this.x=-this.x,this.y=-this.y,this}},{key:"dot",value:function(t){return this.x*t.x+this.y*t.y}},{key:"lengthSq",value:function(){return this.x*this.x+this.y*this.y}},{key:"length",value:function(){return Math.sqrt(this.x*this.x+this.y*this.y)}},{key:"distanceTo",value:function(t){return Math.sqrt(this.distanceToSquared(t))}},{key:"distanceToSquared",value:function(t){var e=this.x-t.x,n=this.y-t.y;return e*e+n*n}},{key:"normalize",value:function(){return this.divideScalar(this.length())}},{key:"min",value:function(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this}},{key:"max",value:function(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this}},{key:"clamp",value:function(t,e){return this.x=Math.max(t.x,Math.min(e.x,this.x)),this.y=Math.max(t.y,Math.min(e.y,this.y)),this}}]),t}(),H=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;P(this,t),this.x=e,this.y=n,this.z=i}return I(t,[{key:"set",value:function(t,e,n){return this.x=t,this.y=e,this.z=n,this}},{key:"copy",value:function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this}},{key:"fromArray",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return this.x=t[e],this.y=t[e+1],this.z=t[e+2],this}},{key:"toArray",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return t[e]=this.x,t[e+1]=this.y,t[e+2]=this.z,t}},{key:"equals",value:function(t){return t.x===this.x&&t.y===this.y&&t.z===this.z}},{key:"clone",value:function(){return new this.constructor(this.x,this.y,this.z)}},{key:"add",value:function(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this}},{key:"addScaledVector",value:function(t,e){return this.x+=t.x*e,this.y+=t.y*e,this.z+=t.z*e,this}},{key:"addScalar",value:function(t){return this.x+=t,this.y+=t,this.z+=t,this}},{key:"addVectors",value:function(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this}},{key:"sub",value:function(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this}},{key:"subScalar",value:function(t){return this.x-=t,this.y-=t,this.z-=t,this}},{key:"subVectors",value:function(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this}},{key:"multiply",value:function(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this}},{key:"multiplyScalar",value:function(t){return isFinite(t)?(this.x*=t,this.y*=t,this.z*=t):(this.x=0,this.y=0,this.z=0),this}},{key:"multiplyVectors",value:function(t,e){return this.x=t.x*e.x,this.y=t.y*e.y,this.z=t.z*e.z,this}},{key:"divide",value:function(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this}},{key:"divideScalar",value:function(t){return this.multiplyScalar(1/t)}},{key:"divideVectors",value:function(t,e){return this.x=t.x/e.x,this.y=t.y/e.y,this.z=t.z/e.z,this}},{key:"negate",value:function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}},{key:"dot",value:function(t){return this.x*t.x+this.y*t.y+this.z*t.z}},{key:"lengthSq",value:function(){return this.x*this.x+this.y*this.y+this.z*this.z}},{key:"length",value:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}},{key:"distanceTo",value:function(t){return Math.sqrt(this.distanceToSquared(t))}},{key:"distanceToSquared",value:function(t){var e=this.x-t.x,n=this.y-t.y,i=this.z-t.z;return e*e+n*n+i*i}},{key:"normalize",value:function(){return this.divideScalar(this.length())}},{key:"min",value:function(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this.z=Math.min(this.z,t.z),this}},{key:"max",value:function(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this.z=Math.max(this.z,t.z),this}},{key:"clamp",value:function(t,e){return this.x=Math.max(t.x,Math.min(e.x,this.x)),this.y=Math.max(t.y,Math.min(e.y,this.y)),this.z=Math.max(t.z,Math.min(e.z,this.z)),this}},{key:"applyMatrix3",value:function(t){var e=this.x,n=this.y,i=this.z,r=t.elements;return this.x=r[0]*e+r[3]*n+r[6]*i,this.y=r[1]*e+r[4]*n+r[7]*i,this.z=r[2]*e+r[5]*n+r[8]*i,this}},{key:"applyMatrix4",value:function(t){var e=this.x,n=this.y,i=this.z,r=t.elements;return this.x=r[0]*e+r[4]*n+r[8]*i+r[12],this.y=r[1]*e+r[5]*n+r[9]*i+r[13],this.z=r[2]*e+r[6]*n+r[10]*i+r[14],this}}]),t}(),W=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new H(1/0,1/0,1/0),n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new H(-1/0,-1/0,-1/0);P(this,t),this.min=e,this.max=n}return I(t,[{key:"set",value:function(t,e){return this.min.copy(t),this.max.copy(e),this}},{key:"copy",value:function(t){return this.min.copy(t.min),this.max.copy(t.max),this}},{key:"clone",value:function(){return(new this.constructor).copy(this)}},{key:"expandByPoint",value:function(t){return this.min.min(t),this.max.max(t),this}},{key:"union",value:function(t){return this.min.min(t.min),this.max.max(t.max),this}},{key:"setFromPoints",value:function(t){var e=void 0,n=void 0;for(e=0,n=t.length;e<n;++e)this.expandByPoint(t[e]);return this}},{key:"setFromCenterAndSize",value:function(t,e){var n=e.clone().multiplyScalar(.5);return this.min.copy(t).sub(n),this.max.copy(t).add(n),this}},{key:"intersectsBox",value:function(t){return!(t.max.x<this.min.x||t.min.x>this.max.x||t.max.y<this.min.y||t.min.y>this.max.y||t.max.z<this.min.z||t.min.z>this.max.z)}}]),t}(),Q=function(){function t(){P(this,t),this.elements=new Float32Array([1,0,0,0,1,0,0,0,1])}return I(t,[{key:"set",value:function(t,e,n,i,r,s,a,o,l){var u=this.elements;return u[0]=t,u[3]=e,u[6]=n,u[1]=i,u[4]=r,u[7]=s,u[2]=a,u[5]=o,u[8]=l,this}},{key:"identity",value:function(){return this.set(1,0,0,0,1,0,0,0,1),this}},{key:"copy",value:function(t){var e=t.elements;return this.set(e[0],e[3],e[6],e[1],e[4],e[7],e[2],e[5],e[8])}},{key:"clone",value:function(){return(new this.constructor).copy(this)}}]),t}(),K=function(){function t(){P(this,t),this.elements=new Float32Array([1,0,0,1,0,1])}return I(t,[{key:"set",value:function(t,e,n,i,r,s){var a=this.elements;return a[0]=t,a[1]=e,a[3]=i,a[2]=n,a[4]=r,a[5]=s,this}},{key:"identity",value:function(){return this.set(1,0,0,1,0,1),this}},{key:"copy",value:function(t){var e=t.elements;return this.set(e[0],e[1],e[2],e[3],e[4],e[5]),this}},{key:"clone",value:function(){return(new this.constructor).copy(this)}},{key:"toMatrix3",value:function(t){var e=t.elements;t.set(e[0],e[1],e[2],e[1],e[3],e[4],e[2],e[4],e[5])}},{key:"add",value:function(t){var e=this.elements,n=t.elements;return e[0]+=n[0],e[1]+=n[1],e[3]+=n[3],e[2]+=n[2],e[4]+=n[4],e[5]+=n[5],this}},{key:"norm",value:function(){var t=this.elements,e=t[1]*t[1],n=t[2]*t[2],i=t[4]*t[4];return Math.sqrt(t[0]*t[0]+e+n+e+t[3]*t[3]+i+n+i+t[5]*t[5])}},{key:"off",value:function(){var t=this.elements;return Math.sqrt(2*(t[1]*t[1]+t[2]*t[2]+t[4]*t[4]))}},{key:"applyToVector3",value:function(t){var e=t.x,n=t.y,i=t.z,r=this.elements;return t.x=r[0]*e+r[1]*n+r[2]*i,t.y=r[1]*e+r[3]*n+r[4]*i,t.z=r[2]*e+r[4]*n+r[5]*i,t}}],[{key:"calculateIndex",value:function(t,e){return 3-(3-t)*(2-t)/2+e}}]),t}(),J={AIR:0,SOLID:1},$=function(){function t(e){P(this,t),this.type=e;for(var n=arguments.length,i=Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];this.children=i,this.bbox=null}return I(t,[{key:"computeBoundingBox",value:function(){var t=this.children,e=void 0,n=void 0;for(this.bbox=new W,e=0,n=t.length;e<n;++e)this.bbox.union(t[e].boundingBox);return this.bbox}},{key:"boundingBox",get:function(){return null!==this.bbox?this.bbox:this.computeBoundingBox()}}]),t}(),tt=function(t){function e(){var t;P(this,e);for(var n=arguments.length,i=Array(n),r=0;r<n;r++)i[r]=arguments[r];return U(this,(t=e.__proto__||Object.getPrototypeOf(e)).call.apply(t,[this,L.UNION].concat(i)))}return C(e,$),I(e,[{key:"updateMaterialIndex",value:function(t,e,n){var i=n.materialIndices[t];i!==J.AIR&&e.setMaterialIndex(t,i)}},{key:"selectEdge",value:function(t,e,n){return n?t.t>e.t?t:e:t.t<e.t?t:e}}]),e}(),et=function(t){function e(){var t;P(this,e);for(var n=arguments.length,i=Array(n),r=0;r<n;r++)i[r]=arguments[r];return U(this,(t=e.__proto__||Object.getPrototypeOf(e)).call.apply(t,[this,L.DIFFERENCE].concat(i)))}return C(e,$),I(e,[{key:"updateMaterialIndex",value:function(t,e,n){n.materialIndices[t]!==J.AIR&&e.setMaterialIndex(t,J.AIR)}},{key:"selectEdge",value:function(t,e,n){return n?t.t<e.t?t:e:t.t>e.t?t:e}}]),e}(),nt=function(t){function e(){var t;P(this,e);for(var n=arguments.length,i=Array(n),r=0;r<n;r++)i[r]=arguments[r];return U(this,(t=e.__proto__||Object.getPrototypeOf(e)).call.apply(t,[this,L.INTERSECTION].concat(i)))}return C(e,$),I(e,[{key:"updateMaterialIndex",value:function(t,e,n){var i=n.materialIndices[t];e.setMaterialIndex(t,e.materialIndices[t]!==J.AIR&&i!==J.AIR?i:J.AIR)}},{key:"selectEdge",value:function(t,e,n){return n?t.t<e.t?t:e:t.t>e.t?t:e}}]),e}(),it=function(t){function e(t){P(this,e);var n=U(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,L.DENSITY_FUNCTION));return n.sdf=t,n}return C(e,$),I(e,[{key:"computeBoundingBox",value:function(){return this.bbox=this.sdf.computeBoundingBox(),this.bbox}},{key:"generateMaterialIndex",value:function(t){return this.sdf.sample(t)<=0?this.sdf.material:J.AIR}},{key:"generateEdge",value:function(t){t.approximateZeroCrossing(this.sdf),t.computeSurfaceNormal(this.sdf)}}]),e}(),rt=function(){function t(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:J.SOLID;P(this,t),this.type=e,this.operation=null,this.material=Math.min(255,Math.max(J.SOLID,Math.trunc(n))),this.children=[],this.bbox=null}return I(t,[{key:"union",value:function(t){return t.operation=L.UNION,this.children.push(t),this}},{key:"subtract",value:function(t){return t.operation=L.DIFFERENCE,this.children.push(t),this}},{key:"intersect",value:function(t){return t.operation=L.INTERSECTION,this.children.push(t),this}},{key:"serialize",value:function(){var t={type:this.type,operation:this.operation,material:this.material,parameters:null,children:[]},e=this.children,n=void 0,i=void 0;for(n=0,i=e.length;n<i;++n)t.children.push(e[n].serialize());return t}},{key:"toCSG",value:function(){var t=this.children,e=new it(this),n=void 0,i=void 0,r=void 0,s=void 0;for(r=0,s=t.length;r<s;++r){if(i=t[r],n!==i.operation)switch(n=i.operation){case L.UNION:e=new tt(e);break;case L.DIFFERENCE:e=new et(e);break;case L.INTERSECTION:e=new nt(e)}e.children.push(i.toCSG())}return e}},{key:"computeBoundingBox",value:function(){throw new Error("SignedDistanceFunction#computeBoundingBox method not implemented!")}},{key:"sample",value:function(t){throw new Error("SignedDistanceFunction#sample method not implemented!")}},{key:"boundingBox",get:function(){return null!==this.bbox?this.bbox:this.computeBoundingBox()}},{key:"completeBoundingBox",get:function(){var t=this.children,e=this.boundingBox.clone(),n=void 0,i=void 0;for(n=0,i=t.length;n<i;++n)e.union(t[n].completeBoundingBox);return e}}]),t}(),st=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments[1];P(this,e);var i=U(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,Z.SPHERE,n));return i.origin=new(Function.prototype.bind.apply(H,[null].concat(R(t.origin)))),i.radius=t.radius,i}return C(e,rt),I(e,[{key:"computeBoundingBox",value:function(){return this.bbox=new W,this.bbox.min.copy(this.origin).subScalar(this.radius),this.bbox.max.copy(this.origin).addScalar(this.radius),this.bbox}},{key:"sample",value:function(t){var e=this.origin,n=t.x-e.x,i=t.y-e.y,r=t.z-e.z;return Math.sqrt(n*n+i*i+r*r)-this.radius}},{key:"serialize",value:function(){var t=O(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"serialise",this).call(this);return t.parameters={origin:this.origin.toArray(),radius:this.radius},t}}]),e}(),at=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments[1];P(this,e);var i=U(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,Z.BOX,n));return i.origin=new(Function.prototype.bind.apply(H,[null].concat(R(t.origin)))),i.halfDimensions=new(Function.prototype.bind.apply(H,[null].concat(R(t.halfDimensions)))),i}return C(e,rt),I(e,[{key:"computeBoundingBox",value:function(){return this.bbox=new W,this.bbox.min.subVectors(this.origin,this.halfDimensions),this.bbox.max.addVectors(this.origin,this.halfDimensions),this.bbox}},{key:"sample",value:function(t){var e=this.origin,n=this.halfDimensions,i=Math.abs(t.x-e.x)-n.x,r=Math.abs(t.y-e.y)-n.y,s=Math.abs(t.z-e.z)-n.z,a=Math.max(i,Math.max(r,s)),o=Math.max(i,0),l=Math.max(r,0),u=Math.max(s,0),h=Math.sqrt(o*o+l*l+u*u);return Math.min(a,0)+h}},{key:"serialize",value:function(){var t=O(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"serialise",this).call(this);return t.parameters={origin:this.origin.toArray(),halfDimensions:this.halfDimensions.toArray()},t}}]),e}(),ot=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments[1];P(this,e);var i=U(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,Z.PLANE,n));return i.normal=new(Function.prototype.bind.apply(H,[null].concat(R(t.normal)))),i.constant=t.constant,i}return C(e,rt),I(e,[{key:"computeBoundingBox",value:function(){return this.bbox=new W,this.bbox}},{key:"sample",value:function(t){return this.normal.dot(t)+this.constant}},{key:"serialize",value:function(){var t=O(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"serialise",this).call(this);return t.parameters={normal:this.normal.toArray(),constant:this.constant},t}}]),e}(),lt=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments[1];P(this,e);var i=U(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,Z.TORUS,n));return i.origin=new(Function.prototype.bind.apply(H,[null].concat(R(t.origin)))),i.R=t.R,i.r=t.r,i}return C(e,rt),I(e,[{key:"computeBoundingBox",value:function(){return this.bbox=new W,this.bbox.min.copy(this.origin).subScalar(this.R).subScalar(this.r),this.bbox.max.copy(this.origin).addScalar(this.R).addScalar(this.r),this.bbox}},{key:"sample",value:function(t){var e=this.origin,n=t.x-e.x,i=t.y-e.y,r=t.z-e.z,s=Math.sqrt(n*n+r*r)-this.R;return Math.sqrt(s*s+i*i)-this.r}},{key:"serialize",value:function(){var t=O(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"serialise",this).call(this);return t.parameters={origin:this.origin.toArray(),R:this.R,r:this.r},t}}]),e}(),ut=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments[1];P(this,e);var i=U(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,Z.HEIGHTFIELD,n));return i.min=new(Function.prototype.bind.apply(H,[null].concat(R(t.min)))),i.dimensions=new(Function.prototype.bind.apply(H,[null].concat(R(t.size)))),i.data=t.data,i}return C(e,rt),I(e,[{key:"computeBoundingBox",value:function(){return this.bbox=new W,this.bbox.min.copy(this.min),this.bbox.max.addVectors(this.min,this.dimensions),this.bbox}},{key:"sample",value:function(t){var e=this.min,n=this.dimensions,i=Math.max(e.x,Math.min(e.x+n.x,t.x-e.x)),r=Math.max(e.z,Math.min(e.z+n.z,t.z-e.z));return t.y-e.y-this.data[r*n.x+i]/255*n.y}},{key:"serialize",value:function(){var t=O(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"serialise",this).call(this);return t.parameters={min:this.min.toArray(),dimensions:this.dimensions.toArray(),data:this.data},t}}]),e}(),ht=function(){function t(){P(this,t)}return I(t,null,[{key:"reviveSDF",value:function(t){var e=void 0,n=void 0,i=void 0;switch(t.type){case Z.SPHERE:e=new st(t.parameters,t.material);break;case Z.BOX:e=new at(t.parameters,t.material);break;case Z.TORUS:e=new lt(t.parameters,t.material);break;case Z.PLANE:e=new ot(t.parameters,t.material);break;case Z.HEIGHTFIELD:e=new ut(t.parameters,t.material)}for(e.operation=t.operation,n=0,i=t.children.length;n<i;++n)e.children.push(this.reviveSDF(t.children[n]));return e}}]),t}(),ct={EXTRACT:"worker.extract",MODIFY:"worker.modify",RESAMPLE:"worker.resample",CONFIGURE:"worker.config",CLOSE:"worker.close"},dt=function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;P(this,t),this.action=e,this.data=null,this.cellSize=0,this.cellPosition=null},vt=(function(t){function e(){return P(this,e),U(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,ct.EXTRACT))}C(e,dt)}(),function(t){function e(){P(this,e);var t=U(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,ct.MODIFY));return t.sdf=null,t}C(e,dt)}(),new(function(t){function e(t){P(this,e);var n=U(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));return n.worker=null,n.response=null,n}return C(e,q),e}())("message")),yt='!function(){"use strict";function t(t,e,n,i,r,s){var o=0;return t>e&&t>n?(r<t&&(o|=2),s<t&&(o|=1)):e>n?(i<e&&(o|=4),s<e&&(o|=1)):(i<n&&(o|=4),r<n&&(o|=2)),o}function e(t,e,n,i){var r=void 0,s=0;return e<n?(r=e,s=0):(r=n,s=1),i<r&&(s=2),et[t][s]}function n(i,r,s,o,a,u,l,h,c){var d=i.children,y=void 0,v=void 0,f=void 0,m=void 0;if(a>=0&&u>=0&&l>=0)if(null===d)c.push(i);else{y=t(r,s,o,v=.5*(r+a),f=.5*(s+u),m=.5*(o+l));do{switch(y){case 0:n(d[tt[8]],r,s,o,v,f,m,h,c),y=e(y,v,f,m);break;case 1:n(d[tt[8]^tt[1]],r,s,m,v,f,l,h,c),y=e(y,v,f,l);break;case 2:n(d[tt[8]^tt[2]],r,f,o,v,u,m,h,c),y=e(y,v,u,m);break;case 3:n(d[tt[8]^tt[3]],r,f,m,v,u,l,h,c),y=e(y,v,u,l);break;case 4:n(d[tt[8]^tt[4]],v,s,o,a,f,m,h,c),y=e(y,a,f,m);break;case 5:n(d[tt[8]^tt[5]],v,s,m,a,f,l,h,c),y=e(y,a,f,l);break;case 6:n(d[tt[8]^tt[6]],v,f,o,a,u,m,h,c),y=e(y,a,u,m);break;case 7:n(d[tt[8]^tt[7]],v,f,m,a,u,l,h,c),y=8}}while(y<8)}}function i(t){var e=t.children,n=0,r=void 0,s=void 0,o=void 0;if(null!==e)for(r=0,s=e.length;r<s;++r)(o=1+i(e[r]))>n&&(n=o);return n}function r(t,e,n){var i=t.children,s=void 0,o=void 0;if(ht.min=t.min,ht.max=t.max,e.intersectsBox(ht))if(null!==i)for(s=0,o=i.length;s<o;++s)r(i[s],e,n);else n.push(t)}function s(t,e,n,i){var r=t.children,o=void 0,a=void 0;if(n===e)i.push(t);else if(null!==r)for(++n,o=0,a=r.length;o<a;++o)s(r[o],e,n,i)}function o(t){var e=t.children,n=0,i=void 0,r=void 0;if(null!==e)for(i=0,r=e.length;i<r;++i)n+=o(e[i]);else null!==t.points&&(n=t.points.length);return n}function a(t,e,n,i,r){var s=i.children,o=!1,u=!1,l=void 0,h=void 0;if(i.contains(t,n.bias)){if(null===s){if(null===i.points)i.points=[],i.data=[];else for(l=0,h=i.points.length;!o&&l<h;++l)o=i.points[l].equals(t);o?(i.data[l-1]=e,u=!0):i.points.length<n.maxPoints||r===n.maxDepth?(i.points.push(t.clone()),i.data.push(e),++n.pointCount,u=!0):(i.split(),i.redistribute(n.bias),s=i.children)}if(null!==s)for(++r,l=0,h=s.length;!u&&l<h;++l)u=a(t,e,n,s[l],r)}return u}function u(t,e,n,i){var r=n.children,s=null,a=void 0,l=void 0,h=void 0,c=void 0,d=void 0;if(n.contains(t,e.bias))if(null!==r)for(a=0,l=r.length;null===s&&a<l;++a)s=u(t,e,r[a],n);else if(null!==n.points)for(h=n.points,c=n.data,a=0,l=h.length;a<l;++a)if(h[a].equals(t)){d=l-1,s=c[a],a<d&&(h[a]=h[d],c[a]=c[d]),h.pop(),c.pop(),--e.pointCount,null!==i&&o(i)<=e.maxPoints&&i.merge();break}return s}function l(t,e,n){var i=n.children,r=null,s=void 0,o=void 0,a=void 0;if(n.contains(t,e.bias))if(null!==i)for(s=0,o=i.length;null===r&&s<o;++s)r=l(t,e,i[s]);else for(s=0,o=(a=n.points).length;null===r&&s<o;++s)t.distanceToSquared(a[s])<=ft&&(r=n.data[s]);return r}function h(t,e,n,i,r,s){var o=i.children,l=null,c=void 0,d=void 0,y=void 0;if(i.contains(t,n.bias))if(i.contains(e,n.bias)){if(null!==o)for(++s,c=0,d=o.length;null===l&&c<d;++c)l=h(t,e,n,o[c],i,s);else for(c=0,d=(y=i.points).length;c<d;++c)if(t.distanceToSquared(y[c])<=ft){y[c].copy(e),l=i.data[c];break}}else a(e,l=u(t,n,i,r),n,r,s-1);return l}function c(t,e,n,i){var r=i.points,s=i.children,o=null,a=e,u=void 0,l=void 0,h=void 0,d=void 0,y=void 0,v=void 0,f=void 0;if(null!==s)for(u=0,l=(y=s.map(function(e){return{octant:e,distance:e.distanceToCenterSquared(t)}}).sort(function(t,e){return t.distance-e.distance})).length;u<l;++u)(v=y[u].octant).contains(t,a)&&null!==(f=c(t,a,n,v))&&(d=f.point.distanceToSquared(t),(!n||d>0)&&d<a&&(a=d,o=f));else if(null!==r)for(u=0,l=r.length;u<l;++u)h=r[u],d=t.distanceToSquared(h),(!n||d>0)&&d<a&&(a=d,o={point:h.clone(),data:i.data[u]});return o}function d(t,e,n,i,r){var s=i.points,o=i.children,a=e*e,u=void 0,l=void 0,h=void 0,c=void 0,y=void 0;if(null!==o)for(u=0,l=o.length;u<l;++u)(y=o[u]).contains(t,e)&&d(t,e,n,y,r);else if(null!==s)for(u=0,l=s.length;u<l;++u)h=s[u],c=t.distanceToSquared(h),(!n||c>0)&&c<=a&&r.push({point:h.clone(),data:i.data[u]})}function y(t,e){var n=t.elements,i=e.elements,r=void 0;0!==n[1]&&(r=Ct.calculateCoefficients(n[0],n[1],n[3]),Dt.rotateQXY(Rt.set(n[0],n[3]),n[1],r),n[0]=Rt.x,n[3]=Rt.y,Dt.rotateXY(Rt.set(n[2],n[4]),r),n[2]=Rt.x,n[4]=Rt.y,n[1]=0,Dt.rotateXY(Rt.set(i[0],i[3]),r),i[0]=Rt.x,i[3]=Rt.y,Dt.rotateXY(Rt.set(i[1],i[4]),r),i[1]=Rt.x,i[4]=Rt.y,Dt.rotateXY(Rt.set(i[2],i[5]),r),i[2]=Rt.x,i[5]=Rt.y)}function v(t,e){var n=t.elements,i=e.elements,r=void 0;0!==n[2]&&(r=Ct.calculateCoefficients(n[0],n[2],n[5]),Dt.rotateQXY(Rt.set(n[0],n[5]),n[2],r),n[0]=Rt.x,n[5]=Rt.y,Dt.rotateXY(Rt.set(n[1],n[4]),r),n[1]=Rt.x,n[4]=Rt.y,n[2]=0,Dt.rotateXY(Rt.set(i[0],i[6]),r),i[0]=Rt.x,i[6]=Rt.y,Dt.rotateXY(Rt.set(i[1],i[7]),r),i[1]=Rt.x,i[7]=Rt.y,Dt.rotateXY(Rt.set(i[2],i[8]),r),i[2]=Rt.x,i[8]=Rt.y)}function f(t,e){var n=t.elements,i=e.elements,r=void 0;0!==n[4]&&(r=Ct.calculateCoefficients(n[3],n[4],n[5]),Dt.rotateQXY(Rt.set(n[3],n[5]),n[4],r),n[3]=Rt.x,n[5]=Rt.y,Dt.rotateXY(Rt.set(n[1],n[2]),r),n[1]=Rt.x,n[2]=Rt.y,n[4]=0,Dt.rotateXY(Rt.set(i[3],i[6]),r),i[3]=Rt.x,i[6]=Rt.y,Dt.rotateXY(Rt.set(i[4],i[7]),r),i[4]=Rt.x,i[7]=Rt.y,Dt.rotateXY(Rt.set(i[5],i[8]),r),i[5]=Rt.x,i[8]=Rt.y)}function m(t,e){var n=t.elements,i=void 0;for(i=0;i<Pt;++i)y(t,e),v(t,e),f(t,e);return Ft.set(n[0],n[3],n[5])}function p(t){var e=1/t;return Math.abs(t)<Et||Math.abs(e)<Et?0:e}function x(t,e){var n=t.elements,i=n[0],r=n[3],s=n[6],o=n[1],a=n[4],u=n[7],l=n[2],h=n[5],c=n[8],d=p(e.x),y=p(e.y),v=p(e.z);return t.set(i*d*i+r*y*r+s*v*s,i*d*o+r*y*a+s*v*u,i*d*l+r*y*h+s*v*c,o*d*i+a*y*r+u*v*s,o*d*o+a*y*a+u*v*u,o*d*l+a*y*h+u*v*c,l*d*i+h*y*r+c*v*s,l*d*o+h*y*a+c*v*u,l*d*l+h*y*h+c*v*c)}function g(t,e,n,i,r){var s=t+1,o=s*s,a=new Vt,u=void 0,l=void 0,h=void 0,c=void 0,d=void 0;for(u=0,d=0;d<8;++d)c=(i+(h=Z[d])[2])*o+(n+h[1])*s+(e+h[0]),u|=Math.min(r[c],L.SOLID)<<d;for(l=0,d=0;d<12;++d)(u>>Q[d][0]&1)!==(u>>Q[d][1]&1)&&++l;return a.materials=u,a.edgeCount=l,a.qefData=new Ot,a}function w(t,e,n){var i=[-1,-1,-1,-1],r=[!1,!1,!1,!1],s=1/0,o=0,a=!1,u=void 0,l=void 0,h=void 0,c=void 0,d=void 0,y=void 0,v=void 0;for(v=0;v<4;++v)d=t[v],y=$t[e][v],u=Q[y][0],l=Q[y][1],h=d.voxel.materials>>u&1,c=d.voxel.materials>>l&1,d.size<s&&(s=d.size,o=v,a=h!==L.AIR),i[v]=d.voxel.index,r[v]=h!==c;r[o]&&(a?(n.push(i[0]),n.push(i[3]),n.push(i[1]),n.push(i[0]),n.push(i[2]),n.push(i[3])):(n.push(i[0]),n.push(i[1]),n.push(i[3]),n.push(i[0]),n.push(i[3]),n.push(i[2])))}function k(t,e,n){var i=[0,0,0,0],r=void 0,s=void 0,o=void 0,a=void 0;if(null!==t[0].voxel&&null!==t[1].voxel&&null!==t[2].voxel&&null!==t[3].voxel)w(t,e,n);else for(o=0;o<2;++o){for(i[0]=Wt[e][o][0],i[1]=Wt[e][o][1],i[2]=Wt[e][o][2],i[3]=Wt[e][o][3],r=[],a=0;a<4;++a)if(null!==(s=t[a]).voxel)r[a]=s;else{if(null===s.children)break;r[a]=s.children[i[a]]}4===a&&k(r,Wt[e][o][4],n)}}function b(t,e,n){var i=[0,0,0,0],r=[[0,0,1,1],[0,1,0,1]],s=void 0,o=void 0,a=void 0,u=void 0,l=void 0;if(null!==t[0].children||null!==t[1].children){for(u=0;u<4;++u)i[0]=Jt[e][u][0],i[1]=Jt[e][u][1],b([null===t[0].children?t[0]:t[0].children[i[0]],null===t[1].children?t[1]:t[1].children[i[1]]],Jt[e][u][2],n);for(u=0;u<4;++u){for(i[0]=Kt[e][u][1],i[1]=Kt[e][u][2],i[2]=Kt[e][u][3],i[3]=Kt[e][u][4],o=r[Kt[e][u][0]],s=[],l=0;l<4;++l)if(null!==(a=t[o[l]]).voxel)s[l]=a;else{if(null===a.children)break;s[l]=a.children[i[l]]}4===l&&k(s,Kt[e][u][5],n)}}}function z(t,e){var n=t.children,i=[0,0,0,0],r=void 0;if(null!==n){for(r=0;r<8;++r)z(n[r],e);for(r=0;r<12;++r)i[0]=Zt[r][0],i[1]=Zt[r][1],b([n[i[0]],n[i[1]]],Zt[r][2],e);for(r=0;r<6;++r)i[0]=Qt[r][0],i[1]=Qt[r][1],i[2]=Qt[r][2],i[3]=Qt[r][3],k([n[i[0]],n[i[1]],n[i[2]],n[i[3]]],Qt[r][4],e)}}function A(t,e,n,i){var r=void 0,s=void 0;if(null!==t.children)for(r=0;r<8;++r)i=A(t.children[r],e,n,i);else null!==t.voxel&&((s=t.voxel).index=i,e[3*i]=s.position.x,e[3*i+1]=s.position.y,e[3*i+2]=s.position.z,n[3*i]=s.normal.x,n[3*i+1]=s.normal.y,n[3*i+2]=s.normal.z,++i);return i}function U(t){var e=ce,n=Mt.resolution,i=new q(0,0,0),r=new q(n,n,n),s=new V(de,de.clone().addScalar(ce));return t.type!==oe.INTERSECTION&&(t.boundingBox.intersectsBox(s)?(i.copy(t.boundingBox.min).max(s.min).sub(s.min),i.x=Math.ceil(i.x*n/e),i.y=Math.ceil(i.y*n/e),i.z=Math.ceil(i.z*n/e),r.copy(t.boundingBox.max).min(s.max).sub(s.min),r.x=Math.floor(r.x*n/e),r.y=Math.floor(r.y*n/e),r.z=Math.floor(r.z*n/e)):(i.set(n,n,n),r.set(0,0,0))),new V(i,r)}function I(t,e,n,i){var r=Mt.resolution+1,s=r*r,o=i.max.x,a=i.max.y,u=i.max.z,l=void 0,h=void 0,c=void 0;for(c=i.min.z;c<=u;++c)for(h=i.min.y;h<=a;++h)for(l=i.min.x;l<=o;++l)t.updateMaterialIndex(c*s+h*r+l,e,n)}function M(t,e,n){var i=ce,r=Mt.resolution,s=r+1,o=s*s,a=e.materialIndices,u=de,l=new q,h=new q,c=n.max.x,d=n.max.y,y=n.max.z,v=void 0,f=0,m=void 0,p=void 0,x=void 0;for(x=n.min.z;x<=y;++x)for(l.z=x*i/r,p=n.min.y;p<=d;++p)for(l.y=p*i/r,m=n.min.x;m<=c;++m)l.x=m*i/r,(v=t.generateMaterialIndex(h.addVectors(u,l)))!==L.AIR&&(a[x*o+p*s+m]=v,++f);e.materials=f}function S(t,e,n){var i=Mt.resolution,r=i+1,s=r*r,o=new Uint32Array([1,r,s]),a=e.materialIndices,u=new gt,l=new gt,h=n.edgeData,c=e.edgeData,d=new Uint32Array(3),y=At.calculate1DEdgeCount(i),v=new At(Math.min(y,c.indices[0].length+h.indices[0].length),Math.min(y,c.indices[1].length+h.indices[1].length),Math.min(y,c.indices[2].length+h.indices[2].length)),f=void 0,m=void 0,p=void 0,x=void 0,g=void 0,w=void 0,k=void 0,b=void 0,z=void 0,A=void 0,U=void 0,I=void 0,M=void 0,S=void 0,O=void 0,_=void 0,C=void 0,D=void 0,E=void 0,P=void 0,T=void 0,N=void 0;for(C=0,D=0;D<3;C=0,++D){for(f=h.indices[D],x=c.indices[D],k=v.indices[D],m=h.zeroCrossings[D],g=c.zeroCrossings[D],b=v.zeroCrossings[D],p=h.normals[D],w=c.normals[D],z=v.normals[D],T=f.length,N=x.length,E=0,P=0;E<T;++E)if(A=f[E],U=A+o[D],S=a[A],O=a[U],S!==O&&(S===L.AIR||O===L.AIR)){for(u.t=m[E],u.n.x=p[3*E],u.n.y=p[3*E+1],u.n.z=p[3*E+2],t.type===oe.DIFFERENCE&&u.n.negate(),_=u;P<N&&x[P]<=A;)M=(I=x[P])+o[D],l.t=g[P],l.n.x=w[3*P],l.n.y=w[3*P+1],l.n.z=w[3*P+2],S=a[I],I<A?S===(O=a[M])||S!==L.AIR&&O!==L.AIR||(k[C]=I,b[C]=l.t,z[3*C]=l.n.x,z[3*C+1]=l.n.y,z[3*C+2]=l.n.z,++C):_=t.selectEdge(l,u,S===L.SOLID),++P;k[C]=A,b[C]=_.t,z[3*C]=_.n.x,z[3*C+1]=_.n.y,z[3*C+2]=_.n.z,++C}for(;P<N;)M=(I=x[P])+o[D],(S=a[I])===(O=a[M])||S!==L.AIR&&O!==L.AIR||(k[C]=I,b[C]=g[P],z[3*C]=w[3*P],z[3*C+1]=w[3*P+1],z[3*C+2]=w[3*P+2],++C),++P;d[D]=C}return{edgeData:v,lengths:d}}function O(t,e,n){var i=ce,r=Mt.resolution,s=r+1,o=s*s,a=new Uint32Array([1,s,o]),u=e.materialIndices,l=de,h=new q,c=new q,d=new gt,y=new Uint32Array(3),v=new At(At.calculate1DEdgeCount(r)),f=void 0,m=void 0,p=void 0,x=void 0,g=void 0,w=void 0,k=void 0,b=void 0,z=void 0,A=void 0,U=void 0,I=void 0,M=void 0,S=void 0,O=void 0,_=void 0,C=void 0,D=void 0;for(S=4,I=0,M=0;M<3;S>>=1,I=0,++M){switch(O=Z[S],f=v.indices[M],m=v.zeroCrossings[M],p=v.normals[M],w=n.min.x,z=n.max.x,k=n.min.y,A=n.max.y,b=n.min.z,U=n.max.z,M){case 0:w=Math.max(w-1,0),z=Math.min(z,r-1);break;case 1:k=Math.max(k-1,0),A=Math.min(A,r-1);break;case 2:b=Math.max(b-1,0),U=Math.min(U,r-1)}for(D=b;D<=U;++D)for(C=k;C<=A;++C)for(_=w;_<=z;++_)g=(x=D*o+C*s+_)+a[M],u[x]!==u[g]&&(h.set(_*i/r,C*i/r,D*i/r),c.set((_+O[0])*i/r,(C+O[1])*i/r,(D+O[2])*i/r),d.a.addVectors(l,h),d.b.addVectors(l,c),t.generateEdge(d),f[I]=x,m[I]=d.t,p[3*I]=d.n.x,p[3*I+1]=d.n.y,p[3*I+2]=d.n.z,++I);y[M]=I}return{edgeData:v,lengths:y}}function _(t,e,n){var i=U(t),r=void 0,s=void 0,o=void 0,a=void 0,u=!1;if(t.type===oe.DENSITY_FUNCTION?M(t,e,i):e.empty?t.type===oe.UNION&&(e.set(n),u=!0):e.full&&t.type===oe.UNION||I(t,e,n,i),!u&&!e.empty&&!e.full){for(s=(r=t.type===oe.DENSITY_FUNCTION?O(t,e,i):S(t,e,n)).edgeData,o=r.lengths,a=0;a<3;++a)s.indices[a]=s.indices[a].slice(0,o[a]),s.zeroCrossings[a]=s.zeroCrossings[a].slice(0,o[a]),s.normals[a]=s.normals[a].slice(0,3*o[a]);e.edgeData=s}}function C(t){var e=t.children,n=void 0,i=void 0,r=void 0,s=void 0;for(t.type===oe.DENSITY_FUNCTION&&_(t,n=new Mt),r=0,s=e.length;r<s&&(i=C(e[r]),void 0===n?n=i:null!==i?null===n?t.type===oe.UNION&&(n=i):_(t,n,i):t.type===oe.INTERSECTION&&(n=null),null!==n||t.type===oe.UNION);++r);return null!==n&&n.empty?null:n}var D=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},E=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),P=function t(e,n,i){null===e&&(e=Function.prototype);var r=Object.getOwnPropertyDescriptor(e,n);if(void 0===r){var s=Object.getPrototypeOf(e);return null===s?void 0:t(s,n,i)}if("value"in r)return r.value;var o=r.get;if(void 0!==o)return o.call(i)},T=function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)},N=function(t,e){if(!t)throw new ReferenceError("this hasn\'t been initialised - super() hasn\'t been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e},R=function(t){if(Array.isArray(t)){for(var e=0,n=Array(t.length);e<t.length;e++)n[e]=t[e];return n}return Array.from(t)},F=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;D(this,t),this.runLengths=e,this.data=n}return E(t,null,[{key:"encode",value:function(e){var n=[],i=[],r=e[0],s=1,o=void 0,a=void 0;for(o=1,a=e.length;o<a;++o)r!==e[o]?(n.push(s),i.push(r),r=e[o],s=1):++s;return n.push(s),i.push(r),new t(n,i)}},{key:"decode",value:function(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],i=void 0,r=void 0,s=void 0,o=void 0,a=void 0,u=0;for(r=0,o=e.length;r<o;++r)for(i=e[r],s=0,a=t[r];s<a;++s)n[u++]=i;return n}}]),t}(),L={AIR:0,SOLID:1},B=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;D(this,t),this.x=e,this.y=n}return E(t,[{key:"set",value:function(t,e){return this.x=t,this.y=e,this}},{key:"copy",value:function(t){return this.x=t.x,this.y=t.y,this}},{key:"fromArray",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return this.x=t[e],this.y=t[e+1],this}},{key:"toArray",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return t[e]=this.x,t[e+1]=this.y,t}},{key:"equals",value:function(t){return t.x===this.x&&t.y===this.y}},{key:"clone",value:function(){return new this.constructor(this.x,this.y)}},{key:"add",value:function(t){return this.x+=t.x,this.y+=t.y,this}},{key:"addScaledVector",value:function(t,e){return this.x+=t.x*e,this.y+=t.y*e,this}},{key:"addScalar",value:function(t){return this.x+=t,this.y+=t,this}},{key:"addVectors",value:function(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this}},{key:"sub",value:function(t){return this.x-=t.x,this.y-=t.y,this}},{key:"subScalar",value:function(t){return this.x-=t,this.y-=t,this}},{key:"subVectors",value:function(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this}},{key:"multiply",value:function(t){return this.x*=t.x,this.y*=t.y,this}},{key:"multiplyScalar",value:function(t){return isFinite(t)?(this.x*=t,this.y*=t):(this.x=0,this.y=0),this}},{key:"multiplyVectors",value:function(t,e){return this.x=t.x*e.x,this.y=t.y*e.y,this}},{key:"divide",value:function(t){return this.x/=t.x,this.y/=t.y,this}},{key:"divideScalar",value:function(t){return this.multiplyScalar(1/t)}},{key:"divideVectors",value:function(t,e){return this.x=t.x/e.x,this.y=t.y/e.y,this}},{key:"negate",value:function(){return this.x=-this.x,this.y=-this.y,this}},{key:"dot",value:function(t){return this.x*t.x+this.y*t.y}},{key:"lengthSq",value:function(){return this.x*this.x+this.y*this.y}},{key:"length",value:function(){return Math.sqrt(this.x*this.x+this.y*this.y)}},{key:"distanceTo",value:function(t){return Math.sqrt(this.distanceToSquared(t))}},{key:"distanceToSquared",value:function(t){var e=this.x-t.x,n=this.y-t.y;return e*e+n*n}},{key:"normalize",value:function(){return this.divideScalar(this.length())}},{key:"min",value:function(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this}},{key:"max",value:function(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this}},{key:"clamp",value:function(t,e){return this.x=Math.max(t.x,Math.min(e.x,this.x)),this.y=Math.max(t.y,Math.min(e.y,this.y)),this}}]),t}(),q=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;D(this,t),this.x=e,this.y=n,this.z=i}return E(t,[{key:"set",value:function(t,e,n){return this.x=t,this.y=e,this.z=n,this}},{key:"copy",value:function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this}},{key:"fromArray",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return this.x=t[e],this.y=t[e+1],this.z=t[e+2],this}},{key:"toArray",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return t[e]=this.x,t[e+1]=this.y,t[e+2]=this.z,t}},{key:"equals",value:function(t){return t.x===this.x&&t.y===this.y&&t.z===this.z}},{key:"clone",value:function(){return new this.constructor(this.x,this.y,this.z)}},{key:"add",value:function(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this}},{key:"addScaledVector",value:function(t,e){return this.x+=t.x*e,this.y+=t.y*e,this.z+=t.z*e,this}},{key:"addScalar",value:function(t){return this.x+=t,this.y+=t,this.z+=t,this}},{key:"addVectors",value:function(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this}},{key:"sub",value:function(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this}},{key:"subScalar",value:function(t){return this.x-=t,this.y-=t,this.z-=t,this}},{key:"subVectors",value:function(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this}},{key:"multiply",value:function(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this}},{key:"multiplyScalar",value:function(t){return isFinite(t)?(this.x*=t,this.y*=t,this.z*=t):(this.x=0,this.y=0,this.z=0),this}},{key:"multiplyVectors",value:function(t,e){return this.x=t.x*e.x,this.y=t.y*e.y,this.z=t.z*e.z,this}},{key:"divide",value:function(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this}},{key:"divideScalar",value:function(t){return this.multiplyScalar(1/t)}},{key:"divideVectors",value:function(t,e){return this.x=t.x/e.x,this.y=t.y/e.y,this.z=t.z/e.z,this}},{key:"negate",value:function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}},{key:"dot",value:function(t){return this.x*t.x+this.y*t.y+this.z*t.z}},{key:"lengthSq",value:function(){return this.x*this.x+this.y*this.y+this.z*this.z}},{key:"length",value:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}},{key:"distanceTo",value:function(t){return Math.sqrt(this.distanceToSquared(t))}},{key:"distanceToSquared",value:function(t){var e=this.x-t.x,n=this.y-t.y,i=this.z-t.z;return e*e+n*n+i*i}},{key:"normalize",value:function(){return this.divideScalar(this.length())}},{key:"min",value:function(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this.z=Math.min(this.z,t.z),this}},{key:"max",value:function(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this.z=Math.max(this.z,t.z),this}},{key:"clamp",value:function(t,e){return this.x=Math.max(t.x,Math.min(e.x,this.x)),this.y=Math.max(t.y,Math.min(e.y,this.y)),this.z=Math.max(t.z,Math.min(e.z,this.z)),this}},{key:"applyMatrix3",value:function(t){var e=this.x,n=this.y,i=this.z,r=t.elements;return this.x=r[0]*e+r[3]*n+r[6]*i,this.y=r[1]*e+r[4]*n+r[7]*i,this.z=r[2]*e+r[5]*n+r[8]*i,this}},{key:"applyMatrix4",value:function(t){var e=this.x,n=this.y,i=this.z,r=t.elements;return this.x=r[0]*e+r[4]*n+r[8]*i+r[12],this.y=r[1]*e+r[5]*n+r[9]*i+r[13],this.z=r[2]*e+r[6]*n+r[10]*i+r[14],this}}]),t}(),V=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new q(1/0,1/0,1/0),n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new q(-1/0,-1/0,-1/0);D(this,t),this.min=e,this.max=n}return E(t,[{key:"set",value:function(t,e){return this.min.copy(t),this.max.copy(e),this}},{key:"copy",value:function(t){return this.min.copy(t.min),this.max.copy(t.max),this}},{key:"clone",value:function(){return(new this.constructor).copy(this)}},{key:"expandByPoint",value:function(t){return this.min.min(t),this.max.max(t),this}},{key:"union",value:function(t){return this.min.min(t.min),this.max.max(t.max),this}},{key:"setFromPoints",value:function(t){var e=void 0,n=void 0;for(e=0,n=t.length;e<n;++e)this.expandByPoint(t[e]);return this}},{key:"setFromCenterAndSize",value:function(t,e){var n=e.clone().multiplyScalar(.5);return this.min.copy(t).sub(n),this.max.copy(t).add(n),this}},{key:"intersectsBox",value:function(t){return!(t.max.x<this.min.x||t.min.x>this.max.x||t.max.y<this.min.y||t.min.y>this.max.y||t.max.z<this.min.z||t.min.z>this.max.z)}}]),t}(),j=function(){function t(){D(this,t),this.elements=new Float32Array([1,0,0,0,1,0,0,0,1])}return E(t,[{key:"set",value:function(t,e,n,i,r,s,o,a,u){var l=this.elements;return l[0]=t,l[3]=e,l[6]=n,l[1]=i,l[4]=r,l[7]=s,l[2]=o,l[5]=a,l[8]=u,this}},{key:"identity",value:function(){return this.set(1,0,0,0,1,0,0,0,1),this}},{key:"copy",value:function(t){var e=t.elements;return this.set(e[0],e[3],e[6],e[1],e[4],e[7],e[2],e[5],e[8])}},{key:"clone",value:function(){return(new this.constructor).copy(this)}}]),t}(),Y=function(){function t(){D(this,t),this.elements=new Float32Array([1,0,0,1,0,1])}return E(t,[{key:"set",value:function(t,e,n,i,r,s){var o=this.elements;return o[0]=t,o[1]=e,o[3]=i,o[2]=n,o[4]=r,o[5]=s,this}},{key:"identity",value:function(){return this.set(1,0,0,1,0,1),this}},{key:"copy",value:function(t){var e=t.elements;return this.set(e[0],e[1],e[2],e[3],e[4],e[5]),this}},{key:"clone",value:function(){return(new this.constructor).copy(this)}},{key:"toMatrix3",value:function(t){var e=t.elements;t.set(e[0],e[1],e[2],e[1],e[3],e[4],e[2],e[4],e[5])}},{key:"add",value:function(t){var e=this.elements,n=t.elements;return e[0]+=n[0],e[1]+=n[1],e[3]+=n[3],e[2]+=n[2],e[4]+=n[4],e[5]+=n[5],this}},{key:"norm",value:function(){var t=this.elements,e=t[1]*t[1],n=t[2]*t[2],i=t[4]*t[4];return Math.sqrt(t[0]*t[0]+e+n+e+t[3]*t[3]+i+n+i+t[5]*t[5])}},{key:"off",value:function(){var t=this.elements;return Math.sqrt(2*(t[1]*t[1]+t[2]*t[2]+t[4]*t[4]))}},{key:"applyToVector3",value:function(t){var e=t.x,n=t.y,i=t.z,r=this.elements;return t.x=r[0]*e+r[1]*n+r[2]*i,t.y=r[1]*e+r[3]*n+r[4]*i,t.z=r[2]*e+r[4]*n+r[5]*i,t}}],[{key:"calculateIndex",value:function(t,e){return 3-(3-t)*(2-t)/2+e}}]),t}(),X=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,n=arguments.length>1&&void 0!==arguments[1]&&arguments[1];D(this,t),this.value=e,this.done=n}return E(t,[{key:"reset",value:function(){this.value=null,this.done=!1}}]),t}(),H=new q,G=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new q,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new q;D(this,t),this.min=e,this.max=n,this.children=null}return E(t,[{key:"getCenter",value:function(){return(arguments.length>0&&void 0!==arguments[0]?arguments[0]:new q).copy(this.min).add(this.max).multiplyScalar(.5)}},{key:"getDimensions",value:function(){return(arguments.length>0&&void 0!==arguments[0]?arguments[0]:new q).copy(this.max).sub(this.min)}},{key:"split",value:function(){var t=this.min,e=this.max,n=this.getCenter(H),i=this.children=[null,null,null,null,null,null,null,null],r=void 0,s=void 0;for(r=0;r<8;++r)s=Z[r],i[r]=new this.constructor(new q(0===s[0]?t.x:n.x,0===s[1]?t.y:n.y,0===s[2]?t.z:n.z),new q(0===s[0]?n.x:e.x,0===s[1]?n.y:e.y,0===s[2]?n.z:e.z))}}]),t}(),Z=[new Uint8Array([0,0,0]),new Uint8Array([0,0,1]),new Uint8Array([0,1,0]),new Uint8Array([0,1,1]),new Uint8Array([1,0,0]),new Uint8Array([1,0,1]),new Uint8Array([1,1,0]),new Uint8Array([1,1,1])],Q=[new Uint8Array([0,4]),new Uint8Array([1,5]),new Uint8Array([2,6]),new Uint8Array([3,7]),new Uint8Array([0,2]),new Uint8Array([1,3]),new Uint8Array([4,6]),new Uint8Array([5,7]),new Uint8Array([0,1]),new Uint8Array([2,3]),new Uint8Array([4,5]),new Uint8Array([6,7])],J=new q,K=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new q,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;D(this,t),this.min=e,this.size=n,this.children=null}return E(t,[{key:"getCenter",value:function(){return(arguments.length>0&&void 0!==arguments[0]?arguments[0]:new q).copy(this.min).addScalar(.5*this.size)}},{key:"getDimensions",value:function(){return(arguments.length>0&&void 0!==arguments[0]?arguments[0]:new q).set(this.size,this.size,this.size)}},{key:"split",value:function(){var t=this.min,e=this.getCenter(J),n=.5*this.size,i=this.children=[null,null,null,null,null,null,null,null],r=void 0,s=void 0;for(r=0;r<8;++r)s=Z[r],i[r]=new this.constructor(new q(0===s[0]?t.x:e.x,0===s[1]?t.y:e.y,0===s[2]?t.z:e.z),n)}},{key:"max",get:function(){return this.min.clone().addScalar(this.size)}}]),t}(),W=new V,$=function(){function t(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;D(this,t),this.octree=e,this.region=n,this.cull=null!==n,this.result=new X,this.trace=null,this.indices=null,this.reset()}return E(t,[{key:"reset",value:function(){var t=this.octree.root;return this.trace=[],this.indices=[],null!==t&&(W.min=t.min,W.max=t.max,this.cull&&!this.region.intersectsBox(W)||(this.trace.push(t),this.indices.push(0))),this.result.reset(),this}},{key:"next",value:function(){for(var t=this.cull,e=this.region,n=this.indices,i=this.trace,r=null,s=i.length-1,o=void 0,a=void 0,u=void 0;null===r&&s>=0;)if(o=n[s],a=i[s].children,++n[s],o<8)if(null!==a){if(u=a[o],t&&(W.min=u.min,W.max=u.max,!e.intersectsBox(W)))continue;i.push(u),n.push(0),++s}else r=i.pop(),n.pop();else i.pop(),n.pop(),--s;return this.result.value=r,this.result.done=null===r,this.result}},{key:"return",value:function(t){return this.result.value=t,this.result.done=!0,this.result}},{key:Symbol.iterator,value:function(){return this}}]),t}(),tt=new Uint8Array([0,1,2,3,4,5,6,7,0]),et=[new Uint8Array([4,2,1]),new Uint8Array([5,3,8]),new Uint8Array([6,8,3]),new Uint8Array([7,8,8]),new Uint8Array([8,6,5]),new Uint8Array([8,7,8]),new Uint8Array([8,8,7]),new Uint8Array([8,8,8])],nt=new q,it=new q,rt=new q,st=new q,ot=new q,at=new q,ut=new q,lt=function(){function t(){D(this,t)}return E(t,null,[{key:"intersectOctree",value:function(t,e,i){var r=void 0,s=void 0,o=void 0,a=void 0,u=void 0,l=void 0,h=void 0,c=void 0,d=void 0;t.getDimensions(nt),it.copy(nt).multiplyScalar(.5),st.copy(t.min).sub(t.min),ot.copy(t.max).sub(t.min),at.copy(e.ray.direction),ut.copy(e.ray.origin),ut.sub(t.getCenter(rt)).add(it),tt[8]=tt[0],at.x<0&&(ut.x=nt.x-ut.x,at.x=-at.x,tt[8]|=tt[4]),at.y<0&&(ut.y=nt.y-ut.y,at.y=-at.y,tt[8]|=tt[2]),at.z<0&&(ut.z=nt.z-ut.z,at.z=-at.z,tt[8]|=tt[1]),r=1/at.x,s=1/at.y,o=1/at.z,a=(st.x-ut.x)*r,u=(ot.x-ut.x)*r,l=(st.y-ut.y)*s,h=(ot.y-ut.y)*s,c=(st.z-ut.z)*o,d=(ot.z-ut.z)*o,Math.max(Math.max(a,l),c)<Math.min(Math.min(u,h),d)&&n(t.root,a,l,c,u,h,d,e,i)}}]),t}(),ht=new V,ct=function(){function t(e,n){D(this,t),this.root=void 0!==e&&void 0!==n?new G(e,n):null}return E(t,[{key:"getCenter",value:function(t){return this.root.getCenter(t)}},{key:"getDimensions",value:function(t){return this.root.getDimensions(t)}},{key:"getDepth",value:function(){return i(this.root)}},{key:"cull",value:function(t){var e=[];return r(this.root,t,e),e}},{key:"findOctantsByLevel",value:function(t){var e=[];return s(this.root,t,0,e),e}},{key:"raycast",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];return lt.intersectOctree(this,t,e),e}},{key:"leaves",value:function(t){return new $(this,t)}},{key:Symbol.iterator,value:function(){return new $(this)}},{key:"min",get:function(){return this.root.min}},{key:"max",get:function(){return this.root.max}},{key:"children",get:function(){return this.root.children}}]),t}(),dt=new q,yt=function(t){function e(t,n){D(this,e);var i=N(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n));return i.points=null,i.data=null,i}return T(e,G),E(e,[{key:"distanceToSquared",value:function(t){return dt.copy(t).clamp(this.min,this.max).sub(t).lengthSq()}},{key:"distanceToCenterSquared",value:function(t){var e=this.getCenter(dt),n=t.x-e.x,i=t.y-e.x,r=t.z-e.z;return n*n+i*i+r*r}},{key:"contains",value:function(t,e){var n=this.min,i=this.max;return t.x>=n.x-e&&t.y>=n.y-e&&t.z>=n.z-e&&t.x<=i.x+e&&t.y<=i.y+e&&t.z<=i.z+e}},{key:"redistribute",value:function(t){var e=this.children,n=this.points,i=this.data,r=void 0,s=void 0,o=void 0,a=void 0,u=void 0,l=void 0,h=void 0;if(null!==e)for(r=0,o=n.length;r<o;++r)for(l=n[r],h=i[r],s=0,a=e.length;s<a;++s)if((u=e[s]).contains(l,t)){null===u.points&&(u.points=[],u.data=[]),u.points.push(l),u.data.push(h);break}this.points=null,this.data=null}},{key:"merge",value:function(){var t=this.children,e=void 0,n=void 0,i=void 0;if(null!==t){for(this.points=[],this.data=[],e=0,n=t.length;e<n;++e)if(null!==(i=t[e]).points){var r,s;(r=this.points).push.apply(r,R(i.points)),(s=this.data).push.apply(s,R(i.data))}this.children=null}}}]),e}(),vt=function t(e,n,i){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;D(this,t),this.distance=e,this.distanceToRay=n,this.point=i,this.object=r},ft=1e-6,mt=(function(t){function e(t,n){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:8,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:8;D(this,e);var o=N(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return o.root=new yt(t,n),o.bias=Math.max(0,i),o.maxPoints=Math.max(1,Math.round(r)),o.maxDepth=Math.max(0,Math.round(s)),o.pointCount=0,o}T(e,ct),E(e,[{key:"countPoints",value:function(t){return o(t)}},{key:"put",value:function(t,e){return a(t,e,this,this.root,0)}},{key:"remove",value:function(t){return u(t,this,this.root,null)}},{key:"fetch",value:function(t){return l(t,this,this.root)}},{key:"move",value:function(t,e){return h(t,e,this,this.root,null,0)}},{key:"findNearestPoint",value:function(t){return c(t,arguments.length>1&&void 0!==arguments[1]?arguments[1]:1/0,arguments.length>2&&void 0!==arguments[2]&&arguments[2],this.root)}},{key:"findPoints",value:function(t,e){var n=[];return d(t,e,arguments.length>2&&void 0!==arguments[2]&&arguments[2],this.root,n),n}},{key:"raycast",value:function(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],i=P(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"raycast",this).call(this,t);return i.length>0&&this.testPoints(i,t,n),n}},{key:"testPoints",value:function(t,e,n){var i=e.params.Points.threshold,r=i*i,s=void 0,o=void 0,a=void 0,u=void 0,l=void 0,h=void 0,c=void 0,d=void 0,y=void 0,v=void 0,f=void 0;for(l=0,c=t.length;l<c;++l)if(y=t[l],null!==(v=y.points))for(h=0,d=v.length;h<d;++h)f=v[h],(u=e.ray.distanceSqToPoint(f))<r&&(s=e.ray.closestPointToPoint(f),(o=e.ray.origin.distanceTo(s))>=e.near&&o<=e.far&&(a=Math.sqrt(u),n.push(new vt(o,a,s,y.data[h]))))}}])}(),function(){function t(){D(this,t)}E(t,null,[{key:"recycleOctants",value:function(t,e){var n=new q,i=new q,r=new q,s=t.min,o=t.getCenter(),a=t.getDimensions().multiplyScalar(.5),u=t.children,l=e.length,h=void 0,c=void 0,d=void 0,y=void 0;for(h=0;h<8;++h)for(d=Z[h],i.addVectors(s,n.fromArray(d).multiply(a)),r.addVectors(o,n.fromArray(d).multiply(a)),c=0;c<l;++c)if(null!==(y=e[c])&&i.equals(y.min)&&r.equals(y.max)){u[h]=y,e[c]=null;break}}}])}(),new q),pt=new q,xt=new q,gt=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new q,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new q;D(this,t),this.a=e,this.b=n,this.index=-1,this.coordinates=new q,this.t=0,this.n=new q}return E(t,[{key:"approximateZeroCrossing",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:8,n=Math.max(1,e-1),i=0,r=1,s=0,o=0,a=void 0,u=void 0;for(mt.subVectors(this.b,this.a);o<=n&&(s=(i+r)/2,pt.addVectors(this.a,xt.copy(mt).multiplyScalar(s)),u=t.sample(pt),!(Math.abs(u)<=1e-4||(r-i)/2<=1e-6));)pt.addVectors(this.a,xt.copy(mt).multiplyScalar(i)),a=t.sample(pt),Math.sign(u)===Math.sign(a)?i=s:r=s,++o;this.t=s}},{key:"computeZeroCrossingPosition",value:function(){return(arguments.length>0&&void 0!==arguments[0]?arguments[0]:new q).subVectors(this.b,this.a).multiplyScalar(this.t).add(this.a)}},{key:"computeSurfaceNormal",value:function(t){var e=this.computeZeroCrossingPosition(mt),n=.001,i=t.sample(pt.addVectors(e,xt.set(n,0,0)))-t.sample(pt.subVectors(e,xt.set(n,0,0))),r=t.sample(pt.addVectors(e,xt.set(0,n,0)))-t.sample(pt.subVectors(e,xt.set(0,n,0))),s=t.sample(pt.addVectors(e,xt.set(0,0,n)))-t.sample(pt.subVectors(e,xt.set(0,0,n)));this.n.set(i,r,s).normalize()}}]),t}(),wt=new gt,kt=new q,bt=new q,zt=function(){function t(e,n,i){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:3;D(this,t),this.edgeData=e,this.cellPosition=n,this.cellSize=i,this.indices=null,this.zeroCrossings=null,this.normals=null,this.axes=null,this.lengths=null,this.result=new X,this.initialC=r,this.c=r,this.initialD=s,this.d=s,this.i=0,this.l=0,this.reset()}return E(t,[{key:"reset",value:function(){var t=this.edgeData,e=[],n=[],i=[],r=[],s=[],o=void 0,a=void 0,u=void 0,l=void 0;for(this.i=0,this.c=0,this.d=0,o=4>>(a=this.initialC),u=this.initialD;a<u;++a,o>>=1)(l=t.indices[a].length)>0&&(e.push(t.indices[a]),n.push(t.zeroCrossings[a]),i.push(t.normals[a]),r.push(Z[o]),s.push(l),++this.d);return this.l=s.length>0?s[0]:0,this.indices=e,this.zeroCrossings=n,this.normals=i,this.axes=r,this.lengths=s,this.result.reset(),this}},{key:"next",value:function(){var t=this.cellSize,e=Mt.resolution,n=e+1,i=n*n,r=this.result,s=this.cellPosition,o=void 0,a=void 0,u=void 0,l=void 0,h=void 0,c=void 0,d=void 0;return this.i===this.l&&(this.l=++this.c<this.d?this.lengths[this.c]:0,this.i=0),this.i<this.l?(c=this.c,d=this.i,o=this.axes[c],a=this.indices[c][d],wt.index=a,u=a%n,l=Math.trunc(a%i/n),h=Math.trunc(a/i),wt.coordinates.set(u,l,h),kt.set(u*t/e,l*t/e,h*t/e),bt.set((u+o[0])*t/e,(l+o[1])*t/e,(h+o[2])*t/e),wt.a.addVectors(s,kt),wt.b.addVectors(s,bt),wt.t=this.zeroCrossings[c][d],wt.n.fromArray(this.normals[c],3*d),r.value=wt,++this.i):(r.value=null,r.done=!0),r}},{key:"return",value:function(t){return this.result.value=t,this.result.done=!0,this.result}},{key:Symbol.iterator,value:function(){return this}}]),t}(),At=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e;D(this,t),this.indices=e<=0?null:[new Uint32Array(e),new Uint32Array(n),new Uint32Array(i)],this.zeroCrossings=e<=0?null:[new Float32Array(e),new Float32Array(n),new Float32Array(i)],this.normals=e<=0?null:[new Float32Array(3*e),new Float32Array(3*n),new Float32Array(3*i)]}return E(t,[{key:"serialize",value:function(){return{edges:this.edges,zeroCrossings:this.zeroCrossings,normals:this.normals}}},{key:"deserialize",value:function(t){var e=this;return null!==t?(this.edges=t.edges,this.zeroCrossings=t.zeroCrossings,this.normals=t.normals):e=null,e}},{key:"createTransferList",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],e=[this.edges[0],this.edges[1],this.edges[2],this.zeroCrossings[0],this.zeroCrossings[1],this.zeroCrossings[2],this.normals[0],this.normals[1],this.normals[2]],n=void 0,i=void 0,r=void 0;for(i=0,r=e.length;i<r;++i)null!==(n=e[i])&&t.push(n.buffer);return t}},{key:"edges",value:function(t,e){return new zt(this,t,e)}},{key:"edgesX",value:function(t,e){return new zt(this,t,e,0,1)}},{key:"edgesY",value:function(t,e){return new zt(this,t,e,1,2)}},{key:"edgesZ",value:function(t,e){return new zt(this,t,e,2,3)}}],[{key:"calculate1DEdgeCount",value:function(t){return Math.pow(t+1,2)*t}}]),t}(),Ut=0,It=0,Mt=function(){function t(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];D(this,t),this.lod=-1,this.neutered=!1,this.materials=0,this.materialIndices=e?new Uint8Array(It):null,this.runLengths=null,this.edgeData=null}return E(t,[{key:"set",value:function(t){return this.lod=t.lod,this.neutered=t.neutered,this.materials=t.materials,this.materialIndices=t.materialIndices,this.runLengths=t.runLengths,this.edgeData=t.edgeData,this}},{key:"clear",value:function(){return this.lod=-1,this.neutered=!1,this.materials=0,this.materialIndices=null,this.runLengths=null,this.edgeData=null,this}},{key:"setMaterialIndex",value:function(t,e){this.materialIndices[t]===L.AIR?e!==L.AIR&&++this.materials:e===L.AIR&&--this.materials,this.materialIndices[t]=e}},{key:"compress",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this,e=void 0;return this.compressed||(e=this.full?new F([this.materialIndices.length],[L.SOLID]):F.encode(this.materialIndices),t.runLengths=new Uint32Array(e.runLengths),t.materialIndices=new Uint8Array(e.data)),t}},{key:"decompress",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this;return this.compressed&&(t.materialIndices=F.decode(this.runLengths,this.materialIndices,new Uint8Array(It)),t.runLengths=null),t}},{key:"serialize",value:function(){return this.neutered=!0,{lod:this.lod,materials:this.materials,materialIndices:this.materialIndices,runLengths:this.runLengths,edgeData:null!==this.edgeData?this.edgeData.serialize():null}}},{key:"deserialize",value:function(t){var e=this;return null!==t?(this.lod=t.lod,this.materials=t.materials,this.materialIndices=t.materialIndices,this.runLengths=t.runLengths,null!==t.edgeData?(null===this.edgeData&&(this.edgeData=new At(0)),this.edgeData.deserialize(t.edgeData)):this.edgeData=null,this.neutered=!1):e=null,e}},{key:"createTransferList",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];return null!==this.edgeData&&this.edgeData.createTransferList(t),t.push(this.materialIndices.buffer),t.push(this.runLengths.buffer),t}},{key:"empty",get:function(){return 0===this.materials}},{key:"full",get:function(){return this.materials===It}},{key:"compressed",get:function(){return null!==this.runLengths}}],[{key:"resolution",get:function(){return Ut},set:function(t){0===Ut&&(Ut=Math.max(1,Math.min(256,t)),It=Math.pow(Ut+1,3))}}]),t}(),St=function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;D(this,t),this.action=e,this.data=null,this.error=null},Ot=function(){function t(){D(this,t),this.ata=new Y,this.ata.set(0,0,0,0,0,0),this.atb=new q,this.massPointSum=new q,this.numPoints=0}return E(t,[{key:"set",value:function(t,e,n,i){return this.ata.copy(t),this.atb.copy(e),this.massPointSum.copy(n),this.numPoints=i,this}},{key:"copy",value:function(t){return this.set(t.ata,t.atb,t.massPointSum,t.numPoints)}},{key:"add",value:function(t,e){var n=e.x,i=e.y,r=e.z,s=t.dot(e),o=this.ata.elements,a=this.atb;o[0]+=n*n,o[1]+=n*i,o[3]+=i*i,o[2]+=n*r,o[4]+=i*r,o[5]+=r*r,a.x+=s*n,a.y+=s*i,a.z+=s*r,this.massPointSum.add(t),++this.numPoints}},{key:"addData",value:function(t){this.ata.add(t.ata),this.atb.add(t.atb),this.massPointSum.add(t.massPointSum),this.numPoints+=t.numPoints}},{key:"clear",value:function(){this.ata.set(0,0,0,0,0,0),this.atb.set(0,0,0),this.massPointSum.set(0,0,0),this.numPoints=0}},{key:"clone",value:function(){return(new this.constructor).copy(this)}}]),t}(),_t=new B,Ct=function(){function t(){D(this,t)}return E(t,null,[{key:"calculateCoefficients",value:function(t,e,n){var i=void 0,r=void 0,s=void 0;return 0===e?(_t.x=1,_t.y=0):(i=(n-t)/(2*e),r=Math.sqrt(1+i*i),s=1/(i>=0?i+r:i-r),_t.x=1/Math.sqrt(1+s*s),_t.y=s*_t.x),_t}}]),t}(),Dt=function(){function t(){D(this,t)}return E(t,null,[{key:"rotateXY",value:function(t,e){var n=e.x,i=e.y,r=t.x,s=t.y;t.set(n*r-i*s,i*r+n*s)}},{key:"rotateQXY",value:function(t,e,n){var i=n.x,r=n.y,s=i*i,o=r*r,a=2*i*r*e,u=t.x,l=t.y;t.set(s*u-a+o*l,o*u+a+s*l)}}]),t}(),Et=1e-6,Pt=5,Tt=new Y,Nt=new j,Rt=new B,Ft=new q,Lt=function(){function t(){D(this,t)}return E(t,null,[{key:"solve",value:function(t,e,n){var i=m(Tt.copy(t),Nt.identity()),r=x(Nt,i);n.copy(e).applyMatrix3(r)}}]),t}(),Bt=new q,qt=function(){function t(){D(this,t),this.data=null,this.ata=new Y,this.atb=new q,this.massPoint=new q,this.hasSolution=!1}return E(t,[{key:"setData",value:function(t){return this.data=t,this.hasSolution=!1,this}},{key:"calculateError",value:function(t,e,n){return Bt.copy(n),t.applyToVector3(Bt),Bt.subVectors(e,Bt),Bt.dot(Bt)}},{key:"solve",value:function(t){var e=this.data,n=this.massPoint,i=this.ata.copy(e.ata),r=this.atb.copy(e.atb),s=1/0;return!this.hasSolution&&null!==e&&e.numPoints>0&&(Bt.copy(e.massPointSum).divideScalar(e.numPoints),n.copy(Bt),i.applyToVector3(Bt),r.sub(Bt),Lt.solve(i,r,t),s=this.calculateError(i,r,t),t.add(n),this.hasSolution=!0),s}}]),t}(),Vt=function t(){D(this,t),this.materials=0,this.edgeCount=0,this.index=-1,this.position=new q,this.normal=new q,this.qefData=null},jt=new qt,Yt=.01,Xt=function(t){function e(t,n){D(this,e);var i=N(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n));return i.voxel=null,i}return T(e,K),E(e,[{key:"contains",value:function(t){var e=this.min,n=this.size;return t.x>=e.x-1e-6&&t.y>=e.y-1e-6&&t.z>=e.z-1e-6&&t.x<=e.x+n+1e-6&&t.y<=e.y+n+1e-6&&t.z<=e.z+n+1e-6}},{key:"collapse",value:function(){var t=this.children,e=new Int16Array([-1,-1,-1,-1,-1,-1,-1,-1]),n=new q,i=-1,r=null!==t,s=0,o=void 0,a=void 0,u=void 0,l=void 0,h=void 0,c=void 0;if(r){for(l=new Ot,h=0,c=0;c<8;++c)s+=(o=t[c]).collapse(),u=o.voxel,null!==o.children?r=!1:null!==u&&(l.addData(u.qefData),i=u.materials>>7-c&1,e[c]=u.materials>>c&1,++h);if(r&&jt.setData(l).solve(n)<=Yt){for((u=new Vt).position.copy(this.contains(n)?n:jt.massPoint),c=0;c<8;++c)a=e[c],o=t[c],-1===a?u.materials|=i<<c:(u.materials|=a<<c,u.normal.add(o.voxel.normal));u.normal.normalize(),u.qefData=l,this.voxel=u,this.children=null,s+=h-1}}return s}},{key:"errorThreshold",get:function(){return Yt},set:function(t){Yt=t}}]),e}(),Ht=function(t){function e(t,n,i){D(this,e);var r=N(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return r.root=new Xt(new(Function.prototype.bind.apply(q,[null].concat(R(t)))),n),r.voxelCount=0,r.construct(i),r.simplify(),r}return T(e,ct),E(e,[{key:"simplify",value:function(){this.voxelCount-=this.root.collapse()}},{key:"getCell",value:function(t,e,n,i){var r=this.root,s=0;for(t>>=1;t>0;t>>=1,s=0)e>=t&&(s+=4,e-=t),n>=t&&(s+=2,n-=t),i>=t&&(s+=1,i-=t),null===r.children&&r.split(),r=r.children[s];return r}},{key:"construct",value:function(t){var e=Mt.resolution,n=t.edgeData,i=t.materialIndices,r=new qt,s=new q,o=[n.edgesX(this.min,this.size),n.edgesY(this.min,this.size),n.edgesZ(this.min,this.size)],a=[new Uint8Array([0,1,2,3]),new Uint8Array([0,1,4,5]),new Uint8Array([0,2,4,6])],u=0,l=void 0,h=void 0,c=void 0,d=void 0,y=void 0,v=void 0,f=void 0,m=void 0,p=void 0,x=void 0,w=void 0;for(x=0;x<3;++x){c=a[x],l=o[x];var k=!0,b=!1,z=void 0;try{for(var A,U=l[Symbol.iterator]();!(k=(A=U.next()).done);k=!0)for((h=A.value).computeZeroCrossingPosition(s),w=0;w<4;++w)d=Z[c[w]],f=h.coordinates.x-d[0],m=h.coordinates.y-d[1],p=h.coordinates.z-d[2],f>=0&&m>=0&&p>=0&&f<e&&m<e&&p<e&&(null===(y=this.getCell(e,f,m,p)).voxel&&(y.voxel=g(e,f,m,p,i),++u),(v=y.voxel).normal.add(h.n),v.qefData.add(s,h.n),v.qefData.numPoints===v.edgeCount&&(r.setData(v.qefData).solve(v.position),y.contains(v.position)||v.position.copy(r.massPoint),v.normal.normalize()))}catch(t){b=!0,z=t}finally{try{!k&&U.return&&U.return()}finally{if(b)throw z}}}this.voxelCount=u}}]),e}(),Gt=function t(e,n,i){D(this,t),this.indices=null,this.positions=null,this.normals=null},Zt=[new Uint8Array([0,4,0]),new Uint8Array([1,5,0]),new Uint8Array([2,6,0]),new Uint8Array([3,7,0]),new Uint8Array([0,2,1]),new Uint8Array([4,6,1]),new Uint8Array([1,3,1]),new Uint8Array([5,7,1]),new Uint8Array([0,1,2]),new Uint8Array([2,3,2]),new Uint8Array([4,5,2]),new Uint8Array([6,7,2])],Qt=[new Uint8Array([0,1,2,3,0]),new Uint8Array([4,5,6,7,0]),new Uint8Array([0,4,1,5,1]),new Uint8Array([2,6,3,7,1]),new Uint8Array([0,2,4,6,2]),new Uint8Array([1,3,5,7,2])],Jt=[[new Uint8Array([4,0,0]),new Uint8Array([5,1,0]),new Uint8Array([6,2,0]),new Uint8Array([7,3,0])],[new Uint8Array([2,0,1]),new Uint8Array([6,4,1]),new Uint8Array([3,1,1]),new Uint8Array([7,5,1])],[new Uint8Array([1,0,2]),new Uint8Array([3,2,2]),new Uint8Array([5,4,2]),new Uint8Array([7,6,2])]],Kt=[[new Uint8Array([1,4,0,5,1,1]),new Uint8Array([1,6,2,7,3,1]),new Uint8Array([0,4,6,0,2,2]),new Uint8Array([0,5,7,1,3,2])],[new Uint8Array([0,2,3,0,1,0]),new Uint8Array([0,6,7,4,5,0]),new Uint8Array([1,2,0,6,4,2]),new Uint8Array([1,3,1,7,5,2])],[new Uint8Array([1,1,0,3,2,0]),new Uint8Array([1,5,4,7,6,0]),new Uint8Array([0,1,5,0,4,1]),new Uint8Array([0,3,7,2,6,1])]],Wt=[[new Uint8Array([3,2,1,0,0]),new Uint8Array([7,6,5,4,0])],[new Uint8Array([5,1,4,0,1]),new Uint8Array([7,3,6,2,1])],[new Uint8Array([6,4,2,0,2]),new Uint8Array([7,5,3,1,2])]],$t=[new Uint8Array([3,2,1,0]),new Uint8Array([7,5,6,4]),new Uint8Array([11,10,9,8])],te=Math.pow(2,16)-1,ee=function(){function t(){D(this,t)}return E(t,null,[{key:"run",value:function(t,e,n){var i=[],r=new Ht(t,e,n),s=r.voxelCount,o=null,a=null,u=null,l=null;return s>te?console.warn("Could not create geometry for cell at position",r.min,"(vertex count of",s,"exceeds limit of ",te,")"):s>0&&(u=new Float32Array(3*s),l=new Float32Array(3*s),A(r.root,u,l,0),z(r.root,i),a=new Uint16Array(i),o=new Gt(a,u,l)),o}}]),t}(),ne={EXTRACT:"worker.extract",MODIFY:"worker.modify",RESAMPLE:"worker.resample",CONFIGURE:"worker.config",CLOSE:"worker.close"},ie=function(t){function e(){D(this,e);var t=N(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,ne.EXTRACT));return t.isosurface=null,t}return T(e,St),e}(),re=function(){function t(){D(this,t),this.data=new Mt(!1),this.response=null,this.transferList=null}return E(t,[{key:"process",value:function(t){}}]),t}(),se=function(t){function e(){D(this,e);var t=N(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return t.response=new ie,t}return T(e,re),E(e,[{key:"process",value:function(t){var e=this.data.deserialize(t.data).decompress(),n=ee.run(t.cellPosition,t.cellSize,e),i=this.response,r=[];null!==n?(i.isosurface=n,r.push(n.indices.buffer),r.push(n.positions.buffer),r.push(n.normals.buffer)):i.isosurface=null,i.data=e.deserialize(t.data).serialize(),this.transferList=e.createTransferList(r)}}]),e}(),oe={UNION:"csg.union",DIFFERENCE:"csg.difference",INTERSECTION:"csg.intersection",DENSITY_FUNCTION:"csg.densityfunction"},ae=function(){function t(e){D(this,t),this.type=e;for(var n=arguments.length,i=Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];this.children=i,this.bbox=null}return E(t,[{key:"computeBoundingBox",value:function(){var t=this.children,e=void 0,n=void 0;for(this.bbox=new V,e=0,n=t.length;e<n;++e)this.bbox.union(t[e].boundingBox);return this.bbox}},{key:"boundingBox",get:function(){return null!==this.bbox?this.bbox:this.computeBoundingBox()}}]),t}(),ue=function(t){function e(){var t;D(this,e);for(var n=arguments.length,i=Array(n),r=0;r<n;r++)i[r]=arguments[r];return N(this,(t=e.__proto__||Object.getPrototypeOf(e)).call.apply(t,[this,oe.UNION].concat(i)))}return T(e,ae),E(e,[{key:"updateMaterialIndex",value:function(t,e,n){var i=n.materialIndices[t];i!==L.AIR&&e.setMaterialIndex(t,i)}},{key:"selectEdge",value:function(t,e,n){return n?t.t>e.t?t:e:t.t<e.t?t:e}}]),e}(),le=function(t){function e(){var t;D(this,e);for(var n=arguments.length,i=Array(n),r=0;r<n;r++)i[r]=arguments[r];return N(this,(t=e.__proto__||Object.getPrototypeOf(e)).call.apply(t,[this,oe.DIFFERENCE].concat(i)))}return T(e,ae),E(e,[{key:"updateMaterialIndex",value:function(t,e,n){n.materialIndices[t]!==L.AIR&&e.setMaterialIndex(t,L.AIR)}},{key:"selectEdge",value:function(t,e,n){return n?t.t<e.t?t:e:t.t>e.t?t:e}}]),e}(),he=function(t){function e(){var t;D(this,e);for(var n=arguments.length,i=Array(n),r=0;r<n;r++)i[r]=arguments[r];return N(this,(t=e.__proto__||Object.getPrototypeOf(e)).call.apply(t,[this,oe.INTERSECTION].concat(i)))}return T(e,ae),E(e,[{key:"updateMaterialIndex",value:function(t,e,n){var i=n.materialIndices[t];e.setMaterialIndex(t,e.materialIndices[t]!==L.AIR&&i!==L.AIR?i:L.AIR)}},{key:"selectEdge",value:function(t,e,n){return n?t.t<e.t?t:e:t.t>e.t?t:e}}]),e}(),ce=0,de=new q,ye=function(){function t(){D(this,t)}return E(t,null,[{key:"run",value:function(t,e,n,i){de.fromArray(t),ce=e,null===n?i.operation===oe.UNION&&(n=new Mt(!1)):n.decompress();var r=i.toCSG(),s=null!==n?C(r):null;if(null!==s){switch(i.operation){case oe.UNION:r=new ue(r);break;case oe.DIFFERENCE:r=new le(r);break;case oe.INTERSECTION:r=new he(r)}_(r,n,s),n.contoured=!1}return null!==n&&(n.empty?n=null:n.compress()),n}}]),t}(),ve={SPHERE:"sdf.sphere",BOX:"sdf.box",TORUS:"sdf.torus",PLANE:"sdf.plane",HEIGHTFIELD:"sdf.heightfield"},fe=function(t){function e(t){D(this,e);var n=N(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,oe.DENSITY_FUNCTION));return n.sdf=t,n}return T(e,ae),E(e,[{key:"computeBoundingBox",value:function(){return this.bbox=this.sdf.computeBoundingBox(),this.bbox}},{key:"generateMaterialIndex",value:function(t){return this.sdf.sample(t)<=0?this.sdf.material:L.AIR}},{key:"generateEdge",value:function(t){t.approximateZeroCrossing(this.sdf),t.computeSurfaceNormal(this.sdf)}}]),e}(),me=function(){function t(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:L.SOLID;D(this,t),this.type=e,this.operation=null,this.material=Math.min(255,Math.max(L.SOLID,Math.trunc(n))),this.children=[],this.bbox=null}return E(t,[{key:"union",value:function(t){return t.operation=oe.UNION,this.children.push(t),this}},{key:"subtract",value:function(t){return t.operation=oe.DIFFERENCE,this.children.push(t),this}},{key:"intersect",value:function(t){return t.operation=oe.INTERSECTION,this.children.push(t),this}},{key:"serialize",value:function(){var t={type:this.type,operation:this.operation,material:this.material,parameters:null,children:[]},e=this.children,n=void 0,i=void 0;for(n=0,i=e.length;n<i;++n)t.children.push(e[n].serialize());return t}},{key:"toCSG",value:function(){var t=this.children,e=new fe(this),n=void 0,i=void 0,r=void 0,s=void 0;for(r=0,s=t.length;r<s;++r){if(i=t[r],n!==i.operation)switch(n=i.operation){case oe.UNION:e=new ue(e);break;case oe.DIFFERENCE:e=new le(e);break;case oe.INTERSECTION:e=new he(e)}e.children.push(i.toCSG())}return e}},{key:"computeBoundingBox",value:function(){throw new Error("SignedDistanceFunction#computeBoundingBox method not implemented!")}},{key:"sample",value:function(t){throw new Error("SignedDistanceFunction#sample method not implemented!")}},{key:"boundingBox",get:function(){return null!==this.bbox?this.bbox:this.computeBoundingBox()}},{key:"completeBoundingBox",get:function(){var t=this.children,e=this.boundingBox.clone(),n=void 0,i=void 0;for(n=0,i=t.length;n<i;++n)e.union(t[n].completeBoundingBox);return e}}]),t}(),pe=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments[1];D(this,e);var i=N(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,ve.SPHERE,n));return i.origin=new(Function.prototype.bind.apply(q,[null].concat(R(t.origin)))),i.radius=t.radius,i}return T(e,me),E(e,[{key:"computeBoundingBox",value:function(){return this.bbox=new V,this.bbox.min.copy(this.origin).subScalar(this.radius),this.bbox.max.copy(this.origin).addScalar(this.radius),this.bbox}},{key:"sample",value:function(t){var e=this.origin,n=t.x-e.x,i=t.y-e.y,r=t.z-e.z;return Math.sqrt(n*n+i*i+r*r)-this.radius}},{key:"serialize",value:function(){var t=P(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"serialise",this).call(this);return t.parameters={origin:this.origin.toArray(),radius:this.radius},t}}]),e}(),xe=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments[1];D(this,e);var i=N(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,ve.BOX,n));return i.origin=new(Function.prototype.bind.apply(q,[null].concat(R(t.origin)))),i.halfDimensions=new(Function.prototype.bind.apply(q,[null].concat(R(t.halfDimensions)))),i}return T(e,me),E(e,[{key:"computeBoundingBox",value:function(){return this.bbox=new V,this.bbox.min.subVectors(this.origin,this.halfDimensions),this.bbox.max.addVectors(this.origin,this.halfDimensions),this.bbox}},{key:"sample",value:function(t){var e=this.origin,n=this.halfDimensions,i=Math.abs(t.x-e.x)-n.x,r=Math.abs(t.y-e.y)-n.y,s=Math.abs(t.z-e.z)-n.z,o=Math.max(i,Math.max(r,s)),a=Math.max(i,0),u=Math.max(r,0),l=Math.max(s,0),h=Math.sqrt(a*a+u*u+l*l);return Math.min(o,0)+h}},{key:"serialize",value:function(){var t=P(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"serialise",this).call(this);return t.parameters={origin:this.origin.toArray(),halfDimensions:this.halfDimensions.toArray()},t}}]),e}(),ge=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments[1];D(this,e);var i=N(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,ve.PLANE,n));return i.normal=new(Function.prototype.bind.apply(q,[null].concat(R(t.normal)))),i.constant=t.constant,i}return T(e,me),E(e,[{key:"computeBoundingBox",value:function(){return this.bbox=new V,this.bbox}},{key:"sample",value:function(t){return this.normal.dot(t)+this.constant}},{key:"serialize",value:function(){var t=P(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"serialise",this).call(this);return t.parameters={normal:this.normal.toArray(),constant:this.constant},t}}]),e}(),we=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments[1];D(this,e);var i=N(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,ve.TORUS,n));return i.origin=new(Function.prototype.bind.apply(q,[null].concat(R(t.origin)))),i.R=t.R,i.r=t.r,i}return T(e,me),E(e,[{key:"computeBoundingBox",value:function(){return this.bbox=new V,this.bbox.min.copy(this.origin).subScalar(this.R).subScalar(this.r),this.bbox.max.copy(this.origin).addScalar(this.R).addScalar(this.r),this.bbox}},{key:"sample",value:function(t){var e=this.origin,n=t.x-e.x,i=t.y-e.y,r=t.z-e.z,s=Math.sqrt(n*n+r*r)-this.R;return Math.sqrt(s*s+i*i)-this.r}},{key:"serialize",value:function(){var t=P(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"serialise",this).call(this);return t.parameters={origin:this.origin.toArray(),R:this.R,r:this.r},t}}]),e}(),ke=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments[1];D(this,e);var i=N(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,ve.HEIGHTFIELD,n));return i.min=new(Function.prototype.bind.apply(q,[null].concat(R(t.min)))),i.dimensions=new(Function.prototype.bind.apply(q,[null].concat(R(t.size)))),i.data=t.data,i}return T(e,me),E(e,[{key:"computeBoundingBox",value:function(){return this.bbox=new V,this.bbox.min.copy(this.min),this.bbox.max.addVectors(this.min,this.dimensions),this.bbox}},{key:"sample",value:function(t){var e=this.min,n=this.dimensions,i=Math.max(e.x,Math.min(e.x+n.x,t.x-e.x)),r=Math.max(e.z,Math.min(e.z+n.z,t.z-e.z));return t.y-e.y-this.data[r*n.x+i]/255*n.y}},{key:"serialize",value:function(){var t=P(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"serialise",this).call(this);return t.parameters={min:this.min.toArray(),dimensions:this.dimensions.toArray(),data:this.data},t}}]),e}(),be=function(){function t(){D(this,t)}return E(t,null,[{key:"reviveSDF",value:function(t){var e=void 0,n=void 0,i=void 0;switch(t.type){case ve.SPHERE:e=new pe(t.parameters,t.material);break;case ve.BOX:e=new xe(t.parameters,t.material);break;case ve.TORUS:e=new we(t.parameters,t.material);break;case ve.PLANE:e=new ge(t.parameters,t.material);break;case ve.HEIGHTFIELD:e=new ke(t.parameters,t.material)}for(e.operation=t.operation,n=0,i=t.children.length;n<i;++n)e.children.push(this.reviveSDF(t.children[n]));return e}}]),t}(),ze=function(t){function e(){return D(this,e),N(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,ne.MODIFY))}return T(e,St),e}(),Ae=function(t){function e(){D(this,e);var t=N(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return t.response=new ze,t}return T(e,re),E(e,[{key:"process",value:function(t){var e=null!==t.data?this.data.deserialize(t.data):null,n=ye.run(t.cellSize,t.cellPosition,e,be.reviveSDF(t.sdf));this.response.data=null,this.transferList=[],null!==n&&(this.response.data=n.serialize(),n.createTransferList(this.transferList))}}]),e}(),Ue=new se,Ie=new Ae;self.addEventListener("message",function(t){var e=t.data;switch(e.action){case ne.EXTRACT:Ue.process(e),postMessage(Ue.response,Ue.transferList);break;case ne.MODIFY:Ie.process(e),postMessage(Ie.response,Ie.transferList);break;case ne.RESAMPLE:break;case ne.CONFIGURE:Mt.resolution=e.resolution;break;case ne.CLOSE:default:close()}}),self.addEventListener("error",function(t){var e=[],n=new St(ne.CLOSE);n.error=t;var i=null===Ue.data||Ue.data.neutered?null===Ie.data||Ie.data.neutered?null:Ie.data:Ue.data;null!==i&&(n.data=i.serialize(),i.createTransferList(e)),postMessage(n,e),close()})}();',ft=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:navigator.hardwareConcurrency;P(this,e);var n=U(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return n.workerURL=URL.createObjectURL(new Blob([yt],{type:"text/javascript"})),n.maxWorkers=Math.min(navigator.hardwareConcurrency,Math.max(t,1)),n.workers=[],n.busyWorkers=new WeakSet,n}return C(e,V),I(e,[{key:"handleEvent",value:function(t){switch(t.type){case"message":this.busyWorkers.delete(t.target),vt.worker=t.target,vt.response=t.data,this.dispatchEvent(vt);break;case"error":console.error("Encountered an unexpected error.",t)}}},{key:"closeWorker",value:function(t){var e=this.workers.indexOf(t);this.busyWorkers.has(t)?(this.busyWorkers.delete(t),t.terminate()):t.postMessage(new dt(ct.CLOSE)),t.removeEventListener("message",this),t.removeEventListener("error",this),e>=0&&this.workers.splice(e,1)}},{key:"createWorker",value:function(){var t=new Worker(this.workerURL);return this.workers.push(t),t.addEventListener("message",this),t.addEventListener("error",this),t}},{key:"getWorker",value:function(){var t=null,e=void 0,n=void 0;for(e=0,n=this.workers.length;e<n;++e)if(!this.busyWorkers.has(this.workers[e])){t=this.workers[e],this.busyWorkers.add(t);break}return null===t&&this.workers.length<this.maxWorkers&&null!==this.workerURL&&(t=this.createWorker(),this.busyWorkers.add(t)),t}},{key:"clear",value:function(){for(;this.workers.length>0;)this.closeWorker(this.workers.pop())}},{key:"dispose",value:function(){this.clear(),URL.revokeObjectURL(this.workerURL),this.workerURL=null}}]),e}(),mt=function(t){function e(t){P(this,e);var n=U(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));return n.octant=null,n}return C(e,q),e}(),pt=new mt("modificationstart"),gt=new mt("modificationend"),xt=new mt("extractionstart"),wt=new mt("extractionend"),kt=(new t.Box3,new t.Matrix4,function(e){function n(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};P(this,n);var i=U(this,(n.__proto__||Object.getPrototypeOf(n)).call(this));return i.object=new t.Object3D,i.object.name="Terrain",i.clipmap=new N,i.levels=void 0!==e.levels?Math.max(1,e.levels):16,i.iterations=void 0!==e.iterations?Math.max(1,e.iterations):1e3,i.threadPool=new ft(e.workers),i.threadPool.addEventListener("message",i),i.history=new T,i.octantIDs=new WeakSet,i.material=new X,i}C(n,V),I(n,[{key:"handleEvent",value:function(t){var e=t.worker,n=t.response,i=this.octantIDs.get(e),r=this.world.getOctant(i.key,i.lod);this.octantIDs.delete(e),r.data=r.data.deserialise(n.data),null===r.data&&null===r.csg?this.world.removeOctant(i.key,i.lod):r.csg,n.action!==ct.CLOSE?(n.action===ct.EXTRACT?(t=wt,this.consolidate(r,n)):t=gt,t.octant=r,this.dispatchEvent(t)):console.error(n.error)}},{key:"consolidate",value:function(e,n){var i=n.isosurface,r=i.positions,s=i.normals,a=i.indices,o=void 0;null!==r&&null!==s&&null!==a&&((o=new t.BufferGeometry).setIndex(new t.BufferAttribute(a,1)),o.addAttribute("position",new t.BufferAttribute(r,3)),o.addAttribute("normal",new t.BufferAttribute(s,3)),o.computeBoundingSphere(),this.object.add(new t.Mesh(o,this.material)))}},{key:"runNextTask",value:function(){var t=void 0,e=void 0,n=void 0,i=void 0;null!==this.scheduler.peek()&&null!==(e=this.threadPool.getWorker())&&(n=(t=this.scheduler.poll()).chunk,t.action===ct.MODIFY?(i=pt,e.postMessage({action:t.action,chunk:n.serialise(),sdf:n.csg.poll().serialise()},n.createTransferList()),0===n.csg.size&&(n.csg=null)):(i=xt,e.postMessage({action:t.action,chunk:n.serialise()},n.createTransferList())),i.chunk=n,this.neutered.add(n),this.chunks.set(e,n),this.dispatchEvent(i))}},{key:"edit",value:function(t){}},{key:"union",value:function(t){t.operation=L.UNION,this.edit(t)}},{key:"subtract",value:function(t){t.operation=L.DIFFERENCE,this.edit(t)}},{key:"intersect",value:function(t){t.operation=L.INTERSECTION,this.edit(t)}},{key:"update",value:function(t){var e=this.clipmap;e.scene;e.update()}},{key:"raycast",value:function(t){var e=[],n=[],i=void 0,r=void 0,s=void 0;for(this.world.raycast(t,e),r=0,s=i.length;r<s;++r)null!==(i=i[r]).mesh&&(n=n.concat(t.intersectObject(i.mesh)));return n}},{key:"clearMeshes",value:function(){for(var t=this.object,e=void 0;t.children.length>0;)(e=t.children[0]).geometry.dispose(),e.material.dispose(),t.remove(e)}},{key:"clear",value:function(){this.clearMeshes(),this.clipmap=new N(this.clipmap.cellSize),this.octantIds=new WeakMap,this.threadPool.clear(),this.history.clear()}},{key:"dispose",value:function(){this.clearMeshes(),this.threadPool.dispose()}},{key:"save",value:function(){var t=this.history.combine();return null===t?null:URL.createObjectURL(new Blob([JSON.stringify(t.serialise())],{type:"text/json"}))}},{key:"load",value:function(t){this.clear(),this.edit(ht.reviveSDF(JSON.parse(t)))}},{key:"world",get:function(){return this.clipmap.world}}])}(),function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;P(this,t),this.runLengths=e,this.data=n}return I(t,null,[{key:"encode",value:function(e){var n=[],i=[],r=e[0],s=1,a=void 0,o=void 0;for(a=1,o=e.length;a<o;++a)r!==e[a]?(n.push(s),i.push(r),r=e[a],s=1):++s;return n.push(s),i.push(r),new t(n,i)}},{key:"decode",value:function(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],i=void 0,r=void 0,s=void 0,a=void 0,o=void 0,l=0;for(r=0,a=e.length;r<a;++r)for(i=e[r],s=0,o=t[r];s<o;++s)n[l++]=i;return n}}]),t}()),bt=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,n=arguments.length>1&&void 0!==arguments[1]&&arguments[1];P(this,t),this.value=e,this.done=n}return I(t,[{key:"reset",value:function(){this.value=null,this.done=!1}}]),t}(),zt=new H,_t=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new H,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new H;P(this,t),this.min=e,this.max=n,this.children=null}return I(t,[{key:"getCenter",value:function(){return(arguments.length>0&&void 0!==arguments[0]?arguments[0]:new H).copy(this.min).add(this.max).multiplyScalar(.5)}},{key:"getDimensions",value:function(){return(arguments.length>0&&void 0!==arguments[0]?arguments[0]:new H).copy(this.max).sub(this.min)}},{key:"split",value:function(){var t=this.min,e=this.max,n=this.getCenter(zt),i=this.children=[null,null,null,null,null,null,null,null],r=void 0,s=void 0;for(r=0;r<8;++r)s=Mt[r],i[r]=new this.constructor(new H(0===s[0]?t.x:n.x,0===s[1]?t.y:n.y,0===s[2]?t.z:n.z),new H(0===s[0]?n.x:e.x,0===s[1]?n.y:e.y,0===s[2]?n.z:e.z))}}]),t}(),Mt=[new Uint8Array([0,0,0]),new Uint8Array([0,0,1]),new Uint8Array([0,1,0]),new Uint8Array([0,1,1]),new Uint8Array([1,0,0]),new Uint8Array([1,0,1]),new Uint8Array([1,1,0]),new Uint8Array([1,1,1])],At=[new Uint8Array([0,4]),new Uint8Array([1,5]),new Uint8Array([2,6]),new Uint8Array([3,7]),new Uint8Array([0,2]),new Uint8Array([1,3]),new Uint8Array([4,6]),new Uint8Array([5,7]),new Uint8Array([0,1]),new Uint8Array([2,3]),new Uint8Array([4,5]),new Uint8Array([6,7])],Et=new H,St=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new H,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;P(this,t),this.min=e,this.size=n,this.children=null}return I(t,[{key:"getCenter",value:function(){return(arguments.length>0&&void 0!==arguments[0]?arguments[0]:new H).copy(this.min).addScalar(.5*this.size)}},{key:"getDimensions",value:function(){return(arguments.length>0&&void 0!==arguments[0]?arguments[0]:new H).set(this.size,this.size,this.size)}},{key:"split",value:function(){var t=this.min,e=this.getCenter(Et),n=.5*this.size,i=this.children=[null,null,null,null,null,null,null,null],r=void 0,s=void 0;for(r=0;r<8;++r)s=Mt[r],i[r]=new this.constructor(new H(0===s[0]?t.x:e.x,0===s[1]?t.y:e.y,0===s[2]?t.z:e.z),n)}},{key:"max",get:function(){return this.min.clone().addScalar(this.size)}}]),t}(),Dt=new W,Pt=function(){function t(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;P(this,t),this.octree=e,this.region=n,this.cull=null!==n,this.result=new bt,this.trace=null,this.indices=null,this.reset()}return I(t,[{key:"reset",value:function(){var t=this.octree.root;return this.trace=[],this.indices=[],null!==t&&(Dt.min=t.min,Dt.max=t.max,this.cull&&!this.region.intersectsBox(Dt)||(this.trace.push(t),this.indices.push(0))),this.result.reset(),this}},{key:"next",value:function(){for(var t=this.cull,e=this.region,n=this.indices,i=this.trace,r=null,s=i.length-1,a=void 0,o=void 0,l=void 0;null===r&&s>=0;)if(a=n[s],o=i[s].children,++n[s],a<8)if(null!==o){if(l=o[a],t&&(Dt.min=l.min,Dt.max=l.max,!e.intersectsBox(Dt)))continue;i.push(l),n.push(0),++s}else r=i.pop(),n.pop();else i.pop(),n.pop(),--s;return this.result.value=r,this.result.done=null===r,this.result}},{key:"return",value:function(t){return this.result.value=t,this.result.done=!0,this.result}},{key:Symbol.iterator,value:function(){return this}}]),t}(),It=new Uint8Array([0,1,2,3,4,5,6,7,0]),Ot=[new Uint8Array([4,2,1]),new Uint8Array([5,3,8]),new Uint8Array([6,8,3]),new Uint8Array([7,8,8]),new Uint8Array([8,6,5]),new Uint8Array([8,7,8]),new Uint8Array([8,8,7]),new Uint8Array([8,8,8])],Ct=new H,Ut=new H,Rt=new H,Nt=new H,Lt=new H,Tt=new H,Bt=new H,Ft=function(){function t(){P(this,t)}return I(t,null,[{key:"intersectOctree",value:function(t,e,n){var i=void 0,r=void 0,a=void 0,o=void 0,l=void 0,u=void 0,h=void 0,c=void 0,d=void 0;t.getDimensions(Ct),Ut.copy(Ct).multiplyScalar(.5),Nt.copy(t.min).sub(t.min),Lt.copy(t.max).sub(t.min),Tt.copy(e.ray.direction),Bt.copy(e.ray.origin),Bt.sub(t.getCenter(Rt)).add(Ut),It[8]=It[0],Tt.x<0&&(Bt.x=Ct.x-Bt.x,Tt.x=-Tt.x,It[8]|=It[4]),Tt.y<0&&(Bt.y=Ct.y-Bt.y,Tt.y=-Tt.y,It[8]|=It[2]),Tt.z<0&&(Bt.z=Ct.z-Bt.z,Tt.z=-Tt.z,It[8]|=It[1]),i=1/Tt.x,r=1/Tt.y,a=1/Tt.z,o=(Nt.x-Bt.x)*i,l=(Lt.x-Bt.x)*i,u=(Nt.y-Bt.y)*r,h=(Lt.y-Bt.y)*r,c=(Nt.z-Bt.z)*a,d=(Lt.z-Bt.z)*a,Math.max(Math.max(o,u),c)<Math.min(Math.min(l,h),d)&&s(t.root,o,u,c,l,h,d,e,n)}}]),t}(),qt=new W,Vt=function(){function t(e,n){P(this,t),this.root=void 0!==e&&void 0!==n?new _t(e,n):null}return I(t,[{key:"getCenter",value:function(t){return this.root.getCenter(t)}},{key:"getDimensions",value:function(t){return this.root.getDimensions(t)}},{key:"getDepth",value:function(){return a(this.root)}},{key:"cull",value:function(t){var e=[];return o(this.root,t,e),e}},{key:"findOctantsByLevel",value:function(t){var e=[];return l(this.root,t,0,e),e}},{key:"raycast",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];return Ft.intersectOctree(this,t,e),e}},{key:"leaves",value:function(t){return new Pt(this,t)}},{key:Symbol.iterator,value:function(){return new Pt(this)}},{key:"min",get:function(){return this.root.min}},{key:"max",get:function(){return this.root.max}},{key:"children",get:function(){return this.root.children}}]),t}(),jt=new H,Yt=function(t){function e(t,n){P(this,e);var i=U(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n));return i.points=null,i.data=null,i}return C(e,_t),I(e,[{key:"distanceToSquared",value:function(t){return jt.copy(t).clamp(this.min,this.max).sub(t).lengthSq()}},{key:"distanceToCenterSquared",value:function(t){var e=this.getCenter(jt),n=t.x-e.x,i=t.y-e.x,r=t.z-e.z;return n*n+i*i+r*r}},{key:"contains",value:function(t,e){var n=this.min,i=this.max;return t.x>=n.x-e&&t.y>=n.y-e&&t.z>=n.z-e&&t.x<=i.x+e&&t.y<=i.y+e&&t.z<=i.z+e}},{key:"redistribute",value:function(t){var e=this.children,n=this.points,i=this.data,r=void 0,s=void 0,a=void 0,o=void 0,l=void 0,u=void 0,h=void 0;if(null!==e)for(r=0,a=n.length;r<a;++r)for(u=n[r],h=i[r],s=0,o=e.length;s<o;++s)if((l=e[s]).contains(u,t)){null===l.points&&(l.points=[],l.data=[]),l.points.push(u),l.data.push(h);break}this.points=null,this.data=null}},{key:"merge",value:function(){var t=this.children,e=void 0,n=void 0,i=void 0;if(null!==t){for(this.points=[],this.data=[],e=0,n=t.length;e<n;++e)if(null!==(i=t[e]).points){var r,s;(r=this.points).push.apply(r,R(i.points)),(s=this.data).push.apply(s,R(i.data))}this.children=null}}}]),e}(),Xt=function t(e,n,i){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;P(this,t),this.distance=e,this.distanceToRay=n,this.point=i,this.object=r},Zt=1e-6,Gt=(function(t){function e(t,n){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:8,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:8;P(this,e);var a=U(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return a.root=new Yt(t,n),a.bias=Math.max(0,i),a.maxPoints=Math.max(1,Math.round(r)),a.maxDepth=Math.max(0,Math.round(s)),a.pointCount=0,a}C(e,Vt),I(e,[{key:"countPoints",value:function(t){return u(t)}},{key:"put",value:function(t,e){return h(t,e,this,this.root,0)}},{key:"remove",value:function(t){return c(t,this,this.root,null)}},{key:"fetch",value:function(t){return d(t,this,this.root)}},{key:"move",value:function(t,e){return v(t,e,this,this.root,null,0)}},{key:"findNearestPoint",value:function(t){return y(t,arguments.length>1&&void 0!==arguments[1]?arguments[1]:1/0,arguments.length>2&&void 0!==arguments[2]&&arguments[2],this.root)}},{key:"findPoints",value:function(t,e){var n=[];return f(t,e,arguments.length>2&&void 0!==arguments[2]&&arguments[2],this.root,n),n}},{key:"raycast",value:function(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],i=O(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"raycast",this).call(this,t);return i.length>0&&this.testPoints(i,t,n),n}},{key:"testPoints",value:function(t,e,n){var i=e.params.Points.threshold,r=i*i,s=void 0,a=void 0,o=void 0,l=void 0,u=void 0,h=void 0,c=void 0,d=void 0,v=void 0,y=void 0,f=void 0;for(u=0,c=t.length;u<c;++u)if(v=t[u],null!==(y=v.points))for(h=0,d=y.length;h<d;++h)f=y[h],(l=e.ray.distanceSqToPoint(f))<r&&(s=e.ray.closestPointToPoint(f),(a=e.ray.origin.distanceTo(s))>=e.near&&a<=e.far&&(o=Math.sqrt(l),n.push(new Xt(a,o,s,v.data[h]))))}}])}(),function(){function t(){P(this,t)}I(t,null,[{key:"recycleOctants",value:function(t,e){var n=new H,i=new H,r=new H,s=t.min,a=t.getCenter(),o=t.getDimensions().multiplyScalar(.5),l=t.children,u=e.length,h=void 0,c=void 0,d=void 0,v=void 0;for(h=0;h<8;++h)for(d=Mt[h],i.addVectors(s,n.fromArray(d).multiply(o)),r.addVectors(a,n.fromArray(d).multiply(o)),c=0;c<u;++c)if(null!==(v=e[c])&&i.equals(v.min)&&r.equals(v.max)){l[h]=v,e[c]=null;break}}}])}(),new H),Ht=new H,Wt=new H,Qt=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new H,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new H;P(this,t),this.a=e,this.b=n,this.index=-1,this.coordinates=new H,this.t=0,this.n=new H}return I(t,[{key:"approximateZeroCrossing",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:8,n=Math.max(1,e-1),i=0,r=1,s=0,a=0,o=void 0,l=void 0;for(Gt.subVectors(this.b,this.a);a<=n&&(s=(i+r)/2,Ht.addVectors(this.a,Wt.copy(Gt).multiplyScalar(s)),l=t.sample(Ht),!(Math.abs(l)<=1e-4||(r-i)/2<=1e-6));)Ht.addVectors(this.a,Wt.copy(Gt).multiplyScalar(i)),o=t.sample(Ht),Math.sign(l)===Math.sign(o)?i=s:r=s,++a;this.t=s}},{key:"computeZeroCrossingPosition",value:function(){return(arguments.length>0&&void 0!==arguments[0]?arguments[0]:new H).subVectors(this.b,this.a).multiplyScalar(this.t).add(this.a)}},{key:"computeSurfaceNormal",value:function(t){var e=this.computeZeroCrossingPosition(Gt),n=.001,i=t.sample(Ht.addVectors(e,Wt.set(n,0,0)))-t.sample(Ht.subVectors(e,Wt.set(n,0,0))),r=t.sample(Ht.addVectors(e,Wt.set(0,n,0)))-t.sample(Ht.subVectors(e,Wt.set(0,n,0))),s=t.sample(Ht.addVectors(e,Wt.set(0,0,n)))-t.sample(Ht.subVectors(e,Wt.set(0,0,n)));this.n.set(i,r,s).normalize()}}]),t}(),Kt=new Qt,Jt=new H,$t=new H,te=function(){function t(e,n,i){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:3;P(this,t),this.edgeData=e,this.cellPosition=n,this.cellSize=i,this.indices=null,this.zeroCrossings=null,this.normals=null,this.axes=null,this.lengths=null,this.result=new bt,this.initialC=r,this.c=r,this.initialD=s,this.d=s,this.i=0,this.l=0,this.reset()}return I(t,[{key:"reset",value:function(){var t=this.edgeData,e=[],n=[],i=[],r=[],s=[],a=void 0,o=void 0,l=void 0,u=void 0;for(this.i=0,this.c=0,this.d=0,a=4>>(o=this.initialC),l=this.initialD;o<l;++o,a>>=1)(u=t.indices[o].length)>0&&(e.push(t.indices[o]),n.push(t.zeroCrossings[o]),i.push(t.normals[o]),r.push(Mt[a]),s.push(u),++this.d);return this.l=s.length>0?s[0]:0,this.indices=e,this.zeroCrossings=n,this.normals=i,this.axes=r,this.lengths=s,this.result.reset(),this}},{key:"next",value:function(){var t=this.cellSize,e=re.resolution,n=e+1,i=n*n,r=this.result,s=this.cellPosition,a=void 0,o=void 0,l=void 0,u=void 0,h=void 0,c=void 0,d=void 0;return this.i===this.l&&(this.l=++this.c<this.d?this.lengths[this.c]:0,this.i=0),this.i<this.l?(c=this.c,d=this.i,a=this.axes[c],o=this.indices[c][d],Kt.index=o,l=o%n,u=Math.trunc(o%i/n),h=Math.trunc(o/i),Kt.coordinates.set(l,u,h),Jt.set(l*t/e,u*t/e,h*t/e),$t.set((l+a[0])*t/e,(u+a[1])*t/e,(h+a[2])*t/e),Kt.a.addVectors(s,Jt),Kt.b.addVectors(s,$t),Kt.t=this.zeroCrossings[c][d],Kt.n.fromArray(this.normals[c],3*d),r.value=Kt,++this.i):(r.value=null,r.done=!0),r}},{key:"return",value:function(t){return this.result.value=t,this.result.done=!0,this.result}},{key:Symbol.iterator,value:function(){return this}}]),t}(),ee=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e;P(this,t),this.indices=e<=0?null:[new Uint32Array(e),new Uint32Array(n),new Uint32Array(i)],this.zeroCrossings=e<=0?null:[new Float32Array(e),new Float32Array(n),new Float32Array(i)],this.normals=e<=0?null:[new Float32Array(3*e),new Float32Array(3*n),new Float32Array(3*i)]}return I(t,[{key:"serialize",value:function(){return{edges:this.edges,zeroCrossings:this.zeroCrossings,normals:this.normals}}},{key:"deserialize",value:function(t){var e=this;return null!==t?(this.edges=t.edges,this.zeroCrossings=t.zeroCrossings,this.normals=t.normals):e=null,e}},{key:"createTransferList",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],e=[this.edges[0],this.edges[1],this.edges[2],this.zeroCrossings[0],this.zeroCrossings[1],this.zeroCrossings[2],this.normals[0],this.normals[1],this.normals[2]],n=void 0,i=void 0,r=void 0;for(i=0,r=e.length;i<r;++i)null!==(n=e[i])&&t.push(n.buffer);return t}},{key:"edges",value:function(t,e){return new te(this,t,e)}},{key:"edgesX",value:function(t,e){return new te(this,t,e,0,1)}},{key:"edgesY",value:function(t,e){return new te(this,t,e,1,2)}},{key:"edgesZ",value:function(t,e){return new te(this,t,e,2,3)}}],[{key:"calculate1DEdgeCount",value:function(t){return Math.pow(t+1,2)*t}}]),t}(),ne=0,ie=0,re=function(){function t(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];P(this,t),this.lod=-1,this.neutered=!1,this.materials=0,this.materialIndices=e?new Uint8Array(ie):null,this.runLengths=null,this.edgeData=null}return I(t,[{key:"set",value:function(t){return this.lod=t.lod,this.neutered=t.neutered,this.materials=t.materials,this.materialIndices=t.materialIndices,this.runLengths=t.runLengths,this.edgeData=t.edgeData,this}},{key:"clear",value:function(){return this.lod=-1,this.neutered=!1,this.materials=0,this.materialIndices=null,this.runLengths=null,this.edgeData=null,this}},{key:"setMaterialIndex",value:function(t,e){this.materialIndices[t]===J.AIR?e!==J.AIR&&++this.materials:e===J.AIR&&--this.materials,this.materialIndices[t]=e}},{key:"compress",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this,e=void 0;return this.compressed||(e=this.full?new kt([this.materialIndices.length],[J.SOLID]):kt.encode(this.materialIndices),t.runLengths=new Uint32Array(e.runLengths),t.materialIndices=new Uint8Array(e.data)),t}},{key:"decompress",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this;return this.compressed&&(t.materialIndices=kt.decode(this.runLengths,this.materialIndices,new Uint8Array(ie)),t.runLengths=null),t}},{key:"serialize",value:function(){return this.neutered=!0,{lod:this.lod,materials:this.materials,materialIndices:this.materialIndices,runLengths:this.runLengths,edgeData:null!==this.edgeData?this.edgeData.serialize():null}}},{key:"deserialize",value:function(t){var e=this;return null!==t?(this.lod=t.lod,this.materials=t.materials,this.materialIndices=t.materialIndices,this.runLengths=t.runLengths,null!==t.edgeData?(null===this.edgeData&&(this.edgeData=new ee(0)),this.edgeData.deserialize(t.edgeData)):this.edgeData=null,this.neutered=!1):e=null,e}},{key:"createTransferList",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];return null!==this.edgeData&&this.edgeData.createTransferList(t),t.push(this.materialIndices.buffer),t.push(this.runLengths.buffer),t}},{key:"empty",get:function(){return 0===this.materials}},{key:"full",get:function(){return this.materials===ie}},{key:"compressed",get:function(){return null!==this.runLengths}}],[{key:"resolution",get:function(){return ne},set:function(t){0===ne&&(ne=Math.max(1,Math.min(256,t)),ie=Math.pow(ne+1,3))}}]),t}(),se=function(e){function n(e,i){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,s=arguments[3],a=arguments[4];P(this,n);var o=U(this,(n.__proto__||Object.getPrototypeOf(n)).call(this));return o.name="HermiteDataHelper",o.cellPosition=e,o.cellSize=i,o.data=r,o.decompressedData=new re(!1),o.pointsMaterial=new t.PointsMaterial({vertexColors:t.VertexColors,sizeAttenuation:!0,size:.05}),o.add(new t.Group),o.add(new t.Group),o.add(new t.Group),o.gridPoints.name="GridPoints",o.edges.name="Edges",o.normals.name="Normals",o.update(s,a),o}return C(n,e),I(n,[{key:"update",value:function(){var t=arguments.length>0&&void 0!==arguments[0]&&arguments[0],e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=this.data,i=this.decompressedData;this.dispose(),null!==this.cellPosition&&this.cellSize>0&&null!==n&&!n.empty&&(n.compressed?(n.decompress(i),i.edgeData=n.edgeData):i.set(n),t&&this.createPoints(i),e&&null!==i.edgeData&&this.createEdges(i),i.clear())}},{key:"createPoints",value:function(e){var n=this.cellSize,i=re.resolution,r=e.materialIndices,s=this.cellPosition,a=new t.Vector3,o=new t.Vector3,l=new Float32Array([0,0,0]),u=new t.BufferGeometry,h=e.materials,c=new Float32Array(3*h),d=new Float32Array(3*h),v=void 0,y=void 0,f=void 0,m=void 0,p=void 0;for(m=0,p=0,f=0;f<=i;++f)for(a.z=f*n/i,y=0;y<=i;++y)for(a.y=y*n/i,v=0;v<=i;++v)a.x=v*n/i,r[m++]!==J.AIR&&(o.addVectors(s,a),c[p]=o.x,d[p++]=l[0],c[p]=o.y,d[p++]=l[1],c[p]=o.z,d[p++]=l[2]);u.addAttribute("position",new t.BufferAttribute(c,3)),u.addAttribute("color",new t.BufferAttribute(d,3)),this.gridPoints.add(new t.Points(u,this.pointsMaterial))}},{key:"createEdges",value:function(e){var n=this.cellSize,i=re.resolution,r=e.edgeData,s=new t.Vector3,a=new t.Vector3,o=[r.edgesX(this.cellPosition,this.cellSize),r.edgesY(this.cellPosition,this.cellSize),r.edgesZ(this.cellPosition,this.cellSize)],l=[new Float32Array([.6,0,0]),new Float32Array([0,.6,0]),new Float32Array([0,0,.6])],u=new Float32Array([0,1,1]),h=new t.LineBasicMaterial({vertexColors:t.VertexColors}),c=void 0,d=void 0,v=void 0,y=void 0,f=void 0,m=void 0,p=void 0,g=void 0,x=void 0,w=void 0,k=void 0,b=void 0;for(k=0,b=0,w=0;w<3;++w,k=0,b=0)if(m=l[w],(g=o[w]).lengths.length>0){f=2*g.lengths[0],c=new Float32Array(3*f),d=new Float32Array(3*f),v=new Float32Array(3*f),y=new Float32Array(3*f);var z=!0,_=!1,M=void 0;try{for(var A,E=g[Symbol.iterator]();!(z=(A=E.next()).done);z=!0)x=A.value,c[k]=x.a.x,d[k++]=m[0],c[k]=x.a.y,d[k++]=m[1],c[k]=x.a.z,d[k++]=m[2],c[k]=x.b.x,d[k++]=m[0],c[k]=x.b.y,d[k++]=m[1],c[k]=x.b.z,d[k++]=m[2],x.computeZeroCrossingPosition(s),a.copy(s).addScaledVector(x.n,.25*n/i),v[b]=s.x,y[b++]=u[0],v[b]=s.y,y[b++]=u[1],v[b]=s.z,y[b++]=u[2],v[b]=a.x,y[b++]=u[0],v[b]=a.y,y[b++]=u[1],v[b]=a.z,y[b++]=u[2]}catch(t){_=!0,M=t}finally{try{!z&&E.return&&E.return()}finally{if(_)throw M}}(p=new t.BufferGeometry).addAttribute("position",new t.BufferAttribute(c,3)),p.addAttribute("color",new t.BufferAttribute(d,3)),this.edges.add(new t.LineSegments(p,h)),(p=new t.BufferGeometry).addAttribute("position",new t.BufferAttribute(v,3)),p.addAttribute("color",new t.BufferAttribute(y,3)),this.normals.add(new t.LineSegments(p,h))}}},{key:"dispose",value:function(){var t=void 0,e=void 0,n=void 0,i=void 0;for(n=0,i=this.children.length;n<i;++n)for(e=(t=this.children[n]).children;e.length>0;)e[0].geometry.dispose(),e[0].material.dispose(),t.remove(e[0])}},{key:"gridPoints",get:function(){return this.children[0]}},{key:"edges",get:function(){return this.children[1]}},{key:"normals",get:function(){return this.children[2]}}]),n}(t.Object3D),ae=new G,oe=function(){function t(){P(this,t)}return I(t,null,[{key:"calculateCoefficients",value:function(t,e,n){var i=void 0,r=void 0,s=void 0;return 0===e?(ae.x=1,ae.y=0):(i=(n-t)/(2*e),r=Math.sqrt(1+i*i),s=1/(i>=0?i+r:i-r),ae.x=1/Math.sqrt(1+s*s),ae.y=s*ae.x),ae}}]),t}(),le=function(){function t(){P(this,t)}return I(t,null,[{key:"rotateXY",value:function(t,e){var n=e.x,i=e.y,r=t.x,s=t.y;t.set(n*r-i*s,i*r+n*s)}},{key:"rotateQXY",value:function(t,e,n){var i=n.x,r=n.y,s=i*i,a=r*r,o=2*i*r*e,l=t.x,u=t.y;t.set(s*l-o+a*u,a*l+o+s*u)}}]),t}(),ue=1e-6,he=5,ce=new K,de=new Q,ve=new G,ye=new H,fe=function(){function t(){P(this,t)}return I(t,null,[{key:"solve",value:function(t,e,n){var i=x(ce.copy(t),de.identity()),r=k(de,i);n.copy(e).applyMatrix3(r)}}]),t}(),me=new H,pe=function(){function t(){P(this,t),this.data=null,this.ata=new K,this.atb=new H,this.massPoint=new H,this.hasSolution=!1}return I(t,[{key:"setData",value:function(t){return this.data=t,this.hasSolution=!1,this}},{key:"calculateError",value:function(t,e,n){return me.copy(n),t.applyToVector3(me),me.subVectors(e,me),me.dot(me)}},{key:"solve",value:function(t){var e=this.data,n=this.massPoint,i=this.ata.copy(e.ata),r=this.atb.copy(e.atb),s=1/0;return!this.hasSolution&&null!==e&&e.numPoints>0&&(me.copy(e.massPointSum).divideScalar(e.numPoints),n.copy(me),i.applyToVector3(me),r.sub(me),fe.solve(i,r,t),s=this.calculateError(i,r,t),t.add(n),this.hasSolution=!0),s}}]),t}(),ge=function(){function t(){P(this,t),this.ata=new K,this.ata.set(0,0,0,0,0,0),this.atb=new H,this.massPointSum=new H,this.numPoints=0}return I(t,[{key:"set",value:function(t,e,n,i){return this.ata.copy(t),this.atb.copy(e),this.massPointSum.copy(n),this.numPoints=i,this}},{key:"copy",value:function(t){return this.set(t.ata,t.atb,t.massPointSum,t.numPoints)}},{key:"add",value:function(t,e){var n=e.x,i=e.y,r=e.z,s=t.dot(e),a=this.ata.elements,o=this.atb;a[0]+=n*n,a[1]+=n*i,a[3]+=i*i,a[2]+=n*r,a[4]+=i*r,a[5]+=r*r,o.x+=s*n,o.y+=s*i,o.z+=s*r,this.massPointSum.add(t),++this.numPoints}},{key:"addData",value:function(t){this.ata.add(t.ata),this.atb.add(t.atb),this.massPointSum.add(t.massPointSum),this.numPoints+=t.numPoints}},{key:"clear",value:function(){this.ata.set(0,0,0,0,0,0),this.atb.set(0,0,0),this.massPointSum.set(0,0,0),this.numPoints=0}},{key:"clone",value:function(){return(new this.constructor).copy(this)}}]),t}(),xe=function(){function t(){P(this,t)}return I(t,null,[{key:"parseBin",value:function(t){return parseInt(t,2)}},{key:"createBinaryString",value:function(t){for(var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:64,n=t<0?"-":"",i=Math.abs(t).toString(2);i.length<e;)i="0"+i;return n+i}}]),t}(),we=function t(){P(this,t),this.materials=0,this.edgeCount=0,this.index=-1,this.position=new H,this.normal=new H,this.qefData=null},ke=0,be=new H,ze=(function(){function t(){P(this,t)}I(t,null,[{key:"run",value:function(t,e,n,i){be.fromArray(t),ke=e,null===n?i.operation===L.UNION&&(n=new re(!1)):n.decompress();var r=i.toCSG(),s=null!==n?S(r):null;if(null!==s){switch(i.operation){case L.UNION:r=new tt(r);break;case L.DIFFERENCE:r=new et(r);break;case L.INTERSECTION:r=new nt(r)}E(r,n,s),n.contoured=!1}return null!==n&&(n.empty?n=null:n.compress()),n}}])}(),new pe),_e=.01,Me=function(t){function e(t,n){P(this,e);var i=U(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n));return i.voxel=null,i}return C(e,St),I(e,[{key:"contains",value:function(t){var e=this.min,n=this.size;return t.x>=e.x-1e-6&&t.y>=e.y-1e-6&&t.z>=e.z-1e-6&&t.x<=e.x+n+1e-6&&t.y<=e.y+n+1e-6&&t.z<=e.z+n+1e-6}},{key:"collapse",value:function(){var t=this.children,e=new Int16Array([-1,-1,-1,-1,-1,-1,-1,-1]),n=new H,i=-1,r=null!==t,s=0,a=void 0,o=void 0,l=void 0,u=void 0,h=void 0,c=void 0;if(r){for(u=new ge,h=0,c=0;c<8;++c)s+=(a=t[c]).collapse(),l=a.voxel,null!==a.children?r=!1:null!==l&&(u.addData(l.qefData),i=l.materials>>7-c&1,e[c]=l.materials>>c&1,++h);if(r&&ze.setData(u).solve(n)<=_e){for((l=new we).position.copy(this.contains(n)?n:ze.massPoint),c=0;c<8;++c)o=e[c],a=t[c],-1===o?l.materials|=i<<c:(l.materials|=o<<c,l.normal.add(a.voxel.normal));l.normal.normalize(),l.qefData=u,this.voxel=l,this.children=null,s+=h-1}}return s}},{key:"errorThreshold",get:function(){return _e},set:function(t){_e=t}}]),e}(),Ae=(function(t){function e(t,n,i){P(this,e);var r=U(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return r.root=new Me(new(Function.prototype.bind.apply(H,[null].concat(R(t)))),n),r.voxelCount=0,r.construct(i),r.simplify(),r}C(e,Vt),I(e,[{key:"simplify",value:function(){this.voxelCount-=this.root.collapse()}},{key:"getCell",value:function(t,e,n,i){var r=this.root,s=0;for(t>>=1;t>0;t>>=1,s=0)e>=t&&(s+=4,e-=t),n>=t&&(s+=2,n-=t),i>=t&&(s+=1,i-=t),null===r.children&&r.split(),r=r.children[s];return r}},{key:"construct",value:function(t){var e=re.resolution,n=t.edgeData,i=t.materialIndices,r=new pe,s=new H,a=[n.edgesX(this.min,this.size),n.edgesY(this.min,this.size),n.edgesZ(this.min,this.size)],o=[new Uint8Array([0,1,2,3]),new Uint8Array([0,1,4,5]),new Uint8Array([0,2,4,6])],l=0,u=void 0,h=void 0,c=void 0,d=void 0,v=void 0,y=void 0,f=void 0,m=void 0,p=void 0,g=void 0,x=void 0;for(g=0;g<3;++g){c=o[g],u=a[g];var w=!0,k=!1,b=void 0;try{for(var z,_=u[Symbol.iterator]();!(w=(z=_.next()).done);w=!0)for((h=z.value).computeZeroCrossingPosition(s),x=0;x<4;++x)d=Mt[c[x]],f=h.coordinates.x-d[0],m=h.coordinates.y-d[1],p=h.coordinates.z-d[2],f>=0&&m>=0&&p>=0&&f<e&&m<e&&p<e&&(null===(v=this.getCell(e,f,m,p)).voxel&&(v.voxel=D(e,f,m,p,i),++l),(y=v.voxel).normal.add(h.n),y.qefData.add(s,h.n),y.qefData.numPoints===y.edgeCount&&(r.setData(y.qefData).solve(y.position),v.contains(y.position)||y.position.copy(r.massPoint),y.normal.normalize()))}catch(t){k=!0,b=t}finally{try{!w&&_.return&&_.return()}finally{if(k)throw b}}}this.voxelCount=l}}])}(),Math.pow(2,32)),Ee=53,Se=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Math.round(.4*Ee),n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Math.round(.2*Ee),i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e;P(this,t),e+n+i>Ee&&(console.error("Invalid bit allotment"),e=Math.round(.4*Ee),n=Math.round(.2*Ee),i=e),this.x=e,this.y=n,this.z=i,this.rangeX=Math.pow(2,this.x),this.rangeY=Math.pow(2,this.y),this.rangeZ=Math.pow(2,this.z),this.rangeXY=Math.pow(2,this.x+this.y),this.halfRange=new H(this.rangeX/2,this.rangeY/2,this.rangeZ/2),this.maskX=[0,0],this.maskY=[0,0],this.maskZ=[0,0],this.updateBitMasks()}return I(t,[{key:"updateBitMasks",value:function(){var t=this.x,e=this.y,n=this.z,i=this.maskX,r=this.maskY,s=this.maskZ,a=32-Math.max(0,t-32),o=32-Math.max(0,e+t-32),l=32-Math.max(0,n+e+t-32);i[1]=a<32?-1>>>a:0,i[0]=-1>>>Math.max(0,32-t),r[1]=((o<32?-1>>>o:0)&~i[1])>>>0,r[0]=(-1>>>Math.max(0,32-(t+e))&~i[0])>>>0,s[1]=((l<32?-1>>>l:0)&~r[1]&~i[1])>>>0,s[0]=(-1>>>Math.max(0,32-(t+e+n))&~r[0]&~i[0])>>>0}},{key:"unpackKey",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new H,n=this.maskX,i=this.maskY,r=this.maskZ,s=Math.trunc(t/Ae),a=t%Ae;return e.set((s&n[1])*Ae+((a&n[0])>>>0),((s&i[1])*Ae+((a&i[0])>>>0))/this.rangeX,((s&r[1])*Ae+((a&r[0])>>>0))/this.rangeXY)}},{key:"packKey",value:function(t){return t.z*this.rangeXY+t.y*this.rangeX+t.x}},{key:"toString",value:function(){var t=this.maskX,e=this.maskY,n=this.maskZ;return"Key Design\n\nX-Bits: "+this.x+"\nY-Bits: "+this.y+"\nZ-Bits: "+this.z+"\n\n"+xe.createBinaryString(t[1],32)+" "+t[1]+" (HI-Mask X)\n"+xe.createBinaryString(t[0],32)+" "+t[0]+" (LO-Mask X)\n\n"+xe.createBinaryString(e[1],32)+" "+e[1]+" (HI-Mask Y)\n"+xe.createBinaryString(e[0],32)+" "+e[0]+" (LO-Mask Y)\n\n"+xe.createBinaryString(n[1],32)+" "+n[1]+" (HI-Mask Z)\n"+xe.createBinaryString(n[0],32)+" "+n[0]+" (LO-Mask Z)\n"}}],[{key:"BITS",get:function(){return Ee}},{key:"HI_BITS",get:function(){return 21}},{key:"LO_BITS",get:function(){return 32}}]),t}(),De=new H,Pe=(function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:20,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:16,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new Se;for(P(this,t),this.cellSize=e,this.keyDesign=i,this.grids=[];this.grids.length<n;)this.grids.push(new Map);this.min=this.keyDesign.halfRange.clone().multiplyScalar(-this.cellSize),this.max=this.keyDesign.halfRange.clone().multiplyScalar(this.cellSize)}I(t,[{key:"getCenter",value:function(){return(arguments.length>0&&void 0!==arguments[0]?arguments[0]:new H).copy(this.min).add(this.max).multiplyScalar(.5)}},{key:"setCenter",value:function(t){this.min.copy(this.keyDesign.halfRange).multiplyScalar(-this.cellSize).add(t),this.max.copy(this.keyDesign.halfRange).multiplyScalar(this.cellSize).add(t)}},{key:"getDimensions",value:function(){return(arguments.length>0&&void 0!==arguments[0]?arguments[0]:new H).copy(this.max).sub(this.min)}},{key:"getDepth",value:function(){return this.grids.length-1}},{key:"getGrid",value:function(t){return t>0&&t<this.grids.length?this.grids[t]:void 0}},{key:"contains",value:function(t){var e=this.min,n=this.max;return t.x>=e.x&&t.y>=e.y&&t.z>=e.z&&t.x<=n.x&&t.y<=n.y&&t.z<=n.z}},{key:"findOctantsByLevel",value:function(t){return this.grids[t]}},{key:"getOctant",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=this.getGrid(e),i=void 0;return void 0!==n?i=n.get(t):console.error("Invalid LOD",e),i}},{key:"getOctantXXX",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=this.keyDesign,i=this.cellSize,r=this.getGrid(e),s=void 0;return void 0!==r?this.contains(t)?(De.set(Math.trunc(t.x/i),Math.trunc(t.y/i),Math.trunc(t.z/i)).sub(this.min),s=r.get(n.packKey(De))):console.error("Position out of range",t):console.error("Invalid LOD",e),s}},{key:"raycast",value:function(t){return arguments.length>1&&void 0!==arguments[1]?arguments[1]:[]}},{key:"cull",value:function(t){return null}},{key:Symbol.iterator,value:function(){return null}},{key:"levels",get:function(){return this.grids.length}}])}(),function(t){function e(t){P(this,e);var n=U(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));return n.qefData=null,n}return C(e,q),e}()),Ie=new t.Vector2,Oe=new q("update"),Ce=function(e){function n(e,i,r,s){var a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:document.body;P(this,n);var o=U(this,(n.__proto__||Object.getPrototypeOf(n)).call(this));return o.hermiteData=r,o.cellPosition=e,o.cellSize=i,o.camera=s,o.dom=a,o.raycaster=new t.Raycaster,o.gridPointMaterials=[new t.MeshBasicMaterial({color:10066329,depthWrite:!1,transparent:!0,opacity:.75}),new t.MeshBasicMaterial({color:13395558,depthWrite:!1,transparent:!0,opacity:.9})],o.selectedGridPoint=null,o.gridPoints=new t.Group,o.createGridPoints(),o}return C(n,V),I(n,[{key:"createGridPoints",value:function(){var e=this.gridPoints,n=this.cellSize,i=re.resolution,r=this.cellPosition,s=new t.Vector3,a=new t.SphereBufferGeometry(.05,8,8),o=this.gridPointMaterials[0],l=void 0,u=void 0,h=void 0,c=void 0;for(c=0;c<=i;++c)for(s.z=c*n/i,h=0;h<=i;++h)for(s.y=h*n/i,u=0;u<=i;++u)s.x=u*n/i,(l=new t.Mesh(a,o)).position.copy(r).add(s),e.add(l)}},{key:"toggleMaterialIndex",value:function(t){var e=this.hermiteData,n=e.materialIndices[t]===J.AIR?J.SOLID:J.AIR;e.setMaterialIndex(t,n)}},{key:"handleClick",value:function(t){var e=this.selectedGridPoint;t.preventDefault(),null!==e&&(this.toggleMaterialIndex(this.gridPoints.children.indexOf(e)),this.dispatchEvent(Oe))}},{key:"raycast",value:function(t){var e=this.raycaster;Ie.x=t.clientX/window.innerWidth*2-1,Ie.y=-t.clientY/window.innerHeight*2+1,e.setFromCamera(Ie,this.camera);var n=e.intersectObjects(this.gridPoints.children);null!==this.selectedGridPoint&&(this.selectedGridPoint.material=this.gridPointMaterials[0],this.selectedGridPoint=null),n.length>0&&(this.selectedGridPoint=n[0].object,this.selectedGridPoint.material=this.gridPointMaterials[1])}},{key:"handleEvent",value:function(t){switch(t.type){case"mousemove":this.raycast(t);break;case"click":this.handleClick(t)}}},{key:"setEnabled",value:function(t){var e=this.dom;t?(e.addEventListener("mousemove",this),e.addEventListener("click",this)):(e.removeEventListener("mousemove",this),e.removeEventListener("click",this))}},{key:"dispose",value:function(){this.setEnabled(!1)}},{key:"configure",value:function(t){}}]),n}(),Ue=new t.Vector2,Re=new q("update"),Ne=function(e){function n(e,i,r,s){var a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:document.body;P(this,n);var o=U(this,(n.__proto__||Object.getPrototypeOf(n)).call(this));return o.hermiteData=r,o.cellPosition=e,o.cellSize=i,o.camera=s,o.dom=a,o.raycaster=new t.Raycaster,o.raycaster.linePrecision=.05,o.t=0,o.edgeMaterials=[new t.LineBasicMaterial({color:10066329}),new t.LineBasicMaterial({color:13395558})],o.planeMaterials=[new t.MeshBasicMaterial({color:16776960,side:t.DoubleSide,depthWrite:!1,transparent:!0,opacity:.1}),new t.MeshBasicMaterial({color:16737792,side:t.DoubleSide,depthWrite:!1,transparent:!0,opacity:.2})],o.selectedEdge=null,o.activeEdge=null,o.activePlane=null,o.edgeId=new t.Vector2,o.edges=new t.Group,o.planes=new t.Group,o.t=0,o.s=new t.Spherical,o}return C(n,V),I(n,[{key:"calculateEdgeId",value:function(t){var e=this.hermiteData.edgeData.indices,n=void 0,i=void 0;for(n=0;n<3&&(i=e[n].length,!(t<i));++n)t-=i;this.edgeId.set(n,t)}},{key:"clearEdges",value:function(){for(var t=this.edges,e=this.planes,n=void 0,i=void 0;t.children.length>0;)(n=t.children[0]).geometry.dispose(),t.remove(n);for(;e.children.length>0;)(i=e.children[0]).geometry.dispose(),e.remove(i);this.activeEdge=null,this.activePlane=null}},{key:"createEdges",value:function(){var e=this.edges,n=this.planes,i=this.edgeMaterials[0],r=this.planeMaterials[0],s=this.hermiteData.edgeData.edges(this.cellPosition,this.cellSize),a=new t.Vector3,o=void 0,l=void 0,u=void 0,h=void 0,c=void 0;this.clearEdges();var d=!0,v=!1,y=void 0;try{for(var f,m=s[Symbol.iterator]();!(d=(f=m.next()).done);d=!0)o=f.value,h=new t.BufferGeometry,c=new Float32Array(6),o.a.toArray(c),o.b.toArray(c,3),h.addAttribute("position",new t.BufferAttribute(c,3)),l=new t.Line(h,i),e.add(l),(u=new t.Mesh(new t.PlaneBufferGeometry(2,2),r)).position.copy(o.computeZeroCrossingPosition(a)),u.lookAt(a.add(o.n)),u.visible=!1,n.add(u)}catch(t){v=!0,y=t}finally{try{!d&&m.return&&m.return()}finally{if(v)throw y}}}},{key:"adoptEdgeData",value:function(){var e=this.hermiteData.edgeData,n=e.zeroCrossings,i=e.normals,r=this.edgeId.x,s=this.edgeId.y,a=new t.Vector3;this.t=n[r][s],this.s.setFromVector3(a.fromArray(i[r],3*s))}},{key:"updateEdgeData",value:function(){var e=this.activeEdge,n=this.activePlane,i=new t.Vector3,r=new t.Vector3,s=new t.Vector3,a=new t.Vector3,o=this.hermiteData.edgeData,l=o.zeroCrossings,u=o.normals,h=this.edgeId.x,c=this.edgeId.y;null!==e&&(i.fromArray(e.geometry.getAttribute("position").array),r.fromArray(e.geometry.getAttribute("position").array,3),s.copy(i).add(r.sub(i).multiplyScalar(this.t)),a.setFromSpherical(this.s).normalize(),n.position.copy(s),n.lookAt(s.add(a)),l[h][c]=this.t,a.toArray(u[h],3*c),this.dispatchEvent(Re))}},{key:"handleClick",value:function(t){var e=this.selectedEdge;t.preventDefault();var n=void 0,i=void 0;null!==e&&(null!==this.activeEdge&&(this.activeEdge!==e&&(this.activeEdge.material=this.edgeMaterials[0]),this.activePlane.material=this.planeMaterials[0],this.activePlane.visible=!1),this.activeEdge!==e?(n=this.edges.children.indexOf(e),i=this.planes.children[n],e.material=this.edgeMaterials[1],i.material=this.planeMaterials[1],i.visible=!0,this.activeEdge=e,this.activePlane=i,this.calculateEdgeId(n),this.adoptEdgeData()):(this.t=0,this.s.phi=0,this.s.theta=0,this.activeEdge=null,this.activePlane=null))}},{key:"raycast",value:function(t){var e=this.raycaster;Ue.x=t.clientX/window.innerWidth*2-1,Ue.y=-t.clientY/window.innerHeight*2+1,e.setFromCamera(Ue,this.camera);var n=e.intersectObjects(this.edges.children);null!==this.selectedEdge&&(this.selectedEdge!==this.activeEdge&&(this.selectedEdge.material=this.edgeMaterials[0]),this.selectedEdge=null),n.length>0&&(this.selectedEdge=n[0].object,this.selectedEdge.material=this.edgeMaterials[1])}},{key:"handleEvent",value:function(t){switch(t.type){case"mousemove":this.raycast(t);break;case"click":this.handleClick(t)}}},{key:"setEnabled",value:function(t){var e=this.dom;t?(e.addEventListener("mousemove",this),e.addEventListener("click",this)):(e.removeEventListener("mousemove",this),e.removeEventListener("click",this))}},{key:"dispose",value:function(){this.setEnabled(!1)}},{key:"configure",value:function(t){var e=this,n=this.planes,i={"show planes":!1};t.add(i,"show planes").onChange(function(){var t=e.activePlane;n.traverse(function(e){e!==n&&e!==t&&(e.visible=i["show planes"])})});var r=t.addFolder("Edge Adjustment");r.add(this,"t").min(0).max(1).listen().step(1e-6).onChange(function(){e.updateEdgeData()}),r.add(this.s,"phi").min(1e-6).max(Math.PI-1e-6).step(1e-6).listen().onChange(function(){e.updateEdgeData()}),r.add(this.s,"theta").min(1e-6).max(Math.PI-1e-6).step(1e-6).listen().onChange(function(){e.updateEdgeData()}),r.open()}}]),n}(),Le=new Pe("update"),Te=function(e){function n(t,e,i,r){var s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:document.body;P(this,n);var a=U(this,(n.__proto__||Object.getPrototypeOf(n)).call(this));return a.hermiteData=i,a.cellPosition=t,a.cellSize=e,a.gridPointEditor=new Ce(t,e,i,r,s),a.gridPointEditor.addEventListener("update",a),a.gridPointEditor.setEnabled(!0),a.edgeEditor=new Ne(t,e,i,r,s),a.edgeEditor.addEventListener("update",a),a.qefData=new ge,a}return C(n,V),I(n,[{key:"createEdgeData",value:function(){var t=re.resolution,e=t+1,n=e*e,i=new Uint32Array([1,e,n]),r=this.hermiteData.materialIndices,s=new ee(ee.calculate1DEdgeCount(t)),a=void 0,o=void 0,l=void 0,u=void 0,h=void 0,c=void 0,d=void 0,v=void 0,y=void 0,f=void 0,m=void 0,p=void 0,g=void 0,x=void 0,w=void 0;for(v=4,c=0,d=0;d<3;v>>=1,c=0,++d){switch(y=Mt[v],a=s.indices[d],o=s.zeroCrossings[d],l=s.normals[d],g=x=w=t,d){case 0:g=Math.min(g,t-1);break;case 1:x=Math.min(x,t-1);break;case 2:w=Math.min(w,t-1)}for(p=0;p<=w;++p)for(m=0;m<=x;++m)for(f=0;f<=g;++f)h=(u=p*n+m*e+f)+i[d],r[u]!==r[h]&&(a[c]=u,o[c]=.5,l[3*c]=y[0],l[3*c+1]=y[1],l[3*c+2]=y[2],++c);s.indices[d]=s.indices[d].slice(0,c),s.zeroCrossings[d]=s.zeroCrossings[d].slice(0,c),s.normals[d]=s.normals[d].slice(0,3*c)}this.hermiteData.edgeData=s}},{key:"updateQEFData",value:function(){var e=this.qefData,n=new t.Vector3,i=this.hermiteData.edgeData.edges(this.cellPosition,this.cellSize),r=void 0;e.clear();var s=!0,a=!1,o=void 0;try{for(var l,u=i[Symbol.iterator]();!(s=(l=u.next()).done);s=!0)(r=l.value).computeZeroCrossingPosition(n),e.add(n,r.n)}catch(t){a=!0,o=t}finally{try{!s&&u.return&&u.return()}finally{if(a)throw o}}}},{key:"handleEvent",value:function(t){switch(t.type){case"update":t.target===this.gridPointEditor&&(this.createEdgeData(),this.edgeEditor.createEdges()),1===re.resolution&&this.updateQEFData(),Le.qefData=this.qefData,this.dispatchEvent(Le)}}},{key:"setEnabled",value:function(t){this.gridPointEditor.setEnabled(t),this.edgeEditor.setEnabled(t)}},{key:"dispose",value:function(){this.setEnabled(!1)}},{key:"configure",value:function(t){var e=this,n={"edit mode":0};t.add(n,"edit mode",{materials:0,edges:1}).onChange(function(){var t=0===Number.parseInt(n["edit mode"]);e.gridPointEditor.setEnabled(t),e.edgeEditor.setEnabled(!t)}),this.edgeEditor.configure(t)}},{key:"gridPoints",get:function(){return this.gridPointEditor.gridPoints}},{key:"edges",get:function(){return this.edgeEditor.edges}},{key:"planes",get:function(){return this.edgeEditor.planes}}]),n}(),Be=function(){function e(n){P(this,e),this.renderer=n,this.loadingManager=new t.LoadingManager,this.assets=null,this.scene=new t.Scene,this.scene.fog=new t.FogExp2(855309,.0025),this.camera=new t.PerspectiveCamera(50,window.innerWidth/window.innerHeight,.1,2e3),this.controls=null}return I(e,[{key:"load",value:function(t){t()}},{key:"initialise",value:function(){}},{key:"render",value:function(t){}},{key:"configure",value:function(t){}},{key:"reset",value:function(){var e=this.scene.fog;return this.scene=new t.Scene,this.scene.fog=e,null!==this.controls&&(this.controls.dispose(),this.controls=null),this}}]),e}(),Fe=function(e){function n(e){P(this,n);var i=U(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,e));return i.hermiteData=null,i.hermiteDataHelper=null,i.hermiteDataEditor=null,i.qefSolver=new pe,i.error="0.0000",i.result={x:"",y:"",z:""},i.vertex=new t.Mesh(new t.SphereBufferGeometry(.05,8,8),new t.MeshBasicMaterial({color:16746530})),i.vertex.visible=!1,i}return C(n,Be),I(n,[{key:"initialise",value:function(){var e=this.scene,n=this.camera,i=this.renderer;e.fog.color.setHex(16053492),e.fog.density=.025,i.setClearColor(e.fog.color);var r=new t.OrbitControls(n,i.domElement);r.enablePan=!1,r.maxDistance=40,this.controls=r,n.near=.01,n.far=50,n.position.set(-2,1,2),n.lookAt(r.target),re.resolution=1;var s=new t.Vector3(-.5,-.5,-.5);s.multiplyScalar(1);var a=new re,o=new se(s,1,a,!0,!1);this.hermiteData=a,this.hermiteDataHelper=o,e.add(o);var l=new Te(s,1,a,n,i.domElement);l.addEventListener("update",this),this.hermiteDataEditor=l,e.add(l.gridPoints),e.add(l.edges),e.add(l.planes);e.add(new t.Mesh(new t.BoxBufferGeometry(.95,.95,.95),new t.MeshBasicMaterial({color:13421772,depthWrite:!1,transparent:!0,opacity:.35}))),e.add(this.vertex)}},{key:"solveQEF",value:function(t){var e=this.hermiteData,n=this.qefSolver,i=this.vertex,r=this.result;e.empty||e.full?i.visible&&(r.x="",r.y="",r.z="",i.visible=!1):(this.error=n.setData(t).solve(i.position).toFixed(4),i.visible=!0,r.x=i.position.x.toFixed(2),r.y=i.position.y.toFixed(2),r.z=i.position.z.toFixed(2))}},{key:"handleEvent",value:function(t){switch(t.type){case"update":this.hermiteDataHelper.update(!0,!1),this.solveQEF(t.qefData)}}},{key:"render",value:function(t){this.renderer.render(this.scene,this.camera)}},{key:"configure",value:function(t){var e=t.addFolder("Result");e.add(this.result,"x").listen(),e.add(this.result,"y").listen(),e.add(this.result,"z").listen(),e.add(this,"error").listen(),e.open(),this.hermiteDataEditor.configure(t)}}]),n}(),qe=function(){function i(){P(this,i),this.clock=new t.Clock,this.renderer=new t.WebGLRenderer({logarithmicDepthBuffer:!0,antialias:!0}),this.renderer.setSize(window.innerWidth,window.innerHeight),this.renderer.setClearColor(0),this.renderer.setPixelRatio(window.devicePixelRatio),this.stats=function(){var t=new n;return t.showPanel(0),t.dom.id="stats",t}(),this.demos=function(t){var e=new Map;return e.set("qef",new Fe(t)),e}(this.renderer),this.demo=function(t){var e=window.location.hash.slice(1);return 0!==e.length&&t.has(e)||(e=t.keys().next().value),e}(this.demos)}return I(i,[{key:"initialise",value:function(t,n,i){function r(){c.initialise(),c.camera.aspect=window.innerWidth/window.innerHeight,c.camera.updateProjectionMatrix(),(d=new e.GUI({autoPlace:!1})).add(a,"demo",Array.from(h.keys())).onChange(s),c.configure(d),n.appendChild(d.domElement),i.style.display="none",o.domElement.style.visibility="visible"}function s(){i.style.display="block",o.domElement.style.visibility="hidden",null!==d&&(d.destroy(),n.removeChild(d.domElement)),null!==c&&c.reset(),(c=h.get(a.demo)).load(r)}var a=this,o=this.renderer,l=this.clock,u=this.stats,h=this.demos,c=null,d=null;t.appendChild(o.domElement),n.appendChild(u.dom),s(),document.addEventListener("keydown",function(t){t.altKey&&(t.preventDefault(),n.style.visibility="hidden"===n.style.visibility?"visible":"hidden")}),window.addEventListener("resize",function(){function t(t){var n=t.target.innerWidth,i=t.target.innerHeight;o.setSize(n,i),c.camera.aspect=n/i,c.camera.updateProjectionMatrix(),e=0}var e=0;return function(n){0===e&&(e=setTimeout(t,66,n))}}()),function t(e){var n=l.getDelta();requestAnimationFrame(t),u.begin(),c.render(n),u.end()}()}}]),i}();window.addEventListener("load",function t(e){var n=document.getElementById("viewport"),i=n.children[0],r=document.getElementById("aside"),s=new qe;window.removeEventListener("load",t),r.style.visibility="visible",s.initialise(n,r,i)})}(THREE,dat,Stats);