/**
 * rabbit-hole v0.0.0 build May 28 2017
 * https://github.com/vanruesc/rabbit-hole
 * Copyright 2017 Raoul van RÃ¼schen, Zlib
 */

!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("three")):"function"==typeof define&&define.amd?define(["exports","three"],e):e(t.RABBITHOLE=t.RABBITHOLE||{},t.THREE)}(this,function(t,e){"use strict";function n(t,e,n,i,r,s){var a=0;return t>e&&t>n?(r<t&&(a|=2),s<t&&(a|=1)):e>n?(i<e&&(a|=4),s<e&&(a|=1)):(i<n&&(a|=4),r<n&&(a|=2)),a}function i(t,e,n,i){var r=void 0,s=0;return e<n?(r=e,s=0):(r=n,s=1),i<r&&(s=2),rt[t][s]}function r(t,e,s,a,o,u,l,h,c){var d=t.children,v=void 0,y=void 0,f=void 0,m=void 0;if(o>=0&&u>=0&&l>=0)if(null===d)c.push(t);else{v=n(e,s,a,y=.5*(e+o),f=.5*(s+u),m=.5*(a+l));do{switch(v){case 0:r(d[it[8]],e,s,a,y,f,m,h,c),v=i(v,y,f,m);break;case 1:r(d[it[8]^it[1]],e,s,m,y,f,l,h,c),v=i(v,y,f,l);break;case 2:r(d[it[8]^it[2]],e,f,a,y,u,m,h,c),v=i(v,y,u,m);break;case 3:r(d[it[8]^it[3]],e,f,m,y,u,l,h,c),v=i(v,y,u,l);break;case 4:r(d[it[8]^it[4]],y,s,a,o,f,m,h,c),v=i(v,o,f,m);break;case 5:r(d[it[8]^it[5]],y,s,m,o,f,l,h,c),v=i(v,o,f,l);break;case 6:r(d[it[8]^it[6]],y,f,a,o,u,m,h,c),v=i(v,o,u,m);break;case 7:r(d[it[8]^it[7]],y,f,m,o,u,l,h,c),v=8}}while(v<8)}}function s(t){var e=t.children,n=0,i=void 0,r=void 0,a=void 0;if(null!==e)for(i=0,r=e.length;i<r;++i)(a=1+s(e[i]))>n&&(n=a);return n}function a(t,e,n){var i=t.children,r=void 0,s=void 0;if(at.min=t.min,at.max=t.max,e.intersectsBox(at))if(null!==i)for(r=0,s=i.length;r<s;++r)a(i[r],e,n);else n.push(t)}function o(t,e,n,i){var r=t.children,s=void 0,a=void 0;if(n===e)i.push(t);else if(null!==r)for(++n,s=0,a=r.length;s<a;++s)o(r[s],e,n,i)}function u(t){var e=t.children,n=0,i=void 0,r=void 0;if(null!==e)for(i=0,r=e.length;i<r;++i)n+=u(e[i]);else null!==t.points&&(n=t.points.length);return n}function l(t,e,n,i,r,s,a){var o=t.children,u=!1,h=!1,c=void 0,d=void 0;if(t.contains(e,r)){if(null===o){if(null===t.points)t.points=[],t.data=[];else for(c=0,d=t.points.length;!u&&c<d;++c)u=t.points[c].equals(e);u?(t.data[c-1]=n,h=!0):t.points.length<s||i===a?(t.points.push(e.clone()),t.data.push(n),h=!0):(t.split(),t.redistribute(r),o=t.children)}if(null!==o)for(++i,c=0,d=o.length;!h&&c<d;++c)h=l(o[c],e,n,i,r,s,a)}return h}function h(t,e,n,i,r){var s=t.children,a=!1,o=void 0,l=void 0,c=void 0,d=void 0,v=void 0;if(t.contains(n,i))if(null!==s)for(o=0,l=s.length;!a&&o<l;++o)a=h(s[o],t,n,i,r);else if(null!==t.points)for(c=t.points,d=t.data,o=0,l=c.length;!a&&o<l;++o)c[o].equals(n)&&(o<(v=l-1)&&(c[o]=c[v],d[o]=d[v]),c.pop(),d.pop(),null!==e&&u(e)<=r&&e.merge(),a=!0);return a}function c(t,e,n,i){var r=t.children,s=null,a=void 0,o=void 0,u=void 0;if(t.contains(e,n))if(null!==r)for(a=0,o=r.length;null===s&&a<o;++a)s=c(r[a],e,n,i);else for(a=0,o=(u=t.points).length;null===s&&a<o;++a)e.distanceToSquared(u[a])<=i&&(s=t.data[a]);return s}function d(t,e,n,i){var r=t.points,s=t.children,a=null,o=n,u=void 0,l=void 0,h=void 0,c=void 0,v=void 0,y=void 0,f=void 0;if(null!==s)for(u=0,l=(v=s.map(function(t){return{octant:t,distance:t.distanceToCenterSquared(e)}}).sort(function(t,e){return t.distance-e.distance})).length;u<l;++u)(y=v[u].octant).contains(e,o)&&null!==(f=d(y,e,o,i))&&(c=f.point.distanceToSquared(e),(!i||c>0)&&c<o&&(o=c,a=f));else if(null!==r)for(u=0,l=r.length;u<l;++u)h=r[u],c=e.distanceToSquared(h),(!i||c>0)&&c<o&&(o=c,a={point:h.clone(),data:t.data[u]});return a}function v(t,e,n,i,r){var s=t.points,a=t.children,o=n*n,u=void 0,l=void 0,h=void 0,c=void 0,d=void 0;if(null!==a)for(u=0,l=a.length;u<l;++u)(d=a[u]).contains(e,n)&&v(d,e,n,i,r);else if(null!==s)for(u=0,l=s.length;u<l;++u)h=s[u],c=e.distanceToSquared(h),(!i||c>0)&&c<=o&&r.push({point:h.clone(),data:t.data[u]})}function y(t){return Math.pow(2,Math.max(0,Math.ceil(Math.log2(t))))}function f(t,e,n){var i=void 0,r=void 0,s=void 0;0===e?(te.c=1,te.s=0):(i=(n-t)/(2*e),r=Math.sqrt(1+i*i),s=1/(i>=0?i+r:i-r),te.c=1/Math.sqrt(1+s*s),te.s=s*te.c)}function m(t,e){0!==t.elements[1]&&Qt.rot01Post(e,ee.rot01(t))}function p(t,e){0!==t.elements[2]&&Qt.rot02Post(e,ee.rot02(t))}function g(t,e){0!==t.elements[4]&&Qt.rot12Post(e,ee.rot12(t))}function x(t,e,n,i,r){var s=i*e.copy(t).norm(),a=void 0;for(a=0;a<r&&e.off()>s;++a)m(e,n),p(e,n),g(e,n)}function k(t,e){var n=1/t;return Math.abs(t)<e||Math.abs(n)<e?0:n}function w(t,e,n,i){var r=t.elements,s=e.elements,a=n.elements,o=s[0],u=s[3],l=s[5],h=k(o,i),c=k(u,i),d=k(l,i),v=3-((0===h)+(0===c)+(0===d)),y=a[0],f=a[3],m=a[6],p=a[1],g=a[4],x=a[7],w=a[2],b=a[5],z=a[8];return r[0]=y*h*y+f*c*f+m*d*m,r[3]=y*h*p+f*c*g+m*d*x,r[6]=y*h*w+f*c*b+m*d*z,r[1]=r[3],r[4]=p*h*p+g*c*g+x*d*x,r[7]=p*h*w+g*c*b+x*d*z,r[2]=r[6],r[5]=r[7],r[8]=w*h*w+b*c*b+z*d*z,v}function b(t,e,n,i,r){var s=t+1,a=s*s,o=new ae,u=void 0,l=void 0,h=void 0,c=void 0,d=void 0;for(u=0,d=0;d<8;++d)c=(i+(h=$[d])[2])*a+(n+h[1])*s+(e+h[0]),u|=Math.min(r[c],ct.SOLID)<<d;for(l=0,d=0;d<12;++d)(u>>J[d][0]&1)!==(u>>J[d][1]&1)&&++l;return o.materials=u,o.edgeCount=l,o.qefData=new se,o}function z(t,e){var n=t.size,i=t.resolution,r=new lt(0,0,0),s=new lt(i,i,i),a=new ht(t.min,t.max);return e.type!==I.INTERSECTION&&(e.boundingBox.intersectsBox(a)?(r.copy(e.boundingBox.min).max(a.min).sub(a.min),r.x=Math.ceil(r.x*i/n),r.y=Math.ceil(r.y*i/n),r.z=Math.ceil(r.z*i/n),s.copy(e.boundingBox.max).min(a.max).sub(a.min),s.x=Math.floor(s.x*i/n),s.y=Math.floor(s.y*i/n),s.z=Math.floor(s.z*i/n)):(r.set(i,i,i),s.set(0,0,0))),new ht(r,s)}function _(t,e,n,i,r){var s=t.resolution+1,a=s*s,o=r.max.x,u=r.max.y,l=r.max.z,h=void 0,c=void 0,d=void 0;for(d=r.min.z;d<=l;++d)for(c=r.min.y;c<=u;++c)for(h=r.min.x;h<=o;++h)e.updateMaterialIndex(d*a+c*s+h,n,i)}function A(t,e,n,i){var r=t.size,s=t.resolution,a=s+1,o=a*a,u=n.materialIndices,l=t.min,h=new lt,c=new lt,d=i.max.x,v=i.max.y,y=i.max.z,f=void 0,m=0,p=void 0,g=void 0,x=void 0;for(x=i.min.z;x<=y;++x)for(h.z=x*r/s,g=i.min.y;g<=v;++g)for(h.y=g*r/s,p=i.min.x;p<=d;++p)h.x=p*r/s,(f=e.generateMaterialIndex(c.addVectors(l,h)))!==ct.AIR&&(u[x*o+g*a+p]=f,++m);n.materials=m}function M(t,e,n,i){var r=t.resolution+1,s=new Uint32Array([1,r,r*r]),a=n.materialIndices,o=new Wt,u=new Wt,l=i.edgeData,h=n.edgeData,c=dt.calculate1DEdgeCount(t.resolution),d=new dt(Math.min(c,h.edges[0].length+l.edges[0].length),Math.min(c,h.edges[1].length+l.edges[1].length),Math.min(c,h.edges[2].length+l.edges[2].length)),v=new Uint32Array(3),y=void 0,f=void 0,m=void 0,p=void 0,g=void 0,x=void 0,k=void 0,w=void 0,b=void 0,z=void 0,_=void 0,A=void 0,M=void 0,S=void 0,E=void 0,P=void 0,U=void 0,O=void 0,D=void 0,C=void 0,T=void 0,N=void 0;for(U=0,O=0;O<3;U=0,++O){for(y=l.edges[O],p=h.edges[O],k=d.edges[O],f=l.zeroCrossings[O],g=h.zeroCrossings[O],w=d.zeroCrossings[O],m=l.normals[O],x=h.normals[O],b=d.normals[O],T=y.length,N=p.length,D=0,C=0;D<T;++D)if(z=y[D],_=z+s[O],S=a[z],E=a[_],S!==E&&(S===ct.AIR||E===ct.AIR)){for(o.t=f[D],o.n.x=m[3*D],o.n.y=m[3*D+1],o.n.z=m[3*D+2],e.type===I.DIFFERENCE&&o.n.negate(),P=o;C<N&&p[C]<=z;)M=(A=p[C])+s[O],u.t=g[C],u.n.x=x[3*C],u.n.y=x[3*C+1],u.n.z=x[3*C+2],S=a[A],A<z?S===(E=a[M])||S!==ct.AIR&&E!==ct.AIR||(k[U]=A,w[U]=u.t,b[3*U]=u.n.x,b[3*U+1]=u.n.y,b[3*U+2]=u.n.z,++U):P=e.selectEdge(u,o,S===ct.SOLID),++C;k[U]=z,w[U]=P.t,b[3*U]=P.n.x,b[3*U+1]=P.n.y,b[3*U+2]=P.n.z,++U}for(;C<N;)M=(A=p[C])+s[O],(S=a[A])===(E=a[M])||S!==ct.AIR&&E!==ct.AIR||(k[U]=A,w[U]=g[C],b[3*U]=x[3*C],b[3*U+1]=x[3*C+1],b[3*U+2]=x[3*C+2],++U),++C;v[O]=U}return{edgeData:d,lengths:v}}function S(t,e,n,i){var r=t.size,s=t.resolution,a=s+1,o=a*a,u=new Uint32Array([1,a,o]),l=n.materialIndices,h=t.min,c=new lt,d=new lt,v=new Wt,y=new dt(dt.calculate1DEdgeCount(s)),f=new Uint32Array(3),m=void 0,p=void 0,g=void 0,x=void 0,k=void 0,w=void 0,b=void 0,z=void 0,_=void 0,A=void 0,M=void 0,S=void 0,E=void 0,P=void 0,I=void 0,U=void 0,O=void 0,D=void 0;for(P=4,S=0,E=0;E<3;P>>=1,S=0,++E){switch(I=$[P],m=y.edges[E],p=y.zeroCrossings[E],g=y.normals[E],w=i.min.x,_=i.max.x,b=i.min.y,A=i.max.y,z=i.min.z,M=i.max.z,E){case 0:w=Math.max(w-1,0),_=Math.min(_,s-1);break;case 1:b=Math.max(b-1,0),A=Math.min(A,s-1);break;case 2:z=Math.max(z-1,0),M=Math.min(M,s-1)}for(D=z;D<=M;++D)for(O=b;O<=A;++O)for(U=w;U<=_;++U)k=(x=D*o+O*a+U)+u[E],l[x]!==l[k]&&(c.set(U*r/s,O*r/s,D*r/s),d.set((U+I[0])*r/s,(O+I[1])*r/s,(D+I[2])*r/s),v.a.addVectors(h,c),v.b.addVectors(h,d),e.generateEdge(v),m[S]=x,p[S]=v.t,g[3*S]=v.n.x,g[3*S+1]=v.n.y,g[3*S+2]=v.n.z,++S);f[E]=S}return{edgeData:y,lengths:f}}function E(t,e,n,i){var r=z(t,e),s=void 0,a=void 0,o=void 0,u=void 0,l=!1;if(e.type===I.DENSITY_FUNCTION?A(t,e,n,r):n.empty?e.type===I.UNION&&(n.set(i),l=!0):n.full&&e.type===I.UNION||_(t,e,n,i,r),!l&&!n.empty&&!n.full){for(a=(s=e.type===I.DENSITY_FUNCTION?S(t,e,n,r):M(t,e,n,i)).edgeData,o=s.lengths,u=0;u<3;++u)a.edges[u]=a.edges[u].slice(0,o[u]),a.zeroCrossings[u]=a.zeroCrossings[u].slice(0,o[u]),a.normals[u]=a.normals[u].slice(0,3*o[u]);n.edgeData=a}}function P(t,e){var n=e.children,i=void 0,r=void 0,s=void 0,a=void 0;for(e.type===I.DENSITY_FUNCTION&&E(t,e,i=new ft),s=0,a=n.length;s<a&&(r=P(t,n[s]),void 0===i?i=r:null!==r?null===i?e.type===I.UNION&&(i=r):E(t,e,i,r):e.type===I.INTERSECTION&&(i=null),null!==i||e.type===I.UNION);++s);return null!==i&&i.empty?null:i}var I={UNION:"csg.union",DIFFERENCE:"csg.difference",INTERSECTION:"csg.intersection",DENSITY_FUNCTION:"csg.densityfunction"},U=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},O=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),D=function t(e,n,i){null===e&&(e=Function.prototype);var r=Object.getOwnPropertyDescriptor(e,n);if(void 0===r){var s=Object.getPrototypeOf(e);return null===s?void 0:t(s,n,i)}if("value"in r)return r.value;var a=r.get;if(void 0!==a)return a.call(i)},C=function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)},T=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e},N=function(t){if(Array.isArray(t)){for(var e=0,n=Array(t.length);e<t.length;e++)n[e]=t[e];return n}return Array.from(t)},R=function(){function t(){U(this,t),this.elements=[]}return O(t,[{key:"push",value:function(t){return this.elements.push(t)}},{key:"pop",value:function(){return this.elements.pop()}},{key:"combine",value:function(){var t=this.elements,e=null,n=null,i=void 0,r=void 0;for(i=0,r=t.length;i<r;++i)if(n=t[i],null!==e)switch(n.operation){case I.UNION:e.union(n);break;case I.DIFFERENCE:e.subtract(n);break;case I.INTERSECTION:e.intersect(n)}else e=n;return e}},{key:"clear",value:function(){this.elements=[]}}]),t}(),L=function(){function t(){U(this,t),this.elements=[],this.head=0,this.size=0}return O(t,[{key:"add",value:function(t){var e=this.elements.length;return this.elements.push(t),++this.size,e}},{key:"remove",value:function(t){var e=this.elements,n=e.length,i=null;if(this.size>0&&t>=0&&t<n&&null!==(i=e[t]))if(e[t]=null,--this.size>0){for(;this.head<n&&null===e[this.head];)++this.head;this.head===n&&this.clear()}else this.clear();return i}},{key:"peek",value:function(){return this.size>0?this.elements[this.head]:null}},{key:"poll",value:function(){var t=this.elements,e=t.length,n=null;if(this.size>0){for(n=t[this.head++];this.head<e&&null===t[this.head];)++this.head;this.head===e?this.clear():--this.size}return n}},{key:"clear",value:function(){this.elements=[],this.head=0,this.size=0}}]),t}(),F=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;U(this,e);var n=T(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));for(t=Math.max(1,t);t-- >0;)n.elements.push(new L);return n}return C(e,t),O(e,[{key:"add",value:function(t,e){var n=-1;return e>=0&&e<this.elements.length&&(n=this.elements[e].add(t),e>this.head&&(this.head=e),++this.size),n}},{key:"remove",value:function(t,e){var n=null;if(e>=0&&e<this.elements.length&&null!==(n=this.elements[e].remove(t)))for(--this.size;this.head>0&&0===this.elements[this.head].size;)--this.head;return n}},{key:"peek",value:function(){return this.size>0?this.elements[this.head].peek():null}},{key:"poll",value:function(){var t=null;if(this.size>0)for(t=this.elements[this.head].poll(),--this.size;this.head>0&&0===this.elements[this.head].size;)--this.head;return t}},{key:"clear",value:function(){var t=void 0;for(t=this.elements.length-1;t>=0;--t)this.elements[t].clear();this.head=0,this.size=0}},{key:"tiers",get:function(){return this.elements.length}}]),e}(L),B=function(){function t(){U(this,t)}return O(t,null,[{key:"encode",value:function(t){var e=[],n=[],i=t[0],r=1,s=void 0,a=void 0;for(s=1,a=t.length;s<a;++s)i!==t[s]?(e.push(r),n.push(i),i=t[s],r=1):++r;return e.push(r),n.push(i),{runLengths:e,data:n}}},{key:"decode",value:function(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],i=void 0,r=void 0,s=void 0,a=void 0,o=void 0,u=0;for(r=0,a=e.length;r<a;++r)for(i=e[r],s=0,o=t[r];s<o;++s)n[u++]=i;return n}}]),t}(),V=function(t){function e(t){U(this,e);var n=T(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));return n.registry=new WeakMap,n.maxPriority=n.tiers-1,n}return C(e,t),O(e,[{key:"cancel",value:function(t){var e=this.registry.has(t),n=void 0;return e&&(n=this.registry.get(t),this.remove(n.index,n.priority),this.registry.delete(t)),e}},{key:"schedule",value:function(t,e){var n=!this.registry.has(t);return n&&(null!==e&&(this.remove(e.index,e.priority),this.registry.delete(t)),e.index=this.add(e,e.priority),this.registry.set(t,e)),n}},{key:"hasTask",value:function(t){return this.registry.has(t)}},{key:"getTask",value:function(t){return this.registry.get(t)}},{key:"poll",value:function(){var t=D(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"poll",this).call(this);return null!==t&&this.registry.delete(t.chunk),t}},{key:"clear",value:function(){D(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"clear",this).call(this),this.registry=new WeakMap}}]),e}(F),q=function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;U(this,t),this.priority=e,this.index=-1},j=function t(e){U(this,t),this.type=e,this.target=null},Y=function(){function t(){U(this,t),this.m0=new Map,this.m1=new Map}return O(t,[{key:"addEventListener",value:function(t,e){var n="function"==typeof e?this.m0:this.m1;n.has(t)?n.get(t).add(e):n.set(t,new Set([e]))}},{key:"removeEventListener",value:function(t,e){var n="function"==typeof e?this.m0:this.m1,i=void 0;n.has(t)&&((i=n.get(t)).delete(e),0===i.size&&n.delete(t))}},{key:"dispatchEvent",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this,n=e.m0,i=e.m1,r=void 0;if(t.target=e,n.has(t.type)){r=n.get(t.type);var s=!0,a=!1,o=void 0;try{for(var u,l=r[Symbol.iterator]();!(s=(u=l.next()).done);s=!0)u.value.call(e,t)}catch(t){a=!0,o=t}finally{try{!s&&l.return&&l.return()}finally{if(a)throw o}}}if(i.has(t.type)){r=i.get(t.type);var h=!0,c=!1,d=void 0;try{for(var v,y=r[Symbol.iterator]();!(h=(v=y.next()).done);h=!0)v.value.handleEvent(t)}catch(t){c=!0,d=t}finally{try{!h&&y.return&&y.return()}finally{if(c)throw d}}}}}]),t}(),X="#define PHYSICAL\r\n\r\nuniform vec3 diffuse;\r\nuniform vec3 emissive;\r\nuniform float roughness;\r\nuniform float metalness;\r\nuniform float opacity;\r\n\r\n#ifndef STANDARD\r\n\tuniform float clearCoat;\r\n\tuniform float clearCoatRoughness;\r\n#endif\r\n\r\nvarying vec3 vViewPosition;\r\n\r\n#ifndef FLAT_SHADED\r\n\r\n\tvarying vec3 vNormal;\r\n\r\n#endif\r\n\r\n#include <common>\r\n#include <packing>\r\n#include <color_pars_fragment>\r\n#include <map_triplanar_pars_fragment>\r\n#include <alphamap_pars_fragment>\r\n#include <specularmap_pars_fragment>\r\n#include <lightmap_pars_fragment>\r\n#include <emissivemap_pars_fragment>\r\n#include <envmap_pars_fragment>\r\n#include <fog_pars_fragment>\r\n#include <bsdfs>\r\n#include <cube_uv_reflection_fragment>\r\n#include <lights_pars>\r\n#include <lights_physical_pars_fragment>\r\n#include <shadowmap_pars_fragment>\r\n#include <triplanar_pars_fragment>\r\n#include <normalmap_triplanar_pars_fragment>\r\n#include <roughnessmap_pars_fragment>\r\n#include <metalnessmap_pars_fragment>\r\n#include <logdepthbuf_pars_fragment>\r\n#include <clipping_planes_pars_fragment>\r\n\r\nvoid main() {\r\n\r\n\t#include <clipping_planes_fragment>\r\n\r\n\tvec4 diffuseColor = vec4( diffuse, opacity );\r\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\r\n\tvec3 totalEmissiveRadiance = emissive;\r\n\r\n\t#include <logdepthbuf_fragment>\r\n\t#include <normal_flip>\r\n\t#include <normal_triplanar_fragment>\r\n\t#include <map_triplanar_fragment>\r\n\t#include <color_fragment>\r\n\t#include <alphamap_triplanar_fragment>\r\n\t#include <alphatest_fragment>\r\n\t#include <specularmap_triplanar_fragment>\r\n\t#include <roughnessmap_triplanar_fragment>\r\n\t#include <metalnessmap_triplanar_fragment>\r\n\t#include <emissivemap_triplanar_fragment>\r\n\r\n\t// accumulation\r\n\t#include <lights_physical_fragment>\r\n\t#include <lights_template>\r\n\r\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveRadiance;\r\n\r\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\r\n\r\n\t#include <premultiplied_alpha_fragment>\r\n\t#include <tonemapping_fragment>\r\n\t#include <encodings_fragment>\r\n\t#include <fog_fragment>\r\n\r\n}\r\n",H="#define PHYSICAL\r\n\r\nvarying vec3 vViewPosition;\r\n\r\n#ifndef FLAT_SHADED\r\n\r\n\tvarying vec3 vNormal;\r\n\r\n#endif\r\n\r\n#include <common>\r\n#include <uv_pars_vertex> // offsetRepeat\r\n#include <color_pars_vertex>\r\n#include <fog_pars_vertex>\r\n#include <morphtarget_pars_vertex>\r\n#include <skinning_pars_vertex>\r\n#include <shadowmap_pars_vertex>\r\n#include <logdepthbuf_pars_vertex>\r\n#include <clipping_planes_pars_vertex>\r\n#include <triplanar_pars_vertex>\r\n\r\nvoid main() {\r\n\r\n\t#include <color_vertex>\r\n\r\n\t#include <beginnormal_vertex>\r\n\t#include <morphnormal_vertex>\r\n\t#include <skinbase_vertex>\r\n\t#include <skinnormal_vertex>\r\n\t#include <defaultnormal_vertex>\r\n\r\n#ifndef FLAT_SHADED // Normal computed with derivatives when FLAT_SHADED\r\n\r\n\tvNormal = normalize( transformedNormal );\r\n\r\n#endif\r\n\r\n\t#include <begin_vertex>\r\n\t#include <morphtarget_vertex>\r\n\t#include <skinning_vertex>\r\n\t#include <project_vertex>\r\n\t#include <logdepthbuf_vertex>\r\n\t#include <clipping_planes_vertex>\r\n\r\n\tvViewPosition = - mvPosition.xyz;\r\n\r\n\t#include <worldpos_vertex>\r\n\t#include <shadowmap_vertex>\r\n\t#include <fog_vertex>\r\n\t#include <triplanar_vertex>\r\n\r\n}\r\n";Object.assign(e.ShaderChunk,{alphamap_triplanar_fragment:"#ifdef USE_ALPHAMAP\n\n\tdiffuseColor.a *= t3( alphaMap ).g;\n\n#endif\n",emissivemap_triplanar_fragment:"#ifdef USE_EMISSIVEMAP\n\n\tvec4 emissiveColor = t3( emissiveMap );\n\n\temissiveColor.rgb = emissiveMapTexelToLinear( emissiveColor ).rgb;\n\n\ttotalEmissiveRadiance *= emissiveColor.rgb;\n\n#endif\n",map_triplanar_pars_fragment:"#ifdef USE_MAP\n\n\tuniform sampler2D map;\n\n\t#ifdef USE_MAP_Y\n\n\t\tuniform sampler2D mapY;\n\n\t#endif\n\n\t#ifdef USE_MAP_Z\n\n\t\tuniform sampler2D mapZ;\n\n\t#endif\n\n#endif\n",map_triplanar_fragment:"#ifdef USE_MAP\r\n\r\n\t#ifdef USE_MAP_Z\r\n\r\n\t\tvec4 texelColor = t3( map, mapY, mapZ );\r\n\r\n\t#elif USE_MAP_Y\r\n\r\n\t\tvec4 texelColor = t3( map, mapY );\r\n\r\n\t#else\r\n\r\n\t\tvec4 texelColor = t3( map );\r\n\r\n\t#endif\r\n\r\n\ttexelColor = mapTexelToLinear( texelColor );\r\n\tdiffuseColor *= texelColor;\r\n\r\n#endif\r\n",metalnessmap_triplanar_fragment:"float metalnessFactor = metalness;\n\n#ifdef USE_METALNESSMAP\n\n\tvec4 texelMetalness = t3( metalnessMap );\n\tmetalnessFactor *= texelMetalness.r;\n\n#endif\n",normal_triplanar_fragment:"#ifdef FLAT_SHADED\n\n\t// Workaround for Adreno/Nexus5 not able able to do dFdx( vViewPosition ) ...\n\n\tvec3 fdx = vec3( dFdx( vViewPosition.x ), dFdx( vViewPosition.y ), dFdx( vViewPosition.z ) );\n\tvec3 fdy = vec3( dFdy( vViewPosition.x ), dFdy( vViewPosition.y ), dFdy( vViewPosition.z ) );\n\tvec3 normal = normalize( cross( fdx, fdy ) );\n\n#else\n\n\tvec3 normal = normalize( vNormal ) * flipNormal;\n\n#endif\n\n#ifdef USE_NORMALMAP\n\n\tnormal = perturbNormal2Arb( normal );\n\n#endif\n",normalmap_triplanar_pars_fragment:"#ifdef USE_NORMALMAP\r\n\r\n\tuniform sampler2D normalMap;\r\n\tuniform vec2 normalScale;\r\n\r\n\t#ifdef USE_NORMALMAP_Y\r\n\r\n\t\tuniform sampler2D normalMapY;\r\n\r\n\t#endif\r\n\r\n\t#ifdef USE_NORMALMAP_Z\r\n\r\n\t\tuniform sampler2D normalMapZ;\r\n\r\n\t#endif\r\n\r\n\t// Triplanar Tangent Space Normal Mapping\r\n\t// Jaume SÃ¡nchez (https://www.clicktorelease.com/code/bumpy-metaballs/)\r\n\t// Mel (http://irrlicht.sourceforge.net/forum/viewtopic.php?t=48043)\r\n\r\n\tvec3 perturbNormal2Arb( vec3 normal ) {\r\n\r\n\t\t// Not sure why this doesn't work. Needs more testing!\r\n\t\t/*vec3 tangentX = vec3( normal.x, - normal.z, normal.y );\r\n\t\tvec3 tangentY = vec3( normal.z, normal.y, - normal.x );\r\n\t\tvec3 tangentZ = vec3( - normal.y, normal.x, normal.z );\r\n\r\n\t\tvec3 tangent = (\r\n\t\t\ttangentX * vBlend.x +\r\n\t\t\ttangentY * vBlend.y +\r\n\t\t\ttangentZ * vBlend.z\r\n\t\t); \r\n\r\n\t\tmat3 tsb = mat3(\r\n\t\t\tnormalize( tangent ),\r\n\t\t\tnormalize( cross( normal, tangent ) ),\r\n\t\t\tnormalize( normal )\r\n\t\t);*/\r\n\r\n\t\tmat3 tbn = mat3(\r\n\t\t\tnormalize( vec3( normal.y + normal.z, 0.0, normal.x ) ),\r\n\t\t\tnormalize( vec3( 0.0, normal.x + normal.z, normal.y ) ),\r\n\t\t\tnormal\r\n\t\t);\r\n\r\n\t\t#ifdef USE_NORMALMAP_Z\r\n\r\n\t\t\tvec3 mapN = t3( normalMap, normalMapY, normalMapZ ).xyz;\r\n\r\n\t\t#elif USE_NORMALMAP_Y\r\n\r\n\t\t\tvec3 mapN = t3( normalMap, normalMapY ).xyz;\r\n\r\n\t\t#else\r\n\r\n\t\t\tvec3 mapN = t3( normalMap ).xyz;\r\n\r\n\t\t#endif\r\n\r\n\t\t// Expand and scale the vector.\r\n\t\tmapN = mapN * 2.0 - 1.0;\r\n\t\tmapN.xy *= normalScale;\r\n\r\n\t\treturn normalize( tbn * mapN );\r\n\r\n\t}\r\n\r\n#endif\r\n",roughnessmap_triplanar_fragment:"float roughnessFactor = roughness;\n\n#ifdef USE_ROUGHNESSMAP\n\n\tvec4 texelRoughness = t3( roughnessMap );\n\troughnessFactor *= texelRoughness.r;\n\n#endif\n",specularmap_triplanar_fragment:"float specularStrength;\n\n#ifdef USE_SPECULARMAP\n\n\tvec4 texelSpecular = t3( specularMap );\n\tspecularStrength = texelSpecular.r;\n\n#else\n\n\tspecularStrength = 1.0;\n\n#endif",triplanar_pars_fragment:"#if defined( USE_MAP ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( USE_SPECULARMAP ) || defined( USE_ALPHAMAP ) || defined( USE_EMISSIVEMAP ) || defined( USE_ROUGHNESSMAP ) || defined( USE_METALNESSMAP )\r\n\r\n\tvarying vec3 vBlend;\r\n\tvarying vec2 vCoords[3];\r\n\r\n\tvec4 t3( sampler2D mapX, sampler2D mapY, sampler2D mapZ ) {\r\n\r\n\t\tvec4 xAxis = texture2D( mapX, vCoords[0] );\r\n\t\tvec4 yAxis = texture2D( mapY, vCoords[1] );\r\n\t\tvec4 zAxis = texture2D( mapZ, vCoords[2] );\r\n\r\n\t\treturn (\r\n\t\t\txAxis * vBlend.x +\r\n\t\t\tyAxis * vBlend.y +\r\n\t\t\tzAxis * vBlend.z\r\n\t\t);\r\n\r\n\t}\r\n\r\n\tvec4 t3( sampler2D mapX, sampler2D mapYZ ) {\r\n\r\n\t\treturn t3( mapX, mapYZ, mapYZ );\r\n\r\n\t}\r\n\r\n\tvec4 t3( sampler2D mapXYZ ) {\r\n\r\n\t\treturn t3( mapXYZ, mapXYZ, mapXYZ );\r\n\r\n\t}\r\n\r\n#endif\r\n",triplanar_pars_vertex:"#if defined( USE_MAP ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( USE_SPECULARMAP ) || defined( USE_ALPHAMAP ) || defined( USE_EMISSIVEMAP ) || defined( USE_ROUGHNESSMAP ) || defined( USE_METALNESSMAP )\r\n\r\n\tvarying vec3 vBlend;\r\n\tvarying vec2 vCoords[3];\r\n\r\n\tvec3 computeTriplanarBlend( vec3 normal ) {\r\n\r\n\t\t// Voxel-Based Terrain for Real-Time Virtual Simulations (Ch. 5).\r\n\t\tvec3 blend = saturate( abs( normal ) - 0.5 );\r\n\r\n\t\t// Raise each component of the normal vector to the 4th power.\r\n\t\tblend *= blend;\r\n\t\tblend *= blend;\r\n\r\n\t\t// Normalize the result by dividing by the sum of its components.\r\n\t\tblend /= dot( blend, vec3( 1.0 ) );\r\n\r\n\t\t// GPU Gems 3 (Ch. 1).\r\n\t\t//vec3 blend = abs( normal );\r\n\t\t//blend = ( blend - 0.2 ) * 7.0;  \r\n\t\t//blend = max( blend, 0.0 );\r\n\t\t//blend /= ( blend.x + blend.y + blend.z );\r\n\r\n\t\treturn blend;\r\n\r\n\t}\r\n\r\n#endif\r\n",triplanar_vertex:"#if defined( USE_MAP ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( USE_SPECULARMAP ) || defined( USE_ALPHAMAP ) || defined( USE_EMISSIVEMAP ) || defined( USE_ROUGHNESSMAP ) || defined( USE_METALNESSMAP )\r\n\r\n\tvCoords[0] = worldPosition.yz * offsetRepeat.zw + offsetRepeat.xy;\r\n\tvCoords[1] = worldPosition.zx * offsetRepeat.zw + offsetRepeat.xy;\r\n\tvCoords[2] = worldPosition.xy * offsetRepeat.zw + offsetRepeat.xy;\r\n\r\n\tvBlend = computeTriplanarBlend( normal );\r\n\r\n#endif\r\n"});var Z=function(t){function n(){U(this,n);var t=T(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,{type:"MeshTriplanarPhysicalMaterial",defines:{PHYSICAL:""},uniforms:{mapY:new e.Uniform(null),mapZ:new e.Uniform(null),normalMapY:new e.Uniform(null),normalMapZ:new e.Uniform(null)},fragmentShader:X,vertexShader:H,lights:!0,fog:!0})),i=e.ShaderLib.physical.uniforms,r=t.uniforms;return Object.keys(i).forEach(function(t){var n=i[t].value,s=new e.Uniform(n);Object.defineProperty(r,t,{value:null===n?s:s.clone()})}),t.envMap=null,t}return C(n,t),O(n,[{key:"setMaps",value:function(t,e,n){var i=this.defines,r=this.uniforms;void 0!==t&&(i.USE_MAP="",r.map.value=t),void 0!==e&&(i.USE_MAP_Y="",r.mapY.value=e),void 0!==n&&(i.USE_MAP_Z="",r.mapZ.value=n),this.needsUpdate=!0}},{key:"setNormalMaps",value:function(t,e,n){var i=this.defines,r=this.uniforms;void 0!==t&&(i.USE_NORMALMAP="",r.normalMap.value=t),void 0!==e&&(i.USE_NORMALMAP_Y="",r.normalMapY.value=e),void 0!==n&&(i.USE_NORMALMAP_Z="",r.normalMapZ.value=n),this.needsUpdate=!0}}]),n}(e.ShaderMaterial),G=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;U(this,t),this.x=e,this.y=n,this.z=i}return O(t,[{key:"set",value:function(t,e,n){return this.x=t,this.y=e,this.z=n,this}},{key:"copy",value:function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this}},{key:"fromArray",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return this.x=t[e],this.y=t[e+1],this.z=t[e+2],this}},{key:"toArray",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return t[e]=this.x,t[e+1]=this.y,t[e+2]=this.z,t}},{key:"equals",value:function(t){return t.x===this.x&&t.y===this.y&&t.z===this.z}},{key:"clone",value:function(){return new this.constructor(this.x,this.y,this.z)}},{key:"add",value:function(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this}},{key:"addScaledVector",value:function(t,e){return this.x+=t.x*e,this.y+=t.y*e,this.z+=t.z*e,this}},{key:"addScalar",value:function(t){return this.x+=t,this.y+=t,this.z+=t,this}},{key:"addVectors",value:function(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this}},{key:"sub",value:function(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this}},{key:"subScalar",value:function(t){return this.x-=t,this.y-=t,this.z-=t,this}},{key:"subVectors",value:function(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this}},{key:"multiply",value:function(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this}},{key:"multiplyScalar",value:function(t){return isFinite(t)?(this.x*=t,this.y*=t,this.z*=t):(this.x=0,this.y=0,this.z=0),this}},{key:"multiplyVectors",value:function(t,e){return this.x=t.x*e.x,this.y=t.y*e.y,this.z=t.z*e.z,this}},{key:"divide",value:function(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this}},{key:"divideScalar",value:function(t){return this.multiplyScalar(1/t)}},{key:"divideVectors",value:function(t,e){return this.x=t.x/e.x,this.y=t.y/e.y,this.z=t.z/e.z,this}},{key:"negate",value:function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}},{key:"dot",value:function(t){return this.x*t.x+this.y*t.y+this.z*t.z}},{key:"lengthSq",value:function(){return this.x*this.x+this.y*this.y+this.z*this.z}},{key:"length",value:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}},{key:"distanceTo",value:function(t){return Math.sqrt(this.distanceToSquared(t))}},{key:"distanceToSquared",value:function(t){var e=this.x-t.x,n=this.y-t.y,i=this.z-t.z;return e*e+n*n+i*i}},{key:"normalize",value:function(){return this.divideScalar(this.length())}},{key:"min",value:function(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this.z=Math.min(this.z,t.z),this}},{key:"max",value:function(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this.z=Math.max(this.z,t.z),this}},{key:"clamp",value:function(t,e){return this.x=Math.max(t.x,Math.min(e.x,this.x)),this.y=Math.max(t.y,Math.min(e.y,this.y)),this.z=Math.max(t.z,Math.min(e.z,this.z)),this}},{key:"applyMatrix3",value:function(t){var e=this.x,n=this.y,i=this.z,r=t.elements;return this.x=r[0]*e+r[3]*n+r[6]*i,this.y=r[1]*e+r[4]*n+r[7]*i,this.z=r[2]*e+r[5]*n+r[8]*i,this}},{key:"applyMatrix4",value:function(t){var e=this.x,n=this.y,i=this.z,r=t.elements;return this.x=r[0]*e+r[4]*n+r[8]*i+r[12],this.y=r[1]*e+r[5]*n+r[9]*i+r[13],this.z=r[2]*e+r[6]*n+r[10]*i+r[14],this}}]),t}(),W=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new G,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new G;U(this,t),this.min=e,this.max=n,this.children=null}return O(t,[{key:"getCenter",value:function(){return this.min.clone().add(this.max).multiplyScalar(.5)}},{key:"getDimensions",value:function(){return this.max.clone().sub(this.min)}},{key:"split",value:function(t){var e=this.min,n=this.max,i=this.getCenter(),r=void 0,s=void 0,a=0,o=void 0,u=void 0,l=void 0,h=void 0,c=void 0;for(Array.isArray(t)&&(u=this.getDimensions().multiplyScalar(.5),l=[new G,new G,new G],a=t.length),this.children=[],r=0;r<8;++r){if(o=$[r],c=null,a>0)for(l[1].addVectors(e,l[0].fromArray(o).multiply(u)),l[2].addVectors(i,l[0].fromArray(o).multiply(u)),s=0;s<a;++s)if(null!==(h=t[s])&&l[1].equals(h.min)&&l[2].equals(h.max)){c=h,t[s]=null;break}this.children.push(null!==c?c:new this.constructor(new G(0===o[0]?e.x:i.x,0===o[1]?e.y:i.y,0===o[2]?e.z:i.z),new G(0===o[0]?i.x:n.x,0===o[1]?i.y:n.y,0===o[2]?i.z:n.z)))}}}]),t}(),$=[new Uint8Array([0,0,0]),new Uint8Array([0,0,1]),new Uint8Array([0,1,0]),new Uint8Array([0,1,1]),new Uint8Array([1,0,0]),new Uint8Array([1,0,1]),new Uint8Array([1,1,0]),new Uint8Array([1,1,1])],J=[new Uint8Array([0,4]),new Uint8Array([1,5]),new Uint8Array([2,6]),new Uint8Array([3,7]),new Uint8Array([0,2]),new Uint8Array([1,3]),new Uint8Array([4,6]),new Uint8Array([5,7]),new Uint8Array([0,1]),new Uint8Array([2,3]),new Uint8Array([4,5]),new Uint8Array([6,7])],K=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new G,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;U(this,t),this.min=e,this.size=n,this.children=null}return O(t,[{key:"getCenter",value:function(){return this.min.clone().addScalar(.5*this.size)}},{key:"getDimensions",value:function(){return new G(this.size,this.size,this.size)}},{key:"split",value:function(t){var e=this.min,n=this.getCenter(),i=.5*this.size,r=void 0,s=void 0,a=0,o=void 0,u=void 0,l=void 0,h=void 0;for(Array.isArray(t)&&(u=new G,a=t.length),this.children=[],r=0;r<8;++r){if(o=$[r],h=null,a>0)for(u.fromArray(o).multiplyScalar(i).add(e),s=0;s<a;++s)if(null!==(l=t[s])&&l.size===i&&u.equals(l.min)){h=l,t[s]=null;break}this.children.push(null!==h?h:new this.constructor(new G(0===o[0]?e.x:n.x,0===o[1]?e.y:n.y,0===o[2]?e.z:n.z),i))}}},{key:"max",get:function(){return this.min.clone().addScalar(this.size)}}]),t}(),Q=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new G(1/0,1/0,1/0),n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new G(-1/0,-1/0,-1/0);U(this,t),this.min=e,this.max=n}return O(t,[{key:"set",value:function(t,e){return this.min.copy(t),this.max.copy(e),this}},{key:"copy",value:function(t){return this.min.copy(t.min),this.max.copy(t.max),this}},{key:"clone",value:function(){return(new this.constructor).copy(this)}},{key:"expandByPoint",value:function(t){return this.min.min(t),this.max.max(t),this}},{key:"union",value:function(t){return this.min.min(t.min),this.max.max(t.max),this}},{key:"setFromPoints",value:function(t){var e=void 0,n=void 0;for(e=0,n=t.length;e<n;++e)this.expandByPoint(t[e]);return this}},{key:"setFromCenterAndSize",value:function(t,e){var n=e.clone().multiplyScalar(.5);return this.min.copy(t).sub(n),this.max.copy(t).add(n),this}},{key:"intersectsBox",value:function(t){return!(t.max.x<this.min.x||t.min.x>this.max.x||t.max.y<this.min.y||t.min.y>this.max.y||t.max.z<this.min.z||t.min.z>this.max.z)}}]),t}(),tt=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,n=arguments.length>1&&void 0!==arguments[1]&&arguments[1];U(this,t),this.value=e,this.done=n}return O(t,[{key:"reset",value:function(){this.value=null,this.done=!1}}]),t}(),et=new Q,nt=function(){function t(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;U(this,t),this.octree=e,this.region=n,this.cull=null!==n,this.result=new tt,this.trace=null,this.indices=null,this.reset()}return O(t,[{key:"reset",value:function(){var t=this.octree.root;return this.trace=[],this.indices=[],null!==t&&(et.min=t.min,et.max=t.max,this.cull&&!this.region.intersectsBox(et)||(this.trace.push(t),this.indices.push(0))),this.result.reset(),this}},{key:"next",value:function(){for(var t=this.cull,e=this.region,n=this.indices,i=this.trace,r=null,s=i.length-1,a=void 0,o=void 0,u=void 0;null===r&&s>=0;)if(a=n[s],o=i[s].children,++n[s],a<8)if(null!==o){if(u=o[a],t&&(et.min=u.min,et.max=u.max,!e.intersectsBox(et)))continue;i.push(u),n.push(0),++s}else r=i.pop(),n.pop();else i.pop(),n.pop(),--s;return this.result.value=r,this.result.done=null===r,this.result}},{key:"return",value:function(t){return this.result.value=t,this.result.done=!0,this.result}},{key:Symbol.iterator,value:function(){return this}}]),t}(),it=new Uint8Array([0,1,2,3,4,5,6,7,0]),rt=[new Uint8Array([4,2,1]),new Uint8Array([5,3,8]),new Uint8Array([6,8,3]),new Uint8Array([7,8,8]),new Uint8Array([8,6,5]),new Uint8Array([8,7,8]),new Uint8Array([8,8,7]),new Uint8Array([8,8,8])],st=function(){function t(){U(this,t)}return O(t,null,[{key:"intersectOctree",value:function(t,e,n){var i=t.getDimensions(),s=i.clone().multiplyScalar(.5),a=t.min.clone().sub(t.min),o=t.max.clone().sub(t.min),u=e.ray.direction.clone(),l=e.ray.origin.clone();l.sub(t.getCenter()).add(s);var h=void 0,c=void 0,d=void 0,v=void 0,y=void 0,f=void 0,m=void 0,p=void 0,g=void 0;it[8]=it[0],u.x<0&&(l.x=i.x-l.x,u.x=-u.x,it[8]|=it[4]),u.y<0&&(l.y=i.y-l.y,u.y=-u.y,it[8]|=it[2]),u.z<0&&(l.z=i.z-l.z,u.z=-u.z,it[8]|=it[1]),h=1/u.x,c=1/u.y,d=1/u.z,v=(a.x-l.x)*h,y=(o.x-l.x)*h,f=(a.y-l.y)*c,m=(o.y-l.y)*c,p=(a.z-l.z)*d,g=(o.z-l.z)*d,Math.max(Math.max(v,f),p)<Math.min(Math.min(y,m),g)&&r(t.root,v,f,p,y,m,g,e,n)}}]),t}(),at=new Q,ot=function(){function t(e,n){U(this,t),this.root=void 0!==e&&void 0!==n?new W(e,n):null}return O(t,[{key:"getCenter",value:function(){return this.root.getCenter()}},{key:"getDimensions",value:function(){return this.root.getDimensions()}},{key:"getDepth",value:function(){return s(this.root)}},{key:"cull",value:function(t){var e=[];return a(this.root,t,e),e}},{key:"findOctantsByLevel",value:function(t){var e=[];return o(this.root,t,0,e),e}},{key:"raycast",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];return st.intersectOctree(this,t,e),e}},{key:"leaves",value:function(t){return new nt(this,t)}},{key:Symbol.iterator,value:function(){return new nt(this)}},{key:"min",get:function(){return this.root.min}},{key:"max",get:function(){return this.root.max}},{key:"children",get:function(){return this.root.children}}]),t}(),ut=function(t){function e(t,n){U(this,e);var i=T(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n));return i.points=null,i.data=null,i}return C(e,t),O(e,[{key:"distanceToSquared",value:function(t){return t.clone().clamp(this.min,this.max).sub(t).lengthSq()}},{key:"distanceToCenterSquared",value:function(t){var e=this.getCenter(),n=t.x-e.x,i=t.y-e.x,r=t.z-e.z;return n*n+i*i+r*r}},{key:"contains",value:function(t,e){var n=this.min,i=this.max;return t.x>=n.x-e&&t.y>=n.y-e&&t.z>=n.z-e&&t.x<=i.x+e&&t.y<=i.y+e&&t.z<=i.z+e}},{key:"redistribute",value:function(t){var e=this.children,n=this.points,i=this.data,r=void 0,s=void 0,a=void 0,o=void 0,u=void 0;if(null!==e)for(;n.length>0;)for(o=n.pop(),u=i.pop(),r=0,s=e.length;r<s;++r)if((a=e[r]).contains(o,t)){null===a.points&&(a.points=[],a.data=[]),a.points.push(o),a.data.push(u);break}this.points=null,this.data=null}},{key:"merge",value:function(){var t=this.children,e=void 0,n=void 0,i=void 0;if(null!==t){for(this.points=[],this.data=[],e=0,n=t.length;e<n;++e)if(null!==(i=t[e]).points){var r,s;(r=this.points).push.apply(r,N(i.points)),(s=this.data).push.apply(s,N(i.data))}this.children=null}}}]),e}(W),lt=(function(t){function e(t,n){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:8,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:8;U(this,e);var a=T(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return a.root=new ut(t,n),a.bias=Math.max(0,i),a.biasSquared=a.bias*a.bias,a.maxPoints=Math.max(1,Math.round(r)),a.maxDepth=Math.max(0,Math.round(s)),a}C(e,t),O(e,[{key:"countPoints",value:function(){return u(this.root)}},{key:"add",value:function(t,e){l(this.root,t,e,0,this.bias,this.maxPoints,this.maxDepth)}},{key:"remove",value:function(t){h(this.root,null,t,this.bias,this.maxPoints)}},{key:"fetch",value:function(t){return c(this.root,t,this.bias,this.biasSquared)}},{key:"findNearestPoint",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1/0,n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return d(this.root,t,e,n)}},{key:"findPoints",value:function(t,e){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=[];return v(this.root,t,e,n,i),i}},{key:"raycast",value:function(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],i=D(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"raycast",this).call(this,t);return i.length>0&&this.testPoints(i,t,n),n}},{key:"testPoints",value:function(t,e,n){var i=e.params.Points.threshold,r=i*i,s=void 0,a=void 0,o=void 0,u=void 0,l=void 0,h=void 0,c=void 0,d=void 0,v=void 0,y=void 0,f=void 0;for(l=0,c=t.length;l<c;++l)if(v=t[l],null!==(y=v.points))for(h=0,d=y.length;h<d;++h)f=y[h],(u=e.ray.distanceSqToPoint(f))<r&&(s=e.ray.closestPointToPoint(f),(a=e.ray.origin.distanceTo(s))>=e.near&&a<=e.far&&(o=Math.sqrt(u),n.push({distance:a,distanceToRay:o,point:s.clone(),object:v.data[h]})))}}])}(ot),function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;U(this,t),this.x=e,this.y=n,this.z=i}return O(t,[{key:"set",value:function(t,e,n){return this.x=t,this.y=e,this.z=n,this}},{key:"copy",value:function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this}},{key:"fromArray",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return this.x=t[e],this.y=t[e+1],this.z=t[e+2],this}},{key:"toArray",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return t[e]=this.x,t[e+1]=this.y,t[e+2]=this.z,t}},{key:"equals",value:function(t){return t.x===this.x&&t.y===this.y&&t.z===this.z}},{key:"clone",value:function(){return new this.constructor(this.x,this.y,this.z)}},{key:"add",value:function(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this}},{key:"addScaledVector",value:function(t,e){return this.x+=t.x*e,this.y+=t.y*e,this.z+=t.z*e,this}},{key:"addScalar",value:function(t){return this.x+=t,this.y+=t,this.z+=t,this}},{key:"addVectors",value:function(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this}},{key:"sub",value:function(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this}},{key:"subScalar",value:function(t){return this.x-=t,this.y-=t,this.z-=t,this}},{key:"subVectors",value:function(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this}},{key:"multiply",value:function(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this}},{key:"multiplyScalar",value:function(t){return isFinite(t)?(this.x*=t,this.y*=t,this.z*=t):(this.x=0,this.y=0,this.z=0),this}},{key:"multiplyVectors",value:function(t,e){return this.x=t.x*e.x,this.y=t.y*e.y,this.z=t.z*e.z,this}},{key:"divide",value:function(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this}},{key:"divideScalar",value:function(t){return this.multiplyScalar(1/t)}},{key:"divideVectors",value:function(t,e){return this.x=t.x/e.x,this.y=t.y/e.y,this.z=t.z/e.z,this}},{key:"negate",value:function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}},{key:"dot",value:function(t){return this.x*t.x+this.y*t.y+this.z*t.z}},{key:"lengthSq",value:function(){return this.x*this.x+this.y*this.y+this.z*this.z}},{key:"length",value:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}},{key:"distanceTo",value:function(t){return Math.sqrt(this.distanceToSquared(t))}},{key:"distanceToSquared",value:function(t){var e=this.x-t.x,n=this.y-t.y,i=this.z-t.z;return e*e+n*n+i*i}},{key:"normalize",value:function(){return this.divideScalar(this.length())}},{key:"min",value:function(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this.z=Math.min(this.z,t.z),this}},{key:"max",value:function(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this.z=Math.max(this.z,t.z),this}},{key:"clamp",value:function(t,e){return this.x=Math.max(t.x,Math.min(e.x,this.x)),this.y=Math.max(t.y,Math.min(e.y,this.y)),this.z=Math.max(t.z,Math.min(e.z,this.z)),this}},{key:"applyMatrix3",value:function(t){var e=this.x,n=this.y,i=this.z,r=t.elements;return this.x=r[0]*e+r[3]*n+r[6]*i,this.y=r[1]*e+r[4]*n+r[7]*i,this.z=r[2]*e+r[5]*n+r[8]*i,this}},{key:"applyMatrix4",value:function(t){var e=this.x,n=this.y,i=this.z,r=t.elements;return this.x=r[0]*e+r[4]*n+r[8]*i+r[12],this.y=r[1]*e+r[5]*n+r[9]*i+r[13],this.z=r[2]*e+r[6]*n+r[10]*i+r[14],this}}]),t}()),ht=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new lt(1/0,1/0,1/0),n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new lt(-1/0,-1/0,-1/0);U(this,t),this.min=e,this.max=n}return O(t,[{key:"set",value:function(t,e){return this.min.copy(t),this.max.copy(e),this}},{key:"copy",value:function(t){return this.min.copy(t.min),this.max.copy(t.max),this}},{key:"clone",value:function(){return(new this.constructor).copy(this)}},{key:"expandByPoint",value:function(t){return this.min.min(t),this.max.max(t),this}},{key:"union",value:function(t){return this.min.min(t.min),this.max.max(t.max),this}},{key:"setFromPoints",value:function(t){var e=void 0,n=void 0;for(e=0,n=t.length;e<n;++e)this.expandByPoint(t[e]);return this}},{key:"setFromCenterAndSize",value:function(t,e){var n=e.clone().multiplyScalar(.5);return this.min.copy(t).sub(n),this.max.copy(t).add(n),this}},{key:"intersectsBox",value:function(t){return!(t.max.x<this.min.x||t.min.x>this.max.x||t.max.y<this.min.y||t.min.y>this.max.y||t.max.z<this.min.z||t.min.z>this.max.z)}}]),t}(),ct={AIR:0,SOLID:1},dt=function(){function t(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e;U(this,t),this.edges=[new Uint32Array(e),new Uint32Array(n),new Uint32Array(i)],this.zeroCrossings=[new Float32Array(e),new Float32Array(n),new Float32Array(i)],this.normals=[new Float32Array(3*e),new Float32Array(3*n),new Float32Array(3*i)]}return O(t,[{key:"createTransferList",value:function(){for(var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],e=[this.edges[0],this.edges[1],this.edges[2],this.zeroCrossings[0],this.zeroCrossings[1],this.zeroCrossings[2],this.normals[0],this.normals[1],this.normals[2]],n=void 0;e.length>0;)null!==(n=e.pop())&&t.push(n.buffer);return t}},{key:"serialise",value:function(){return{edges:this.edges,zeroCrossings:this.zeroCrossings,normals:this.normals}}},{key:"deserialise",value:function(t){this.edges=t.edges,this.zeroCrossings=t.zeroCrossings,this.normals=t.normals}}],[{key:"calculate1DEdgeCount",value:function(t){return Math.pow(t+1,2)*t}}]),t}(),vt=0,yt=0,ft=function(){function t(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];U(this,t),this.lod=-1,this.neutered=!1,this.materials=0,this.materialIndices=e?new Uint8Array(yt):null,this.runLengths=null,this.edgeData=null}return O(t,[{key:"set",value:function(t){return this.lod=t.lod,this.neutered=t.neutered,this.materials=t.materials,this.materialIndices=t.materialIndices,this.runLengths=t.runLengths,this.edgeData=t.edgeData,this}},{key:"setMaterialIndex",value:function(t,e){this.materialIndices[t]===ct.AIR?e!==ct.AIR&&++this.materials:e===ct.AIR&&--this.materials,this.materialIndices[t]=e}},{key:"compress",value:function(){var t=void 0;return null===this.runLengths&&(t=this.full?{runLengths:[this.materialIndices.length],data:[ct.SOLID]}:B.encode(this.materialIndices),this.runLengths=new Uint32Array(t.runLengths),this.materialIndices=new Uint8Array(t.data)),this}},{key:"decompress",value:function(){return null!==this.runLengths&&(this.materialIndices=B.decode(this.runLengths,this.materialIndices,new Uint8Array(yt)),this.runLengths=null),this}},{key:"createTransferList",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];return null!==this.edgeData&&this.edgeData.createTransferList(t),t.push(this.materialIndices.buffer),t.push(this.runLengths.buffer),t}},{key:"serialise",value:function(){return this.neutered=!0,{lod:this.lod,materials:this.materials,materialIndices:this.materialIndices,runLengths:this.runLengths,edgeData:null!==this.edgeData?this.edgeData.serialise():null}}},{key:"deserialise",value:function(t){this.lod=t.lod,this.materials=t.materials,this.materialIndices=t.materialIndices,this.runLengths=t.runLengths,null!==t.edgeData?(null===this.edgeData&&(this.edgeData=new dt(0)),this.edgeData.deserialise(t.edgeData)):this.edgeData=null,this.neutered=!1}},{key:"empty",get:function(){return 0===this.materials}},{key:"full",get:function(){return this.materials===yt}}],[{key:"resolution",get:function(){return vt},set:function(t){0===vt&&(vt=Math.max(1,Math.min(256,t)),yt=Math.pow(vt+1,3))}}]),t}(),mt=function(t){function e(t,n){U(this,e);var i=T(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n));return i.data=null,i.csg=null,i}return C(e,t),O(e,[{key:"createTransferList",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];return null!==this.data?this.data.createTransferList(t):t}},{key:"serialise",value:function(){return{resolution:this.resolution,min:this.min.toArray(),size:this.size,data:null!==this.data?this.data.serialise():null}}},{key:"deserialise",value:function(t){this.resolution=t.resolution,this.min.fromArray(t.min),this.size=t.size,null!==t.data?(null===this.data&&(this.data=new ft(!1)),this.data.deserialise(t.data)):this.data=null}},{key:"resolution",get:function(){return ft.resolution},set:function(t){ft.resolution=t}}]),e}(K),pt=new ht,gt=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:32,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:32;U(this,e);var i=T(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return i.root=new mt,i.chunkSize=Math.max(1,y(t)),i.min.subScalar(2*i.chunkSize),i.size=4*i.chunkSize,i.root.resolution=y(n),i}return C(e,t),O(e,[{key:"grow",value:function(t,e,n,i){var r=t.children,s=void 0,a=void 0;if(pt.min=t.min,pt.max=t.max,e.intersectsBox(pt))if(null===r&&t.size>n&&(t.split(),r=t.children),null!==r)for(s=0,a=r.length;s<a;++s)this.grow(r[s],e,n,i);else i.push(t)}},{key:"edit",value:function(t){var e=t.completeBoundingBox,n=[];return t.operation===I.UNION?(this.expand(e),this.grow(this.root,e,this.chunkSize,n)):n=t.operation===I.DIFFERENCE?this.leaves(e):this.leaves(),n}},{key:"expand",value:function(t){var e=t.min,n=t.max,i=Math.max(Math.max(Math.max(Math.abs(e.x),Math.abs(e.y)),Math.abs(e.z)),Math.max(Math.max(Math.abs(n.x),Math.abs(n.y)),Math.abs(n.z))),r=this.size/2,s=this.children,a=void 0,o=void 0;if(i>r)if(a=y(Math.ceil(i/this.chunkSize)*this.chunkSize),null===s)this.min.set(-a,-a,-a),this.size=2*a;else for(;r<a;){for(r=this.size,this.min.multiplyScalar(2),this.size*=2,this.root.split(),o=0;o<8;++o)null!==s[o].children&&this.children[o].split([s[o]]);s=this.children}}},{key:"prune",value:function(t){}},{key:"load",value:function(t){mt.resolution=t.resolution,this.chunkSize=t.chunkSize,this.root=t.root}},{key:"toJSON",value:function(){return{resolution:mt.resolution,chunkSize:this.chunkSize,root:this.root}}},{key:"size",get:function(){return this.root.size},set:function(t){this.root.size=t}},{key:"resolution",get:function(){return this.root.resolution}}]),e}(ot),xt={SPHERE:"sdf.sphere",BOX:"sdf.box",TORUS:"sdf.torus",PLANE:"sdf.plane",HEIGHTFIELD:"sdf.heightfield"},kt=function(){function t(e){U(this,t),this.type=e;for(var n=arguments.length,i=Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];this.children=i,this.bbox=null}return O(t,[{key:"computeBoundingBox",value:function(){var t=this.children,e=void 0,n=void 0;for(this.bbox=new ht,e=0,n=t.length;e<n;++e)this.bbox.union(t[e].boundingBox);return this.bbox}},{key:"boundingBox",get:function(){return null!==this.bbox?this.bbox:this.computeBoundingBox()}}]),t}(),wt=function(t){function e(){var t;U(this,e);for(var n=arguments.length,i=Array(n),r=0;r<n;r++)i[r]=arguments[r];return T(this,(t=e.__proto__||Object.getPrototypeOf(e)).call.apply(t,[this,I.UNION].concat(i)))}return C(e,t),O(e,[{key:"updateMaterialIndex",value:function(t,e,n){var i=n.materialIndices[t];i!==ct.AIR&&e.setMaterialIndex(t,i)}},{key:"selectEdge",value:function(t,e,n){return n?t.t>e.t?t:e:t.t<e.t?t:e}}]),e}(kt),bt=function(t){function e(){var t;U(this,e);for(var n=arguments.length,i=Array(n),r=0;r<n;r++)i[r]=arguments[r];return T(this,(t=e.__proto__||Object.getPrototypeOf(e)).call.apply(t,[this,I.DIFFERENCE].concat(i)))}return C(e,t),O(e,[{key:"updateMaterialIndex",value:function(t,e,n){n.materialIndices[t]!==ct.AIR&&e.setMaterialIndex(t,ct.AIR)}},{key:"selectEdge",value:function(t,e,n){return n?t.t<e.t?t:e:t.t>e.t?t:e}}]),e}(kt),zt=function(t){function e(){var t;U(this,e);for(var n=arguments.length,i=Array(n),r=0;r<n;r++)i[r]=arguments[r];return T(this,(t=e.__proto__||Object.getPrototypeOf(e)).call.apply(t,[this,I.INTERSECTION].concat(i)))}return C(e,t),O(e,[{key:"updateMaterialIndex",value:function(t,e,n){var i=n.materialIndices[t];e.setMaterialIndex(t,e.materialIndices[t]!==ct.AIR&&i!==ct.AIR?i:ct.AIR)}},{key:"selectEdge",value:function(t,e,n){return n?t.t<e.t?t:e:t.t>e.t?t:e}}]),e}(kt),_t=function(t){function e(t){U(this,e);var n=T(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,I.DENSITY_FUNCTION));return n.sdf=t,n}return C(e,t),O(e,[{key:"computeBoundingBox",value:function(){return this.bbox=this.sdf.computeBoundingBox(),this.bbox}},{key:"generateMaterialIndex",value:function(t){return this.sdf.sample(t)<=0?this.sdf.material:ct.AIR}},{key:"generateEdge",value:function(t){t.approximateZeroCrossing(this.sdf),t.computeSurfaceNormal(this.sdf)}}]),e}(kt),At=function(){function t(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:ct.SOLID;U(this,t),this.type=e,this.operation=null,this.material=Math.min(255,Math.max(ct.SOLID,Math.trunc(n))),this.children=[],this.bbox=null}return O(t,[{key:"union",value:function(t){return t.operation=I.UNION,this.children.push(t),this}},{key:"subtract",value:function(t){return t.operation=I.DIFFERENCE,this.children.push(t),this}},{key:"intersect",value:function(t){return t.operation=I.INTERSECTION,this.children.push(t),this}},{key:"serialise",value:function(){var t={type:this.type,operation:this.operation,material:this.material,parameters:null,children:[]},e=this.children,n=void 0,i=void 0;for(n=0,i=e.length;n<i;++n)t.children.push(e[n].serialise());return t}},{key:"toCSG",value:function(){var t=this.children,e=new _t(this),n=void 0,i=void 0,r=void 0,s=void 0;for(r=0,s=t.length;r<s;++r){if(i=t[r],n!==i.operation)switch(n=i.operation){case I.UNION:e=new wt(e);break;case I.DIFFERENCE:e=new bt(e);break;case I.INTERSECTION:e=new zt(e)}e.children.push(i.toCSG())}return e}},{key:"computeBoundingBox",value:function(){throw new Error("SDF: bounding box method not implemented!")}},{key:"sample",value:function(t){throw new Error("SDF: sample method not implemented!")}},{key:"boundingBox",get:function(){return null!==this.bbox?this.bbox:this.computeBoundingBox()}},{key:"completeBoundingBox",get:function(){var t=this.children,e=this.boundingBox.clone(),n=void 0,i=void 0;for(n=0,i=t.length;n<i;++n)e.union(t[n].completeBoundingBox);return e}}]),t}(),Mt=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments[1];U(this,e);var i=T(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,xt.SPHERE,n));return i.origin=new(Function.prototype.bind.apply(lt,[null].concat(N(t.origin)))),i.radius=t.radius,i}return C(e,t),O(e,[{key:"computeBoundingBox",value:function(){return this.bbox=new ht,this.bbox.min.copy(this.origin).subScalar(this.radius),this.bbox.max.copy(this.origin).addScalar(this.radius),this.bbox}},{key:"sample",value:function(t){var e=this.origin,n=t.x-e.x,i=t.y-e.y,r=t.z-e.z;return Math.sqrt(n*n+i*i+r*r)-this.radius}},{key:"serialise",value:function(){var t=D(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"serialise",this).call(this);return t.parameters={origin:this.origin.toArray(),radius:this.radius},t}}]),e}(At),St=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments[1];U(this,e);var i=T(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,xt.BOX,n));return i.origin=new(Function.prototype.bind.apply(lt,[null].concat(N(t.origin)))),i.halfDimensions=new(Function.prototype.bind.apply(lt,[null].concat(N(t.halfDimensions)))),i}return C(e,t),O(e,[{key:"computeBoundingBox",value:function(){return this.bbox=new ht,this.bbox.min.subVectors(this.origin,this.halfDimensions),this.bbox.max.addVectors(this.origin,this.halfDimensions),this.bbox}},{key:"sample",value:function(t){var e=this.origin,n=this.halfDimensions,i=Math.abs(t.x-e.x)-n.x,r=Math.abs(t.y-e.y)-n.y,s=Math.abs(t.z-e.z)-n.z,a=Math.max(i,Math.max(r,s)),o=Math.max(i,0),u=Math.max(r,0),l=Math.max(s,0),h=Math.sqrt(o*o+u*u+l*l);return Math.min(a,0)+h}},{key:"serialise",value:function(){var t=D(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"serialise",this).call(this);return t.parameters={origin:this.origin.toArray(),halfDimensions:this.halfDimensions.toArray()},t}}]),e}(At),Et=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments[1];U(this,e);var i=T(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,xt.PLANE,n));return i.normal=new(Function.prototype.bind.apply(lt,[null].concat(N(t.normal)))),i.constant=t.constant,i}return C(e,t),O(e,[{key:"computeBoundingBox",value:function(){return this.bbox=new ht,this.bbox}},{key:"sample",value:function(t){return this.normal.dot(t)+this.constant}},{key:"serialise",value:function(){var t=D(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"serialise",this).call(this);return t.parameters={normal:this.normal.toArray(),constant:this.constant},t}}]),e}(At),Pt=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments[1];U(this,e);var i=T(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,xt.TORUS,n));return i.origin=new(Function.prototype.bind.apply(lt,[null].concat(N(t.origin)))),i.R=t.R,i.r=t.r,i}return C(e,t),O(e,[{key:"computeBoundingBox",value:function(){return this.bbox=new ht,this.bbox.min.copy(this.origin).subScalar(this.R).subScalar(this.r),this.bbox.max.copy(this.origin).addScalar(this.R).addScalar(this.r),this.bbox}},{key:"sample",value:function(t){var e=this.origin,n=t.x-e.x,i=t.y-e.y,r=t.z-e.z,s=Math.sqrt(n*n+r*r)-this.R;return Math.sqrt(s*s+i*i)-this.r}},{key:"serialise",value:function(){var t=D(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"serialise",this).call(this);return t.parameters={origin:this.origin.toArray(),R:this.R,r:this.r},t}}]),e}(At),It=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments[1];U(this,e);var i=T(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,xt.HEIGHTFIELD,n));return i.min=new(Function.prototype.bind.apply(lt,[null].concat(N(t.min)))),i.dimensions=new(Function.prototype.bind.apply(lt,[null].concat(N(t.size)))),i.data=t.data,i}return C(e,t),O(e,[{key:"computeBoundingBox",value:function(){return this.bbox=new ht,this.bbox.min.copy(this.min),this.bbox.max.addVectors(this.min,this.dimensions),this.bbox}},{key:"sample",value:function(t){var e=this.min,n=this.dimensions,i=Math.max(e.x,Math.min(e.x+n.x,t.x-e.x)),r=Math.max(e.z,Math.min(e.z+n.z,t.z-e.z));return t.y-e.y-this.data[r*n.x+i]/255*n.y}},{key:"serialise",value:function(){var t=D(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"serialise",this).call(this);return t.parameters={min:this.min.toArray(),dimensions:this.dimensions.toArray(),data:this.data},t}}]),e}(At),Ut=function(){function t(){U(this,t)}return O(t,null,[{key:"reviveSDF",value:function(t){var e=void 0,n=void 0,i=void 0;switch(t.type){case xt.SPHERE:e=new Mt(t.parameters,t.material);break;case xt.BOX:e=new St(t.parameters,t.material);break;case xt.TORUS:e=new Pt(t.parameters,t.material);break;case xt.PLANE:e=new Et(t.parameters,t.material);break;case xt.HEIGHTFIELD:e=new It(t.parameters,t.material)}for(e.operation=t.operation,n=0,i=t.children.length;n<i;++n)e.children.push(this.reviveSDF(t.children[n]));return e}}]),t}(),Ot={EXTRACT:"worker.extract",MODIFY:"worker.modify",CLOSE:"worker.close"},Dt=function(t){function e(t){U(this,e);var n=T(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));return n.worker=null,n.data=null,n}return C(e,t),e}(j),Ct=new Dt("message"),Tt='!function(){"use strict";function t(t,i,n,e,r,s){var o=0;return t>i&&t>n?(r<t&&(o|=2),s<t&&(o|=1)):i>n?(e<i&&(o|=4),s<i&&(o|=1)):(e<n&&(o|=4),r<n&&(o|=2)),o}function i(t,i,n,e){var r=void 0,s=0;return i<n?(r=i,s=0):(r=n,s=1),e<r&&(s=2),Z[t][s]}function n(e,r,s,o,a,u,l,h,c){var d=e.children,y=void 0,v=void 0,f=void 0,m=void 0;if(a>=0&&u>=0&&l>=0)if(null===d)c.push(e);else{y=t(r,s,o,v=.5*(r+a),f=.5*(s+u),m=.5*(o+l));do{switch(y){case 0:n(d[X[8]],r,s,o,v,f,m,h,c),y=i(y,v,f,m);break;case 1:n(d[X[8]^X[1]],r,s,m,v,f,l,h,c),y=i(y,v,f,l);break;case 2:n(d[X[8]^X[2]],r,f,o,v,u,m,h,c),y=i(y,v,u,m);break;case 3:n(d[X[8]^X[3]],r,f,m,v,u,l,h,c),y=i(y,v,u,l);break;case 4:n(d[X[8]^X[4]],v,s,o,a,f,m,h,c),y=i(y,a,f,m);break;case 5:n(d[X[8]^X[5]],v,s,m,a,f,l,h,c),y=i(y,a,f,l);break;case 6:n(d[X[8]^X[6]],v,f,o,a,u,m,h,c),y=i(y,a,u,m);break;case 7:n(d[X[8]^X[7]],v,f,m,a,u,l,h,c),y=8}}while(y<8)}}function e(t){var i=t.children,n=0,r=void 0,s=void 0,o=void 0;if(null!==i)for(r=0,s=i.length;r<s;++r)(o=1+e(i[r]))>n&&(n=o);return n}function r(t,i,n){var e=t.children,s=void 0,o=void 0;if(K.min=t.min,K.max=t.max,i.intersectsBox(K))if(null!==e)for(s=0,o=e.length;s<o;++s)r(e[s],i,n);else n.push(t)}function s(t,i,n,e){var r=t.children,o=void 0,a=void 0;if(n===i)e.push(t);else if(null!==r)for(++n,o=0,a=r.length;o<a;++o)s(r[o],i,n,e)}function o(t){var i=t.children,n=0,e=void 0,r=void 0;if(null!==i)for(e=0,r=i.length;e<r;++e)n+=o(i[e]);else null!==t.points&&(n=t.points.length);return n}function a(t,i,n,e,r,s,o){var u=t.children,l=!1,h=!1,c=void 0,d=void 0;if(t.contains(i,r)){if(null===u){if(null===t.points)t.points=[],t.data=[];else for(c=0,d=t.points.length;!l&&c<d;++c)l=t.points[c].equals(i);l?(t.data[c-1]=n,h=!0):t.points.length<s||e===o?(t.points.push(i.clone()),t.data.push(n),h=!0):(t.split(),t.redistribute(r),u=t.children)}if(null!==u)for(++e,c=0,d=u.length;!h&&c<d;++c)h=a(u[c],i,n,e,r,s,o)}return h}function u(t,i,n,e,r){var s=t.children,a=!1,l=void 0,h=void 0,c=void 0,d=void 0,y=void 0;if(t.contains(n,e))if(null!==s)for(l=0,h=s.length;!a&&l<h;++l)a=u(s[l],t,n,e,r);else if(null!==t.points)for(c=t.points,d=t.data,l=0,h=c.length;!a&&l<h;++l)c[l].equals(n)&&(l<(y=h-1)&&(c[l]=c[y],d[l]=d[y]),c.pop(),d.pop(),null!==i&&o(i)<=r&&i.merge(),a=!0);return a}function l(t,i,n,e){var r=t.children,s=null,o=void 0,a=void 0,u=void 0;if(t.contains(i,n))if(null!==r)for(o=0,a=r.length;null===s&&o<a;++o)s=l(r[o],i,n,e);else for(o=0,a=(u=t.points).length;null===s&&o<a;++o)i.distanceToSquared(u[o])<=e&&(s=t.data[o]);return s}function h(t,i,n,e){var r=t.points,s=t.children,o=null,a=n,u=void 0,l=void 0,c=void 0,d=void 0,y=void 0,v=void 0,f=void 0;if(null!==s)for(u=0,l=(y=s.map(function(t){return{octant:t,distance:t.distanceToCenterSquared(i)}}).sort(function(t,i){return t.distance-i.distance})).length;u<l;++u)(v=y[u].octant).contains(i,a)&&null!==(f=h(v,i,a,e))&&(d=f.point.distanceToSquared(i),(!e||d>0)&&d<a&&(a=d,o=f));else if(null!==r)for(u=0,l=r.length;u<l;++u)c=r[u],d=i.distanceToSquared(c),(!e||d>0)&&d<a&&(a=d,o={point:c.clone(),data:t.data[u]});return o}function c(t,i,n,e,r){var s=t.points,o=t.children,a=n*n,u=void 0,l=void 0,h=void 0,d=void 0,y=void 0;if(null!==o)for(u=0,l=o.length;u<l;++u)(y=o[u]).contains(i,n)&&c(y,i,n,e,r);else if(null!==s)for(u=0,l=s.length;u<l;++u)h=s[u],d=i.distanceToSquared(h),(!e||d>0)&&d<=a&&r.push({point:h.clone(),data:t.data[u]})}function d(t,i,n){var e=void 0,r=void 0,s=void 0;0===i?(st.c=1,st.s=0):(e=(n-t)/(2*i),r=Math.sqrt(1+e*e),s=1/(e>=0?e+r:e-r),st.c=1/Math.sqrt(1+s*s),st.s=s*st.c)}function y(t,i){0!==t.elements[1]&&rt.rot01Post(i,ot.rot01(t))}function v(t,i){0!==t.elements[2]&&rt.rot02Post(i,ot.rot02(t))}function f(t,i){0!==t.elements[4]&&rt.rot12Post(i,ot.rot12(t))}function m(t,i,n,e,r){var s=e*i.copy(t).norm(),o=void 0;for(o=0;o<r&&i.off()>s;++o)y(i,n),v(i,n),f(i,n)}function p(t,i){var n=1/t;return Math.abs(t)<i||Math.abs(n)<i?0:n}function x(t,i,n,e){var r=t.elements,s=i.elements,o=n.elements,a=s[0],u=s[3],l=s[5],h=p(a,e),c=p(u,e),d=p(l,e),y=3-((0===h)+(0===c)+(0===d)),v=o[0],f=o[3],m=o[6],x=o[1],g=o[4],k=o[7],w=o[2],z=o[5],b=o[8];return r[0]=v*h*v+f*c*f+m*d*m,r[3]=v*h*x+f*c*g+m*d*k,r[6]=v*h*w+f*c*z+m*d*b,r[1]=r[3],r[4]=x*h*x+g*c*g+k*d*k,r[7]=x*h*w+g*c*z+k*d*b,r[2]=r[6],r[5]=r[7],r[8]=w*h*w+z*c*z+b*d*b,y}function g(t,i,n,e,r){var s=t+1,o=s*s,a=new yt,u=void 0,l=void 0,h=void 0,c=void 0,d=void 0;for(u=0,d=0;d<8;++d)c=(e+(h=B[d])[2])*o+(n+h[1])*s+(i+h[0]),u|=Math.min(r[c],$.SOLID)<<d;for(l=0,d=0;d<12;++d)(u>>q[d][0]&1)!==(u>>q[d][1]&1)&&++l;return a.materials=u,a.edgeCount=l,a.qefData=new nt,a}function k(t,i,n){var e=[-1,-1,-1,-1],r=[!1,!1,!1,!1],s=1/0,o=0,a=!1,u=void 0,l=void 0,h=void 0,c=void 0,d=void 0,y=void 0,v=void 0;for(v=0;v<4;++v)d=t[v],y=zt[i][v],u=q[y][0],l=q[y][1],h=d.voxel.materials>>u&1,c=d.voxel.materials>>l&1,d.size<s&&(s=d.size,o=v,a=h!==$.AIR),e[v]=d.voxel.index,r[v]=h!==c;r[o]&&(a?(n.push(e[0]),n.push(e[3]),n.push(e[1]),n.push(e[0]),n.push(e[2]),n.push(e[3])):(n.push(e[0]),n.push(e[1]),n.push(e[3]),n.push(e[0]),n.push(e[3]),n.push(e[2])))}function w(t,i,n){var e=[0,0,0,0],r=void 0,s=void 0,o=void 0,a=void 0;if(null!==t[0].voxel&&null!==t[1].voxel&&null!==t[2].voxel&&null!==t[3].voxel)k(t,i,n);else for(o=0;o<2;++o){for(e[0]=wt[i][o][0],e[1]=wt[i][o][1],e[2]=wt[i][o][2],e[3]=wt[i][o][3],r=[],a=0;a<4;++a)if(null!==(s=t[a]).voxel)r[a]=s;else{if(null===s.children)break;r[a]=s.children[e[a]]}4===a&&w(r,wt[i][o][4],n)}}function z(t,i,n){var e=[0,0,0,0],r=[[0,0,1,1],[0,1,0,1]],s=void 0,o=void 0,a=void 0,u=void 0,l=void 0;if(null!==t[0].children||null!==t[1].children){for(u=0;u<4;++u)e[0]=gt[i][u][0],e[1]=gt[i][u][1],z([null===t[0].children?t[0]:t[0].children[e[0]],null===t[1].children?t[1]:t[1].children[e[1]]],gt[i][u][2],n);for(u=0;u<4;++u){for(e[0]=kt[i][u][1],e[1]=kt[i][u][2],e[2]=kt[i][u][3],e[3]=kt[i][u][4],o=r[kt[i][u][0]],s=[],l=0;l<4;++l)if(null!==(a=t[o[l]]).voxel)s[l]=a;else{if(null===a.children)break;s[l]=a.children[e[l]]}4===l&&w(s,kt[i][u][5],n)}}}function b(t,i){var n=t.children,e=[0,0,0,0],r=void 0;if(null!==n){for(r=0;r<8;++r)b(n[r],i);for(r=0;r<12;++r)e[0]=pt[r][0],e[1]=pt[r][1],z([n[e[0]],n[e[1]]],pt[r][2],i);for(r=0;r<6;++r)e[0]=xt[r][0],e[1]=xt[r][1],e[2]=xt[r][2],e[3]=xt[r][3],w([n[e[0]],n[e[1]],n[e[2]],n[e[3]]],xt[r][4],i)}}function A(t,i,n,e){var r=void 0,s=void 0;if(null!==t.children)for(r=0;r<8;++r)e=A(t.children[r],i,n,e);else null!==t.voxel&&((s=t.voxel).index=e,i[3*e]=s.position.x,i[3*e+1]=s.position.y,i[3*e+2]=s.position.z,n[3*e]=s.normal.x,n[3*e+1]=s.normal.y,n[3*e+2]=s.normal.z,++e);return e}function U(t,i){var n=t.size,e=t.resolution,r=new tt(0,0,0),s=new tt(e,e,e),o=new Pt(t.min,t.max);return i.type!==Et.INTERSECTION&&(i.boundingBox.intersectsBox(o)?(r.copy(i.boundingBox.min).max(o.min).sub(o.min),r.x=Math.ceil(r.x*e/n),r.y=Math.ceil(r.y*e/n),r.z=Math.ceil(r.z*e/n),s.copy(i.boundingBox.max).min(o.max).sub(o.min),s.x=Math.floor(s.x*e/n),s.y=Math.floor(s.y*e/n),s.z=Math.floor(s.z*e/n)):(r.set(e,e,e),s.set(0,0,0))),new Pt(r,s)}function M(t,i,n,e,r){var s=t.resolution+1,o=s*s,a=r.max.x,u=r.max.y,l=r.max.z,h=void 0,c=void 0,d=void 0;for(d=r.min.z;d<=l;++d)for(c=r.min.y;c<=u;++c)for(h=r.min.x;h<=a;++h)i.updateMaterialIndex(d*o+c*s+h,n,e)}function I(t,i,n,e){var r=t.size,s=t.resolution,o=s+1,a=o*o,u=n.materialIndices,l=t.min,h=new tt,c=new tt,d=e.max.x,y=e.max.y,v=e.max.z,f=void 0,m=0,p=void 0,x=void 0,g=void 0;for(g=e.min.z;g<=v;++g)for(h.z=g*r/s,x=e.min.y;x<=y;++x)for(h.y=x*r/s,p=e.min.x;p<=d;++p)h.x=p*r/s,(f=i.generateMaterialIndex(c.addVectors(l,h)))!==$.AIR&&(u[g*a+x*o+p]=f,++m);n.materials=m}function S(t,i,n,e){var r=t.resolution+1,s=new Uint32Array([1,r,r*r]),o=n.materialIndices,a=new dt,u=new dt,l=e.edgeData,h=n.edgeData,c=Ut.calculate1DEdgeCount(t.resolution),d=new Ut(Math.min(c,h.edges[0].length+l.edges[0].length),Math.min(c,h.edges[1].length+l.edges[1].length),Math.min(c,h.edges[2].length+l.edges[2].length)),y=new Uint32Array(3),v=void 0,f=void 0,m=void 0,p=void 0,x=void 0,g=void 0,k=void 0,w=void 0,z=void 0,b=void 0,A=void 0,U=void 0,M=void 0,I=void 0,S=void 0,O=void 0,_=void 0,D=void 0,P=void 0,E=void 0,C=void 0,T=void 0;for(_=0,D=0;D<3;_=0,++D){for(v=l.edges[D],p=h.edges[D],k=d.edges[D],f=l.zeroCrossings[D],x=h.zeroCrossings[D],w=d.zeroCrossings[D],m=l.normals[D],g=h.normals[D],z=d.normals[D],C=v.length,T=p.length,P=0,E=0;P<C;++P)if(b=v[P],A=b+s[D],I=o[b],S=o[A],I!==S&&(I===$.AIR||S===$.AIR)){for(a.t=f[P],a.n.x=m[3*P],a.n.y=m[3*P+1],a.n.z=m[3*P+2],i.type===Et.DIFFERENCE&&a.n.negate(),O=a;E<T&&p[E]<=b;)M=(U=p[E])+s[D],u.t=x[E],u.n.x=g[3*E],u.n.y=g[3*E+1],u.n.z=g[3*E+2],I=o[U],U<b?I===(S=o[M])||I!==$.AIR&&S!==$.AIR||(k[_]=U,w[_]=u.t,z[3*_]=u.n.x,z[3*_+1]=u.n.y,z[3*_+2]=u.n.z,++_):O=i.selectEdge(u,a,I===$.SOLID),++E;k[_]=b,w[_]=O.t,z[3*_]=O.n.x,z[3*_+1]=O.n.y,z[3*_+2]=O.n.z,++_}for(;E<T;)M=(U=p[E])+s[D],(I=o[U])===(S=o[M])||I!==$.AIR&&S!==$.AIR||(k[_]=U,w[_]=x[E],z[3*_]=g[3*E],z[3*_+1]=g[3*E+1],z[3*_+2]=g[3*E+2],++_),++E;y[D]=_}return{edgeData:d,lengths:y}}function O(t,i,n,e){var r=t.size,s=t.resolution,o=s+1,a=o*o,u=new Uint32Array([1,o,a]),l=n.materialIndices,h=t.min,c=new tt,d=new tt,y=new dt,v=new Ut(Ut.calculate1DEdgeCount(s)),f=new Uint32Array(3),m=void 0,p=void 0,x=void 0,g=void 0,k=void 0,w=void 0,z=void 0,b=void 0,A=void 0,U=void 0,M=void 0,I=void 0,S=void 0,O=void 0,_=void 0,D=void 0,P=void 0,E=void 0;for(O=4,I=0,S=0;S<3;O>>=1,I=0,++S){switch(_=B[O],m=v.edges[S],p=v.zeroCrossings[S],x=v.normals[S],w=e.min.x,A=e.max.x,z=e.min.y,U=e.max.y,b=e.min.z,M=e.max.z,S){case 0:w=Math.max(w-1,0),A=Math.min(A,s-1);break;case 1:z=Math.max(z-1,0),U=Math.min(U,s-1);break;case 2:b=Math.max(b-1,0),M=Math.min(M,s-1)}for(E=b;E<=M;++E)for(P=z;P<=U;++P)for(D=w;D<=A;++D)k=(g=E*a+P*o+D)+u[S],l[g]!==l[k]&&(c.set(D*r/s,P*r/s,E*r/s),d.set((D+_[0])*r/s,(P+_[1])*r/s,(E+_[2])*r/s),y.a.addVectors(h,c),y.b.addVectors(h,d),i.generateEdge(y),m[I]=g,p[I]=y.t,x[3*I]=y.n.x,x[3*I+1]=y.n.y,x[3*I+2]=y.n.z,++I);f[S]=I}return{edgeData:v,lengths:f}}function _(t,i,n,e){var r=U(t,i),s=void 0,o=void 0,a=void 0,u=void 0,l=!1;if(i.type===Et.DENSITY_FUNCTION?I(t,i,n,r):n.empty?i.type===Et.UNION&&(n.set(e),l=!0):n.full&&i.type===Et.UNION||M(t,i,n,e,r),!l&&!n.empty&&!n.full){for(o=(s=i.type===Et.DENSITY_FUNCTION?O(t,i,n,r):S(t,i,n,e)).edgeData,a=s.lengths,u=0;u<3;++u)o.edges[u]=o.edges[u].slice(0,a[u]),o.zeroCrossings[u]=o.zeroCrossings[u].slice(0,a[u]),o.normals[u]=o.normals[u].slice(0,3*a[u]);n.edgeData=o}}function D(t,i){var n=i.children,e=void 0,r=void 0,s=void 0,o=void 0;for(i.type===Et.DENSITY_FUNCTION&&_(t,i,e=new St),s=0,o=n.length;s<o&&(r=D(t,n[s]),void 0===e?e=r:null!==r?null===e?i.type===Et.UNION&&(e=r):_(t,i,e,r):i.type===Et.INTERSECTION&&(e=null),null!==e||i.type===Et.UNION);++s);return null!==e&&e.empty?null:e}var P=function(t,i){if(!(t instanceof i))throw new TypeError("Cannot call a class as a function")},E=function(){function t(t,i){for(var n=0;n<i.length;n++){var e=i[n];e.enumerable=e.enumerable||!1,e.configurable=!0,"value"in e&&(e.writable=!0),Object.defineProperty(t,e.key,e)}}return function(i,n,e){return n&&t(i.prototype,n),e&&t(i,e),i}}(),C=function t(i,n,e){null===i&&(i=Function.prototype);var r=Object.getOwnPropertyDescriptor(i,n);if(void 0===r){var s=Object.getPrototypeOf(i);return null===s?void 0:t(s,n,e)}if("value"in r)return r.value;var o=r.get;if(void 0!==o)return o.call(e)},T=function(t,i){if("function"!=typeof i&&null!==i)throw new TypeError("Super expression must either be null or a function, not "+typeof i);t.prototype=Object.create(i&&i.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),i&&(Object.setPrototypeOf?Object.setPrototypeOf(t,i):t.__proto__=i)},N=function(t,i){if(!t)throw new ReferenceError("this hasn\'t been initialised - super() hasn\'t been called");return!i||"object"!=typeof i&&"function"!=typeof i?t:i},F=function(t){if(Array.isArray(t)){for(var i=0,n=Array(t.length);i<t.length;i++)n[i]=t[i];return n}return Array.from(t)},R=function(){function t(){var i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,e=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;P(this,t),this.x=i,this.y=n,this.z=e}return E(t,[{key:"set",value:function(t,i,n){return this.x=t,this.y=i,this.z=n,this}},{key:"copy",value:function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this}},{key:"fromArray",value:function(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return this.x=t[i],this.y=t[i+1],this.z=t[i+2],this}},{key:"toArray",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return t[i]=this.x,t[i+1]=this.y,t[i+2]=this.z,t}},{key:"equals",value:function(t){return t.x===this.x&&t.y===this.y&&t.z===this.z}},{key:"clone",value:function(){return new this.constructor(this.x,this.y,this.z)}},{key:"add",value:function(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this}},{key:"addScaledVector",value:function(t,i){return this.x+=t.x*i,this.y+=t.y*i,this.z+=t.z*i,this}},{key:"addScalar",value:function(t){return this.x+=t,this.y+=t,this.z+=t,this}},{key:"addVectors",value:function(t,i){return this.x=t.x+i.x,this.y=t.y+i.y,this.z=t.z+i.z,this}},{key:"sub",value:function(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this}},{key:"subScalar",value:function(t){return this.x-=t,this.y-=t,this.z-=t,this}},{key:"subVectors",value:function(t,i){return this.x=t.x-i.x,this.y=t.y-i.y,this.z=t.z-i.z,this}},{key:"multiply",value:function(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this}},{key:"multiplyScalar",value:function(t){return isFinite(t)?(this.x*=t,this.y*=t,this.z*=t):(this.x=0,this.y=0,this.z=0),this}},{key:"multiplyVectors",value:function(t,i){return this.x=t.x*i.x,this.y=t.y*i.y,this.z=t.z*i.z,this}},{key:"divide",value:function(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this}},{key:"divideScalar",value:function(t){return this.multiplyScalar(1/t)}},{key:"divideVectors",value:function(t,i){return this.x=t.x/i.x,this.y=t.y/i.y,this.z=t.z/i.z,this}},{key:"negate",value:function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}},{key:"dot",value:function(t){return this.x*t.x+this.y*t.y+this.z*t.z}},{key:"lengthSq",value:function(){return this.x*this.x+this.y*this.y+this.z*this.z}},{key:"length",value:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}},{key:"distanceTo",value:function(t){return Math.sqrt(this.distanceToSquared(t))}},{key:"distanceToSquared",value:function(t){var i=this.x-t.x,n=this.y-t.y,e=this.z-t.z;return i*i+n*n+e*e}},{key:"normalize",value:function(){return this.divideScalar(this.length())}},{key:"min",value:function(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this.z=Math.min(this.z,t.z),this}},{key:"max",value:function(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this.z=Math.max(this.z,t.z),this}},{key:"clamp",value:function(t,i){return this.x=Math.max(t.x,Math.min(i.x,this.x)),this.y=Math.max(t.y,Math.min(i.y,this.y)),this.z=Math.max(t.z,Math.min(i.z,this.z)),this}},{key:"applyMatrix3",value:function(t){var i=this.x,n=this.y,e=this.z,r=t.elements;return this.x=r[0]*i+r[3]*n+r[6]*e,this.y=r[1]*i+r[4]*n+r[7]*e,this.z=r[2]*i+r[5]*n+r[8]*e,this}},{key:"applyMatrix4",value:function(t){var i=this.x,n=this.y,e=this.z,r=t.elements;return this.x=r[0]*i+r[4]*n+r[8]*e+r[12],this.y=r[1]*i+r[5]*n+r[9]*e+r[13],this.z=r[2]*i+r[6]*n+r[10]*e+r[14],this}}]),t}(),L=function(){function t(){var i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new R,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new R;P(this,t),this.min=i,this.max=n,this.children=null}return E(t,[{key:"getCenter",value:function(){return this.min.clone().add(this.max).multiplyScalar(.5)}},{key:"getDimensions",value:function(){return this.max.clone().sub(this.min)}},{key:"split",value:function(t){var i=this.min,n=this.max,e=this.getCenter(),r=void 0,s=void 0,o=0,a=void 0,u=void 0,l=void 0,h=void 0,c=void 0;for(Array.isArray(t)&&(u=this.getDimensions().multiplyScalar(.5),l=[new R,new R,new R],o=t.length),this.children=[],r=0;r<8;++r){if(a=B[r],c=null,o>0)for(l[1].addVectors(i,l[0].fromArray(a).multiply(u)),l[2].addVectors(e,l[0].fromArray(a).multiply(u)),s=0;s<o;++s)if(null!==(h=t[s])&&l[1].equals(h.min)&&l[2].equals(h.max)){c=h,t[s]=null;break}this.children.push(null!==c?c:new this.constructor(new R(0===a[0]?i.x:e.x,0===a[1]?i.y:e.y,0===a[2]?i.z:e.z),new R(0===a[0]?e.x:n.x,0===a[1]?e.y:n.y,0===a[2]?e.z:n.z)))}}}]),t}(),B=[new Uint8Array([0,0,0]),new Uint8Array([0,0,1]),new Uint8Array([0,1,0]),new Uint8Array([0,1,1]),new Uint8Array([1,0,0]),new Uint8Array([1,0,1]),new Uint8Array([1,1,0]),new Uint8Array([1,1,1])],q=[new Uint8Array([0,4]),new Uint8Array([1,5]),new Uint8Array([2,6]),new Uint8Array([3,7]),new Uint8Array([0,2]),new Uint8Array([1,3]),new Uint8Array([4,6]),new Uint8Array([5,7]),new Uint8Array([0,1]),new Uint8Array([2,3]),new Uint8Array([4,5]),new Uint8Array([6,7])],V=function(){function t(){var i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new R,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;P(this,t),this.min=i,this.size=n,this.children=null}return E(t,[{key:"getCenter",value:function(){return this.min.clone().addScalar(.5*this.size)}},{key:"getDimensions",value:function(){return new R(this.size,this.size,this.size)}},{key:"split",value:function(t){var i=this.min,n=this.getCenter(),e=.5*this.size,r=void 0,s=void 0,o=0,a=void 0,u=void 0,l=void 0,h=void 0;for(Array.isArray(t)&&(u=new R,o=t.length),this.children=[],r=0;r<8;++r){if(a=B[r],h=null,o>0)for(u.fromArray(a).multiplyScalar(e).add(i),s=0;s<o;++s)if(null!==(l=t[s])&&l.size===e&&u.equals(l.min)){h=l,t[s]=null;break}this.children.push(null!==h?h:new this.constructor(new R(0===a[0]?i.x:n.x,0===a[1]?i.y:n.y,0===a[2]?i.z:n.z),e))}}},{key:"max",get:function(){return this.min.clone().addScalar(this.size)}}]),t}(),j=function(){function t(){var i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new R(1/0,1/0,1/0),n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new R(-1/0,-1/0,-1/0);P(this,t),this.min=i,this.max=n}return E(t,[{key:"set",value:function(t,i){return this.min.copy(t),this.max.copy(i),this}},{key:"copy",value:function(t){return this.min.copy(t.min),this.max.copy(t.max),this}},{key:"clone",value:function(){return(new this.constructor).copy(this)}},{key:"expandByPoint",value:function(t){return this.min.min(t),this.max.max(t),this}},{key:"union",value:function(t){return this.min.min(t.min),this.max.max(t.max),this}},{key:"setFromPoints",value:function(t){var i=void 0,n=void 0;for(i=0,n=t.length;i<n;++i)this.expandByPoint(t[i]);return this}},{key:"setFromCenterAndSize",value:function(t,i){var n=i.clone().multiplyScalar(.5);return this.min.copy(t).sub(n),this.max.copy(t).add(n),this}},{key:"intersectsBox",value:function(t){return!(t.max.x<this.min.x||t.min.x>this.max.x||t.max.y<this.min.y||t.min.y>this.max.y||t.max.z<this.min.z||t.min.z>this.max.z)}}]),t}(),H=function(){function t(){var i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,n=arguments.length>1&&void 0!==arguments[1]&&arguments[1];P(this,t),this.value=i,this.done=n}return E(t,[{key:"reset",value:function(){this.value=null,this.done=!1}}]),t}(),Y=new j,G=function(){function t(i){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;P(this,t),this.octree=i,this.region=n,this.cull=null!==n,this.result=new H,this.trace=null,this.indices=null,this.reset()}return E(t,[{key:"reset",value:function(){var t=this.octree.root;return this.trace=[],this.indices=[],null!==t&&(Y.min=t.min,Y.max=t.max,this.cull&&!this.region.intersectsBox(Y)||(this.trace.push(t),this.indices.push(0))),this.result.reset(),this}},{key:"next",value:function(){for(var t=this.cull,i=this.region,n=this.indices,e=this.trace,r=null,s=e.length-1,o=void 0,a=void 0,u=void 0;null===r&&s>=0;)if(o=n[s],a=e[s].children,++n[s],o<8)if(null!==a){if(u=a[o],t&&(Y.min=u.min,Y.max=u.max,!i.intersectsBox(Y)))continue;e.push(u),n.push(0),++s}else r=e.pop(),n.pop();else e.pop(),n.pop(),--s;return this.result.value=r,this.result.done=null===r,this.result}},{key:"return",value:function(t){return this.result.value=t,this.result.done=!0,this.result}},{key:Symbol.iterator,value:function(){return this}}]),t}(),X=new Uint8Array([0,1,2,3,4,5,6,7,0]),Z=[new Uint8Array([4,2,1]),new Uint8Array([5,3,8]),new Uint8Array([6,8,3]),new Uint8Array([7,8,8]),new Uint8Array([8,6,5]),new Uint8Array([8,7,8]),new Uint8Array([8,8,7]),new Uint8Array([8,8,8])],J=function(){function t(){P(this,t)}return E(t,null,[{key:"intersectOctree",value:function(t,i,e){var r=t.getDimensions(),s=r.clone().multiplyScalar(.5),o=t.min.clone().sub(t.min),a=t.max.clone().sub(t.min),u=i.ray.direction.clone(),l=i.ray.origin.clone();l.sub(t.getCenter()).add(s);var h=void 0,c=void 0,d=void 0,y=void 0,v=void 0,f=void 0,m=void 0,p=void 0,x=void 0;X[8]=X[0],u.x<0&&(l.x=r.x-l.x,u.x=-u.x,X[8]|=X[4]),u.y<0&&(l.y=r.y-l.y,u.y=-u.y,X[8]|=X[2]),u.z<0&&(l.z=r.z-l.z,u.z=-u.z,X[8]|=X[1]),h=1/u.x,c=1/u.y,d=1/u.z,y=(o.x-l.x)*h,v=(a.x-l.x)*h,f=(o.y-l.y)*c,m=(a.y-l.y)*c,p=(o.z-l.z)*d,x=(a.z-l.z)*d,Math.max(Math.max(y,f),p)<Math.min(Math.min(v,m),x)&&n(t.root,y,f,p,v,m,x,i,e)}}]),t}(),K=new j,Q=function(){function t(i,n){P(this,t),this.root=void 0!==i&&void 0!==n?new L(i,n):null}return E(t,[{key:"getCenter",value:function(){return this.root.getCenter()}},{key:"getDimensions",value:function(){return this.root.getDimensions()}},{key:"getDepth",value:function(){return e(this.root)}},{key:"cull",value:function(t){var i=[];return r(this.root,t,i),i}},{key:"findOctantsByLevel",value:function(t){var i=[];return s(this.root,t,0,i),i}},{key:"raycast",value:function(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];return J.intersectOctree(this,t,i),i}},{key:"leaves",value:function(t){return new G(this,t)}},{key:Symbol.iterator,value:function(){return new G(this)}},{key:"min",get:function(){return this.root.min}},{key:"max",get:function(){return this.root.max}},{key:"children",get:function(){return this.root.children}}]),t}(),W=function(t){function i(t,n){P(this,i);var e=N(this,(i.__proto__||Object.getPrototypeOf(i)).call(this,t,n));return e.points=null,e.data=null,e}return T(i,t),E(i,[{key:"distanceToSquared",value:function(t){return t.clone().clamp(this.min,this.max).sub(t).lengthSq()}},{key:"distanceToCenterSquared",value:function(t){var i=this.getCenter(),n=t.x-i.x,e=t.y-i.x,r=t.z-i.z;return n*n+e*e+r*r}},{key:"contains",value:function(t,i){var n=this.min,e=this.max;return t.x>=n.x-i&&t.y>=n.y-i&&t.z>=n.z-i&&t.x<=e.x+i&&t.y<=e.y+i&&t.z<=e.z+i}},{key:"redistribute",value:function(t){var i=this.children,n=this.points,e=this.data,r=void 0,s=void 0,o=void 0,a=void 0,u=void 0;if(null!==i)for(;n.length>0;)for(a=n.pop(),u=e.pop(),r=0,s=i.length;r<s;++r)if((o=i[r]).contains(a,t)){null===o.points&&(o.points=[],o.data=[]),o.points.push(a),o.data.push(u);break}this.points=null,this.data=null}},{key:"merge",value:function(){var t=this.children,i=void 0,n=void 0,e=void 0;if(null!==t){for(this.points=[],this.data=[],i=0,n=t.length;i<n;++i)if(null!==(e=t[i]).points){var r,s;(r=this.points).push.apply(r,F(e.points)),(s=this.data).push.apply(s,F(e.data))}this.children=null}}}]),i}(L),$=(function(t){function i(t,n){var e=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:8,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:8;P(this,i);var o=N(this,(i.__proto__||Object.getPrototypeOf(i)).call(this));return o.root=new W(t,n),o.bias=Math.max(0,e),o.biasSquared=o.bias*o.bias,o.maxPoints=Math.max(1,Math.round(r)),o.maxDepth=Math.max(0,Math.round(s)),o}T(i,t),E(i,[{key:"countPoints",value:function(){return o(this.root)}},{key:"add",value:function(t,i){a(this.root,t,i,0,this.bias,this.maxPoints,this.maxDepth)}},{key:"remove",value:function(t){u(this.root,null,t,this.bias,this.maxPoints)}},{key:"fetch",value:function(t){return l(this.root,t,this.bias,this.biasSquared)}},{key:"findNearestPoint",value:function(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1/0,n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return h(this.root,t,i,n)}},{key:"findPoints",value:function(t,i){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],e=[];return c(this.root,t,i,n,e),e}},{key:"raycast",value:function(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],e=C(i.prototype.__proto__||Object.getPrototypeOf(i.prototype),"raycast",this).call(this,t);return e.length>0&&this.testPoints(e,t,n),n}},{key:"testPoints",value:function(t,i,n){var e=i.params.Points.threshold,r=e*e,s=void 0,o=void 0,a=void 0,u=void 0,l=void 0,h=void 0,c=void 0,d=void 0,y=void 0,v=void 0,f=void 0;for(l=0,c=t.length;l<c;++l)if(y=t[l],null!==(v=y.points))for(h=0,d=v.length;h<d;++h)f=v[h],(u=i.ray.distanceSqToPoint(f))<r&&(s=i.ray.closestPointToPoint(f),(o=i.ray.origin.distanceTo(s))>=i.near&&o<=i.far&&(a=Math.sqrt(u),n.push({distance:o,distanceToRay:a,point:s.clone(),object:y.data[h]})))}}])}(Q),{AIR:0,SOLID:1}),tt=function(){function t(){var i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,e=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;P(this,t),this.x=i,this.y=n,this.z=e}return E(t,[{key:"set",value:function(t,i,n){return this.x=t,this.y=i,this.z=n,this}},{key:"copy",value:function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this}},{key:"fromArray",value:function(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return this.x=t[i],this.y=t[i+1],this.z=t[i+2],this}},{key:"toArray",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return t[i]=this.x,t[i+1]=this.y,t[i+2]=this.z,t}},{key:"equals",value:function(t){return t.x===this.x&&t.y===this.y&&t.z===this.z}},{key:"clone",value:function(){return new this.constructor(this.x,this.y,this.z)}},{key:"add",value:function(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this}},{key:"addScaledVector",value:function(t,i){return this.x+=t.x*i,this.y+=t.y*i,this.z+=t.z*i,this}},{key:"addScalar",value:function(t){return this.x+=t,this.y+=t,this.z+=t,this}},{key:"addVectors",value:function(t,i){return this.x=t.x+i.x,this.y=t.y+i.y,this.z=t.z+i.z,this}},{key:"sub",value:function(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this}},{key:"subScalar",value:function(t){return this.x-=t,this.y-=t,this.z-=t,this}},{key:"subVectors",value:function(t,i){return this.x=t.x-i.x,this.y=t.y-i.y,this.z=t.z-i.z,this}},{key:"multiply",value:function(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this}},{key:"multiplyScalar",value:function(t){return isFinite(t)?(this.x*=t,this.y*=t,this.z*=t):(this.x=0,this.y=0,this.z=0),this}},{key:"multiplyVectors",value:function(t,i){return this.x=t.x*i.x,this.y=t.y*i.y,this.z=t.z*i.z,this}},{key:"divide",value:function(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this}},{key:"divideScalar",value:function(t){return this.multiplyScalar(1/t)}},{key:"divideVectors",value:function(t,i){return this.x=t.x/i.x,this.y=t.y/i.y,this.z=t.z/i.z,this}},{key:"negate",value:function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}},{key:"dot",value:function(t){return this.x*t.x+this.y*t.y+this.z*t.z}},{key:"lengthSq",value:function(){return this.x*this.x+this.y*this.y+this.z*this.z}},{key:"length",value:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}},{key:"distanceTo",value:function(t){return Math.sqrt(this.distanceToSquared(t))}},{key:"distanceToSquared",value:function(t){var i=this.x-t.x,n=this.y-t.y,e=this.z-t.z;return i*i+n*n+e*e}},{key:"normalize",value:function(){return this.divideScalar(this.length())}},{key:"min",value:function(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this.z=Math.min(this.z,t.z),this}},{key:"max",value:function(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this.z=Math.max(this.z,t.z),this}},{key:"clamp",value:function(t,i){return this.x=Math.max(t.x,Math.min(i.x,this.x)),this.y=Math.max(t.y,Math.min(i.y,this.y)),this.z=Math.max(t.z,Math.min(i.z,this.z)),this}},{key:"applyMatrix3",value:function(t){var i=this.x,n=this.y,e=this.z,r=t.elements;return this.x=r[0]*i+r[3]*n+r[6]*e,this.y=r[1]*i+r[4]*n+r[7]*e,this.z=r[2]*i+r[5]*n+r[8]*e,this}},{key:"applyMatrix4",value:function(t){var i=this.x,n=this.y,e=this.z,r=t.elements;return this.x=r[0]*i+r[4]*n+r[8]*e+r[12],this.y=r[1]*i+r[5]*n+r[9]*e+r[13],this.z=r[2]*i+r[6]*n+r[10]*e+r[14],this}}]),t}(),it=function(){function t(){P(this,t),this.elements=new Float32Array([1,0,0,1,0,1])}return E(t,[{key:"set",value:function(t,i,n,e,r,s){var o=this.elements;return o[0]=t,o[1]=i,o[2]=n,o[3]=e,o[4]=r,o[5]=s,this}},{key:"identity",value:function(){return this.set(1,0,0,1,0,1),this}},{key:"copy",value:function(t){var i=t.elements;return this.set(i[0],i[1],i[2],i[3],i[4],i[5]),this}},{key:"clone",value:function(){return(new this.constructor).copy(this)}},{key:"add",value:function(t){var i=this.elements,n=t.elements;return i[0]+=n[0],i[1]+=n[1],i[2]+=n[2],i[3]+=n[3],i[4]+=n[4],i[5]+=n[5],this}},{key:"norm",value:function(){var t=this.elements,i=t[1]*t[1],n=t[2]*t[2],e=t[4]*t[4];return Math.sqrt(t[0]*t[0]+i+n+i+t[3]*t[3]+e+n+e+t[5]*t[5])}},{key:"off",value:function(){var t=this.elements;return Math.sqrt(2*(t[1]*t[1]+t[2]*t[2]+t[4]*t[4]))}},{key:"applyToVector3",value:function(t){var i=t.x,n=t.y,e=t.z,r=this.elements;return t.x=r[0]*i+r[1]*n+r[2]*e,t.y=r[1]*i+r[3]*n+r[4]*e,t.z=r[2]*i+r[4]*n+r[5]*e,t}}]),t}(),nt=function(){function t(){P(this,t),this.ata=new it,this.ata.set(0,0,0,0,0,0),this.atb=new tt,this.btb=0,this.massPoint=new tt,this.numPoints=0,this.massPointDimension=0}return E(t,[{key:"set",value:function(t,i,n,e,r){return this.ata.copy(t),this.atb.copy(i),this.btb=n,this.massPoint.copy(e),this.numPoints=r,this}},{key:"copy",value:function(t){return this.set(t.ata,t.atb,t.btb,t.massPoint,t.numPoints)}},{key:"add",value:function(t,i){var n=i.x,e=i.y,r=i.z,s=i.dot(t),o=this.ata.elements,a=this.atb;o[0]+=n*n,o[1]+=n*e,o[2]+=n*r,o[3]+=e*e,o[4]+=e*r,o[5]+=r*r,a.x+=s*n,a.y+=s*e,a.z+=s*r,this.btb+=s*s,this.massPoint.add(t),++this.numPoints}},{key:"addData",value:function(t){this.ata.add(t.ata),this.atb.add(t.atb),this.btb+=t.btb,this.massPoint.add(t.massPoint),this.numPoints+=t.numPoints}},{key:"clear",value:function(){this.ata.set(0,0,0,0,0,0),this.atb.set(0,0,0),this.btb=0,this.massPoint.set(0,0,0),this.numPoints=0}},{key:"clone",value:function(){return(new this.constructor).copy(this)}}]),t}(),et=function(){function t(){P(this,t),this.elements=new Float32Array([1,0,0,0,1,0,0,0,1])}return E(t,[{key:"set",value:function(t,i,n,e,r,s,o,a,u){var l=this.elements;return l[0]=t,l[3]=i,l[6]=n,l[1]=e,l[4]=r,l[7]=s,l[2]=o,l[5]=a,l[8]=u,this}},{key:"identity",value:function(){return this.set(1,0,0,0,1,0,0,0,1),this}},{key:"copy",value:function(t){var i=t.elements;return this.set(i[0],i[3],i[6],i[1],i[4],i[7],i[2],i[5],i[8])}},{key:"clone",value:function(){return(new this.constructor).copy(this)}}]),t}(),rt=function(){function t(){P(this,t)}return E(t,null,[{key:"rot01Post",value:function(t,i){var n=t.elements,e=n[0],r=n[3],s=n[1],o=n[4],a=n[2],u=n[5],l=i.c,h=i.s;n[0]=l*e-h*r,n[3]=h*e+l*r,n[1]=l*s-h*o,n[4]=h*s+l*o,n[2]=l*a-h*u,n[5]=h*a+l*u}},{key:"rot02Post",value:function(t,i){var n=t.elements,e=n[0],r=n[6],s=n[1],o=n[7],a=n[2],u=n[8],l=i.c,h=i.s;n[0]=l*e-h*r,n[6]=h*e+l*r,n[1]=l*s-h*o,n[7]=h*s+l*o,n[2]=l*a-h*u,n[8]=h*a+l*u}},{key:"rot12Post",value:function(t,i){var n=t.elements,e=n[3],r=n[6],s=n[4],o=n[7],a=n[5],u=n[8],l=i.c,h=i.s;n[3]=l*e-h*r,n[6]=h*e+l*r,n[4]=l*s-h*o,n[7]=h*s+l*o,n[5]=l*a-h*u,n[8]=h*a+l*u}}]),t}(),st={c:0,s:0},ot=function(){function t(){P(this,t)}return E(t,null,[{key:"rot01",value:function(t){var i=t.elements,n=i[0],e=i[1],r=i[2],s=i[3],o=i[4];d(n,e,s);var a=st.c,u=st.s,l=a*a,h=u*u,c=2*a*u*e;return i[0]=l*n-c+h*s,i[1]=0,i[2]=a*r-u*o,i[3]=h*n+c+l*s,i[4]=u*r+a*o,st}},{key:"rot02",value:function(t){var i=t.elements,n=i[0],e=i[1],r=i[2],s=i[4],o=i[5];d(n,r,o);var a=st.c,u=st.s,l=a*a,h=u*u,c=2*a*u*r;return i[0]=l*n-c+h*o,i[1]=a*e-u*s,i[2]=0,i[4]=u*e+a*s,i[5]=h*n+c+l*o,st}},{key:"rot12",value:function(t){var i=t.elements,n=i[1],e=i[2],r=i[3],s=i[4],o=i[5];d(r,s,o);var a=st.c,u=st.s,l=a*a,h=u*u,c=2*a*u*s;return i[1]=a*n-u*e,i[2]=u*n+a*e,i[3]=l*r-c+h*o,i[4]=0,i[5]=h*r+c+l*o,st}}]),t}(),at=function(){function t(){P(this,t)}return E(t,null,[{key:"solveSymmetric",value:function(t,i,n,e,r,s){var o=new et,a=new et,u=new it,l=void 0;return a.set(0,0,0,0,0,0,0,0,0),u.set(0,0,0,0,0,0),m(t,u,o,e,r),l=x(a,u,o,s),n.copy(i).applyMatrix3(a),l}},{key:"calculateError",value:function(t,i,n){var e=t.elements,r=n.clone(),s=new et;return s.set(e[0],e[1],e[2],e[1],e[3],e[4],e[2],e[4],e[5]),r.applyMatrix3(s),r.subVectors(i,r),r.lengthSq()}}]),t}(),ut=function(){function t(){var i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1e-6,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:4,e=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1e-6;P(this,t),this.svdThreshold=i,this.svdSweeps=n,this.pseudoInverseThreshold=e,this.data=null,this.massPoint=new tt,this.ata=new it,this.atb=new tt,this.x=new tt,this.hasSolution=!1}return E(t,[{key:"computeError",value:function(){var t=this.x,i=1/0,n=void 0;return this.hasSolution&&(n=this.ata.applyToVector3(t.clone()),i=t.dot(n)-2*t.dot(this.atb)+this.data.btb),i}},{key:"setData",value:function(t){return this.data=t,this.hasSolution=!1,this}},{key:"solve",value:function(){var t=this.data,i=this.massPoint,n=this.ata,e=this.atb,r=this.x,s=void 0;return!this.hasSolution&&null!==t&&t.numPoints>0&&(i.copy(t.massPoint),i.divideScalar(t.numPoints),n.copy(t.ata),e.copy(t.atb),s=n.applyToVector3(i.clone()),e.sub(s),r.set(0,0,0),t.massPointDimension=at.solveSymmetric(n,e,r,this.svdThreshold,this.svdSweeps,this.pseudoInverseThreshold),r.add(i),e.copy(t.atb),this.hasSolution=!0),r}},{key:"clear",value:function(){this.data=null,this.hasSolution=!1}}]),t}(),lt=new tt,ht=new tt,ct=new tt,dt=function(){function t(){var i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new tt,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new tt;P(this,t),this.a=i,this.b=n,this.t=0,this.n=new tt}return E(t,[{key:"approximateZeroCrossing",value:function(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:8,n=Math.max(1,i-1),e=0,r=1,s=0,o=0,a=void 0,u=void 0;for(lt.subVectors(this.b,this.a);o<=n&&(s=(e+r)/2,ht.addVectors(this.a,ct.copy(lt).multiplyScalar(s)),u=t.sample(ht),!(Math.abs(u)<=.01||(r-e)/2<=1e-6));)ht.addVectors(this.a,ct.copy(lt).multiplyScalar(e)),a=t.sample(ht),Math.sign(u)===Math.sign(a)?e=s:r=s,++o;this.t=s}},{key:"computeZeroCrossingPosition",value:function(){return lt.subVectors(this.b,this.a).multiplyScalar(this.t).add(this.a)}},{key:"computeSurfaceNormal",value:function(t){var i=this.computeZeroCrossingPosition(),n=.001,e=t.sample(ht.addVectors(i,ct.set(n,0,0)))-t.sample(ht.subVectors(i,ct.set(n,0,0))),r=t.sample(ht.addVectors(i,ct.set(0,n,0)))-t.sample(ht.subVectors(i,ct.set(0,n,0))),s=t.sample(ht.addVectors(i,ct.set(0,0,n)))-t.sample(ht.subVectors(i,ct.set(0,0,n)));this.n.set(e,r,s).normalize()}}]),t}(),yt=function t(){P(this,t),this.materials=0,this.edgeCount=0,this.index=-1,this.position=new tt,this.normal=new tt,this.qefData=null},vt=0,ft=function(t){function i(t,n){P(this,i);var e=N(this,(i.__proto__||Object.getPrototypeOf(i)).call(this,t,n));return e.voxel=null,e}return T(i,t),E(i,[{key:"contains",value:function(t){var i=this.min,n=this.size;return t.x>=i.x-1e-6&&t.y>=i.y-1e-6&&t.z>=i.z-1e-6&&t.x<=i.x+n+1e-6&&t.y<=i.y+n+1e-6&&t.z<=i.z+n+1e-6}},{key:"collapse",value:function(){var t=this.children,i=new Int16Array([-1,-1,-1,-1,-1,-1,-1,-1]),n=-1,e=null!==t,r=0,s=void 0,o=void 0,a=void 0,u=void 0,l=void 0,h=void 0,c=void 0,d=void 0;if(e){for(s=new nt,c=0,d=0;d<8;++d)r+=(a=t[d]).collapse(),l=a.voxel,null!==a.children?e=!1:null!==l&&(s.addData(l.qefData),n=l.materials>>7-d&1,i[d]=l.materials>>d&1,++c);if(e&&(o=new ut,h=o.setData(s).solve(),o.computeError()<=vt)){for((l=new yt).position.copy(this.contains(h)?h:o.massPoint),d=0;d<8;++d)u=i[d],a=t[d],-1===u?l.materials|=n<<d:(l.materials|=u<<d,l.normal.add(a.voxel.normal));l.normal.normalize(),l.qefData=s,this.voxel=l,this.children=null,r+=c-1}}return r}},{key:"lod",get:function(){return vt},set:function(t){vt=.01+t*t*t}}]),i}(V),mt=function(t){function i(t){P(this,i);var n=N(this,(i.__proto__||Object.getPrototypeOf(i)).call(this));return n.root=new ft(t.min,t.size),n.root.lod=t.data.lod,n.voxelCount=0,n.construct(t),n.simplify(),n}return T(i,t),E(i,[{key:"simplify",value:function(){this.voxelCount-=this.root.collapse()}},{key:"getCell",value:function(t,i,n,e){var r=this.root,s=0;for(t>>=1;t>0;t>>=1,s=0)i>=t&&(s+=4,i-=t),n>=t&&(s+=2,n-=t),e>=t&&(s+=1,e-=t),null===r.children&&r.split(),r=r.children[s];return r}},{key:"construct",value:function(t){var i=t.size,n=t.resolution,e=n+1,r=e*e,s=t.data,o=s.edgeData,a=s.materialIndices,u=new ut,l=t.min,h=new tt,c=new tt,d=new tt,y=new dt,v=[new Uint8Array([0,1,2,3]),new Uint8Array([0,1,4,5]),new Uint8Array([0,2,4,6])],f=0,m=void 0,p=void 0,x=void 0,k=void 0,w=void 0,z=void 0,b=void 0,A=void 0,U=void 0,M=void 0,I=void 0,S=void 0,O=void 0,_=void 0,D=void 0,P=void 0,E=void 0,C=void 0,T=void 0,N=void 0,F=void 0;for(M=4,I=0;I<3;++I,M>>=1)for(A=B[M],m=o.edges[I],p=o.zeroCrossings[I],x=o.normals[I],k=v[I],S=0,_=m.length;S<_;++S)for(C=(F=m[S])%e,T=Math.trunc(F%r/e),N=Math.trunc(F/r),h.set(C*i/n,T*i/n,N*i/n),c.set((C+A[0])*i/n,(T+A[1])*i/n,(N+A[2])*i/n),y.a.addVectors(l,h),y.b.addVectors(l,c),y.t=p[S],y.n.fromArray(x,3*S),d.copy(y.computeZeroCrossingPosition()),O=0;O<4;++O)D=C-(w=B[k[O]])[0],P=T-w[1],E=N-w[2],D>=0&&P>=0&&E>=0&&D<n&&P<n&&E<n&&(null===(U=this.getCell(n,D,P,E)).voxel&&(U.voxel=g(n,D,P,E,a),++f),(z=U.voxel).normal.add(y.n),z.qefData.add(d,y.n),z.qefData.numPoints===z.edgeCount&&(b=u.setData(z.qefData).solve(),z.position.copy(U.contains(b)?b:u.massPoint),z.normal.normalize()));this.voxelCount=f}}]),i}(Q),pt=[new Uint8Array([0,4,0]),new Uint8Array([1,5,0]),new Uint8Array([2,6,0]),new Uint8Array([3,7,0]),new Uint8Array([0,2,1]),new Uint8Array([4,6,1]),new Uint8Array([1,3,1]),new Uint8Array([5,7,1]),new Uint8Array([0,1,2]),new Uint8Array([2,3,2]),new Uint8Array([4,5,2]),new Uint8Array([6,7,2])],xt=[new Uint8Array([0,1,2,3,0]),new Uint8Array([4,5,6,7,0]),new Uint8Array([0,4,1,5,1]),new Uint8Array([2,6,3,7,1]),new Uint8Array([0,2,4,6,2]),new Uint8Array([1,3,5,7,2])],gt=[[new Uint8Array([4,0,0]),new Uint8Array([5,1,0]),new Uint8Array([6,2,0]),new Uint8Array([7,3,0])],[new Uint8Array([2,0,1]),new Uint8Array([6,4,1]),new Uint8Array([3,1,1]),new Uint8Array([7,5,1])],[new Uint8Array([1,0,2]),new Uint8Array([3,2,2]),new Uint8Array([5,4,2]),new Uint8Array([7,6,2])]],kt=[[new Uint8Array([1,4,0,5,1,1]),new Uint8Array([1,6,2,7,3,1]),new Uint8Array([0,4,6,0,2,2]),new Uint8Array([0,5,7,1,3,2])],[new Uint8Array([0,2,3,0,1,0]),new Uint8Array([0,6,7,4,5,0]),new Uint8Array([1,2,0,6,4,2]),new Uint8Array([1,3,1,7,5,2])],[new Uint8Array([1,1,0,3,2,0]),new Uint8Array([1,5,4,7,6,0]),new Uint8Array([0,1,5,0,4,1]),new Uint8Array([0,3,7,2,6,1])]],wt=[[new Uint8Array([3,2,1,0,0]),new Uint8Array([7,6,5,4,0])],[new Uint8Array([5,1,4,0,1]),new Uint8Array([7,3,6,2,1])],[new Uint8Array([6,4,2,0,2]),new Uint8Array([7,5,3,1,2])]],zt=[new Uint8Array([3,2,1,0]),new Uint8Array([7,5,6,4]),new Uint8Array([11,10,9,8])],bt=function(){function t(){P(this,t)}return E(t,null,[{key:"run",value:function(t){var i=[],n=new mt(t),e=n.voxelCount,r=null,s=null,o=null;return e>65536?console.warn("Could not create geometry for chunk at position",this.chunk.min,"with lod",this.chunk.data.lod,"(vertex count of",e,"exceeds limit of 65536)"):e>0&&(s=new Float32Array(3*e),o=new Float32Array(3*e),A(n.root,s,o,0),b(n.root,i),r={indices:new Uint16Array(i),positions:s,normals:o}),r}}]),t}(),At=function(){function t(){P(this,t)}return E(t,null,[{key:"encode",value:function(t){var i=[],n=[],e=t[0],r=1,s=void 0,o=void 0;for(s=1,o=t.length;s<o;++s)e!==t[s]?(i.push(r),n.push(e),e=t[s],r=1):++r;return i.push(r),n.push(e),{runLengths:i,data:n}}},{key:"decode",value:function(t,i){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],e=void 0,r=void 0,s=void 0,o=void 0,a=void 0,u=0;for(r=0,o=i.length;r<o;++r)for(e=i[r],s=0,a=t[r];s<a;++s)n[u++]=e;return n}}]),t}(),Ut=function(){function t(i){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:i,e=arguments.length>2&&void 0!==arguments[2]?arguments[2]:i;P(this,t),this.edges=[new Uint32Array(i),new Uint32Array(n),new Uint32Array(e)],this.zeroCrossings=[new Float32Array(i),new Float32Array(n),new Float32Array(e)],this.normals=[new Float32Array(3*i),new Float32Array(3*n),new Float32Array(3*e)]}return E(t,[{key:"createTransferList",value:function(){for(var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],i=[this.edges[0],this.edges[1],this.edges[2],this.zeroCrossings[0],this.zeroCrossings[1],this.zeroCrossings[2],this.normals[0],this.normals[1],this.normals[2]],n=void 0;i.length>0;)null!==(n=i.pop())&&t.push(n.buffer);return t}},{key:"serialise",value:function(){return{edges:this.edges,zeroCrossings:this.zeroCrossings,normals:this.normals}}},{key:"deserialise",value:function(t){this.edges=t.edges,this.zeroCrossings=t.zeroCrossings,this.normals=t.normals}}],[{key:"calculate1DEdgeCount",value:function(t){return Math.pow(t+1,2)*t}}]),t}(),Mt=0,It=0,St=function(){function t(){var i=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];P(this,t),this.lod=-1,this.neutered=!1,this.materials=0,this.materialIndices=i?new Uint8Array(It):null,this.runLengths=null,this.edgeData=null}return E(t,[{key:"set",value:function(t){return this.lod=t.lod,this.neutered=t.neutered,this.materials=t.materials,this.materialIndices=t.materialIndices,this.runLengths=t.runLengths,this.edgeData=t.edgeData,this}},{key:"setMaterialIndex",value:function(t,i){this.materialIndices[t]===$.AIR?i!==$.AIR&&++this.materials:i===$.AIR&&--this.materials,this.materialIndices[t]=i}},{key:"compress",value:function(){var t=void 0;return null===this.runLengths&&(t=this.full?{runLengths:[this.materialIndices.length],data:[$.SOLID]}:At.encode(this.materialIndices),this.runLengths=new Uint32Array(t.runLengths),this.materialIndices=new Uint8Array(t.data)),this}},{key:"decompress",value:function(){return null!==this.runLengths&&(this.materialIndices=At.decode(this.runLengths,this.materialIndices,new Uint8Array(It)),this.runLengths=null),this}},{key:"createTransferList",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];return null!==this.edgeData&&this.edgeData.createTransferList(t),t.push(this.materialIndices.buffer),t.push(this.runLengths.buffer),t}},{key:"serialise",value:function(){return this.neutered=!0,{lod:this.lod,materials:this.materials,materialIndices:this.materialIndices,runLengths:this.runLengths,edgeData:null!==this.edgeData?this.edgeData.serialise():null}}},{key:"deserialise",value:function(t){this.lod=t.lod,this.materials=t.materials,this.materialIndices=t.materialIndices,this.runLengths=t.runLengths,null!==t.edgeData?(null===this.edgeData&&(this.edgeData=new Ut(0)),this.edgeData.deserialise(t.edgeData)):this.edgeData=null,this.neutered=!1}},{key:"empty",get:function(){return 0===this.materials}},{key:"full",get:function(){return this.materials===It}}],[{key:"resolution",get:function(){return Mt},set:function(t){0===Mt&&(Mt=Math.max(1,Math.min(256,t)),It=Math.pow(Mt+1,3))}}]),t}(),Ot=function(t){function i(t,n){P(this,i);var e=N(this,(i.__proto__||Object.getPrototypeOf(i)).call(this,t,n));return e.data=null,e.csg=null,e}return T(i,t),E(i,[{key:"createTransferList",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];return null!==this.data?this.data.createTransferList(t):t}},{key:"serialise",value:function(){return{resolution:this.resolution,min:this.min.toArray(),size:this.size,data:null!==this.data?this.data.serialise():null}}},{key:"deserialise",value:function(t){this.resolution=t.resolution,this.min.fromArray(t.min),this.size=t.size,null!==t.data?(null===this.data&&(this.data=new St(!1)),this.data.deserialise(t.data)):this.data=null}},{key:"resolution",get:function(){return St.resolution},set:function(t){St.resolution=t}}]),i}(V),_t={EXTRACT:"worker.extract",MODIFY:"worker.modify",CLOSE:"worker.close"},Dt=function(){function t(){P(this,t),this.chunk=new Ot,this.message={action:_t.EXTRACT,chunk:null,positions:null,normals:null,indices:null},this.transferList=null}return E(t,[{key:"extract",value:function(t){var i=this.message,n=[];this.chunk.deserialise(t),this.chunk.data.decompress();var e=bt.run(this.chunk);null!==e?(i.indices=e.indices,i.positions=e.positions,i.normals=e.normals,n.push(i.indices.buffer),n.push(i.positions.buffer),n.push(i.normals.buffer)):(i.indices=null,i.positions=null,i.normals=null),this.chunk.deserialise(t),i.chunk=this.chunk.serialise(),this.transferList=this.chunk.createTransferList(n)}}]),t}(),Pt=function(){function t(){var i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new tt(1/0,1/0,1/0),n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new tt(-1/0,-1/0,-1/0);P(this,t),this.min=i,this.max=n}return E(t,[{key:"set",value:function(t,i){return this.min.copy(t),this.max.copy(i),this}},{key:"copy",value:function(t){return this.min.copy(t.min),this.max.copy(t.max),this}},{key:"clone",value:function(){return(new this.constructor).copy(this)}},{key:"expandByPoint",value:function(t){return this.min.min(t),this.max.max(t),this}},{key:"union",value:function(t){return this.min.min(t.min),this.max.max(t.max),this}},{key:"setFromPoints",value:function(t){var i=void 0,n=void 0;for(i=0,n=t.length;i<n;++i)this.expandByPoint(t[i]);return this}},{key:"setFromCenterAndSize",value:function(t,i){var n=i.clone().multiplyScalar(.5);return this.min.copy(t).sub(n),this.max.copy(t).add(n),this}},{key:"intersectsBox",value:function(t){return!(t.max.x<this.min.x||t.min.x>this.max.x||t.max.y<this.min.y||t.min.y>this.max.y||t.max.z<this.min.z||t.min.z>this.max.z)}}]),t}(),Et={UNION:"csg.union",DIFFERENCE:"csg.difference",INTERSECTION:"csg.intersection",DENSITY_FUNCTION:"csg.densityfunction"},Ct=function(){function t(i){P(this,t),this.type=i;for(var n=arguments.length,e=Array(n>1?n-1:0),r=1;r<n;r++)e[r-1]=arguments[r];this.children=e,this.bbox=null}return E(t,[{key:"computeBoundingBox",value:function(){var t=this.children,i=void 0,n=void 0;for(this.bbox=new Pt,i=0,n=t.length;i<n;++i)this.bbox.union(t[i].boundingBox);return this.bbox}},{key:"boundingBox",get:function(){return null!==this.bbox?this.bbox:this.computeBoundingBox()}}]),t}(),Tt=function(t){function i(){var t;P(this,i);for(var n=arguments.length,e=Array(n),r=0;r<n;r++)e[r]=arguments[r];return N(this,(t=i.__proto__||Object.getPrototypeOf(i)).call.apply(t,[this,Et.UNION].concat(e)))}return T(i,t),E(i,[{key:"updateMaterialIndex",value:function(t,i,n){var e=n.materialIndices[t];e!==$.AIR&&i.setMaterialIndex(t,e)}},{key:"selectEdge",value:function(t,i,n){return n?t.t>i.t?t:i:t.t<i.t?t:i}}]),i}(Ct),Nt=function(t){function i(){var t;P(this,i);for(var n=arguments.length,e=Array(n),r=0;r<n;r++)e[r]=arguments[r];return N(this,(t=i.__proto__||Object.getPrototypeOf(i)).call.apply(t,[this,Et.DIFFERENCE].concat(e)))}return T(i,t),E(i,[{key:"updateMaterialIndex",value:function(t,i,n){n.materialIndices[t]!==$.AIR&&i.setMaterialIndex(t,$.AIR)}},{key:"selectEdge",value:function(t,i,n){return n?t.t<i.t?t:i:t.t>i.t?t:i}}]),i}(Ct),Ft=function(t){function i(){var t;P(this,i);for(var n=arguments.length,e=Array(n),r=0;r<n;r++)e[r]=arguments[r];return N(this,(t=i.__proto__||Object.getPrototypeOf(i)).call.apply(t,[this,Et.INTERSECTION].concat(e)))}return T(i,t),E(i,[{key:"updateMaterialIndex",value:function(t,i,n){var e=n.materialIndices[t];i.setMaterialIndex(t,i.materialIndices[t]!==$.AIR&&e!==$.AIR?e:$.AIR)}},{key:"selectEdge",value:function(t,i,n){return n?t.t<i.t?t:i:t.t>i.t?t:i}}]),i}(Ct),Rt=function(){function t(){P(this,t)}return E(t,null,[{key:"run",value:function(t,i){null===t.data?i.operation===Et.UNION&&(t.data=new St,t.data.edgeData=new Ut(0)):t.data.decompress();var n=i.toCSG(),e=null!==t.data?D(t,n):null;if(null!==e){switch(i.operation){case Et.UNION:n=new Tt(n);break;case Et.DIFFERENCE:n=new Nt(n);break;case Et.INTERSECTION:n=new Ft(n)}_(t,n,t.data,e),t.data.lod=-1}null!==t.data&&(t.data.empty?t.data=null:t.data.compress())}}]),t}(),Lt={SPHERE:"sdf.sphere",BOX:"sdf.box",TORUS:"sdf.torus",PLANE:"sdf.plane",HEIGHTFIELD:"sdf.heightfield"},Bt=function(t){function i(t){P(this,i);var n=N(this,(i.__proto__||Object.getPrototypeOf(i)).call(this,Et.DENSITY_FUNCTION));return n.sdf=t,n}return T(i,t),E(i,[{key:"computeBoundingBox",value:function(){return this.bbox=this.sdf.computeBoundingBox(),this.bbox}},{key:"generateMaterialIndex",value:function(t){return this.sdf.sample(t)<=0?this.sdf.material:$.AIR}},{key:"generateEdge",value:function(t){t.approximateZeroCrossing(this.sdf),t.computeSurfaceNormal(this.sdf)}}]),i}(Ct),qt=function(){function t(i){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:$.SOLID;P(this,t),this.type=i,this.operation=null,this.material=Math.min(255,Math.max($.SOLID,Math.trunc(n))),this.children=[],this.bbox=null}return E(t,[{key:"union",value:function(t){return t.operation=Et.UNION,this.children.push(t),this}},{key:"subtract",value:function(t){return t.operation=Et.DIFFERENCE,this.children.push(t),this}},{key:"intersect",value:function(t){return t.operation=Et.INTERSECTION,this.children.push(t),this}},{key:"serialise",value:function(){var t={type:this.type,operation:this.operation,material:this.material,parameters:null,children:[]},i=this.children,n=void 0,e=void 0;for(n=0,e=i.length;n<e;++n)t.children.push(i[n].serialise());return t}},{key:"toCSG",value:function(){var t=this.children,i=new Bt(this),n=void 0,e=void 0,r=void 0,s=void 0;for(r=0,s=t.length;r<s;++r){if(e=t[r],n!==e.operation)switch(n=e.operation){case Et.UNION:i=new Tt(i);break;case Et.DIFFERENCE:i=new Nt(i);break;case Et.INTERSECTION:i=new Ft(i)}i.children.push(e.toCSG())}return i}},{key:"computeBoundingBox",value:function(){throw new Error("SDF: bounding box method not implemented!")}},{key:"sample",value:function(t){throw new Error("SDF: sample method not implemented!")}},{key:"boundingBox",get:function(){return null!==this.bbox?this.bbox:this.computeBoundingBox()}},{key:"completeBoundingBox",get:function(){var t=this.children,i=this.boundingBox.clone(),n=void 0,e=void 0;for(n=0,e=t.length;n<e;++n)i.union(t[n].completeBoundingBox);return i}}]),t}(),Vt=function(t){function i(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments[1];P(this,i);var e=N(this,(i.__proto__||Object.getPrototypeOf(i)).call(this,Lt.SPHERE,n));return e.origin=new(Function.prototype.bind.apply(tt,[null].concat(F(t.origin)))),e.radius=t.radius,e}return T(i,t),E(i,[{key:"computeBoundingBox",value:function(){return this.bbox=new Pt,this.bbox.min.copy(this.origin).subScalar(this.radius),this.bbox.max.copy(this.origin).addScalar(this.radius),this.bbox}},{key:"sample",value:function(t){var i=this.origin,n=t.x-i.x,e=t.y-i.y,r=t.z-i.z;return Math.sqrt(n*n+e*e+r*r)-this.radius}},{key:"serialise",value:function(){var t=C(i.prototype.__proto__||Object.getPrototypeOf(i.prototype),"serialise",this).call(this);return t.parameters={origin:this.origin.toArray(),radius:this.radius},t}}]),i}(qt),jt=function(t){function i(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments[1];P(this,i);var e=N(this,(i.__proto__||Object.getPrototypeOf(i)).call(this,Lt.BOX,n));return e.origin=new(Function.prototype.bind.apply(tt,[null].concat(F(t.origin)))),e.halfDimensions=new(Function.prototype.bind.apply(tt,[null].concat(F(t.halfDimensions)))),e}return T(i,t),E(i,[{key:"computeBoundingBox",value:function(){return this.bbox=new Pt,this.bbox.min.subVectors(this.origin,this.halfDimensions),this.bbox.max.addVectors(this.origin,this.halfDimensions),this.bbox}},{key:"sample",value:function(t){var i=this.origin,n=this.halfDimensions,e=Math.abs(t.x-i.x)-n.x,r=Math.abs(t.y-i.y)-n.y,s=Math.abs(t.z-i.z)-n.z,o=Math.max(e,Math.max(r,s)),a=Math.max(e,0),u=Math.max(r,0),l=Math.max(s,0),h=Math.sqrt(a*a+u*u+l*l);return Math.min(o,0)+h}},{key:"serialise",value:function(){var t=C(i.prototype.__proto__||Object.getPrototypeOf(i.prototype),"serialise",this).call(this);return t.parameters={origin:this.origin.toArray(),halfDimensions:this.halfDimensions.toArray()},t}}]),i}(qt),Ht=function(t){function i(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments[1];P(this,i);var e=N(this,(i.__proto__||Object.getPrototypeOf(i)).call(this,Lt.PLANE,n));return e.normal=new(Function.prototype.bind.apply(tt,[null].concat(F(t.normal)))),e.constant=t.constant,e}return T(i,t),E(i,[{key:"computeBoundingBox",value:function(){return this.bbox=new Pt,this.bbox}},{key:"sample",value:function(t){return this.normal.dot(t)+this.constant}},{key:"serialise",value:function(){var t=C(i.prototype.__proto__||Object.getPrototypeOf(i.prototype),"serialise",this).call(this);return t.parameters={normal:this.normal.toArray(),constant:this.constant},t}}]),i}(qt),Yt=function(t){function i(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments[1];P(this,i);var e=N(this,(i.__proto__||Object.getPrototypeOf(i)).call(this,Lt.TORUS,n));return e.origin=new(Function.prototype.bind.apply(tt,[null].concat(F(t.origin)))),e.R=t.R,e.r=t.r,e}return T(i,t),E(i,[{key:"computeBoundingBox",value:function(){return this.bbox=new Pt,this.bbox.min.copy(this.origin).subScalar(this.R).subScalar(this.r),this.bbox.max.copy(this.origin).addScalar(this.R).addScalar(this.r),this.bbox}},{key:"sample",value:function(t){var i=this.origin,n=t.x-i.x,e=t.y-i.y,r=t.z-i.z,s=Math.sqrt(n*n+r*r)-this.R;return Math.sqrt(s*s+e*e)-this.r}},{key:"serialise",value:function(){var t=C(i.prototype.__proto__||Object.getPrototypeOf(i.prototype),"serialise",this).call(this);return t.parameters={origin:this.origin.toArray(),R:this.R,r:this.r},t}}]),i}(qt),Gt=function(t){function i(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments[1];P(this,i);var e=N(this,(i.__proto__||Object.getPrototypeOf(i)).call(this,Lt.HEIGHTFIELD,n));return e.min=new(Function.prototype.bind.apply(tt,[null].concat(F(t.min)))),e.dimensions=new(Function.prototype.bind.apply(tt,[null].concat(F(t.size)))),e.data=t.data,e}return T(i,t),E(i,[{key:"computeBoundingBox",value:function(){return this.bbox=new Pt,this.bbox.min.copy(this.min),this.bbox.max.addVectors(this.min,this.dimensions),this.bbox}},{key:"sample",value:function(t){var i=this.min,n=this.dimensions,e=Math.max(i.x,Math.min(i.x+n.x,t.x-i.x)),r=Math.max(i.z,Math.min(i.z+n.z,t.z-i.z));return t.y-i.y-this.data[r*n.x+e]/255*n.y}},{key:"serialise",value:function(){var t=C(i.prototype.__proto__||Object.getPrototypeOf(i.prototype),"serialise",this).call(this);return t.parameters={min:this.min.toArray(),dimensions:this.dimensions.toArray(),data:this.data},t}}]),i}(qt),Xt=function(){function t(){P(this,t)}return E(t,null,[{key:"reviveSDF",value:function(t){var i=void 0,n=void 0,e=void 0;switch(t.type){case Lt.SPHERE:i=new Vt(t.parameters,t.material);break;case Lt.BOX:i=new jt(t.parameters,t.material);break;case Lt.TORUS:i=new Yt(t.parameters,t.material);break;case Lt.PLANE:i=new Ht(t.parameters,t.material);break;case Lt.HEIGHTFIELD:i=new Gt(t.parameters,t.material)}for(i.operation=t.operation,n=0,e=t.children.length;n<e;++n)i.children.push(this.reviveSDF(t.children[n]));return i}}]),t}(),Zt=function(){function t(){P(this,t),this.chunk=new Ot,this.message={action:_t.MODIFY,chunk:null},this.transferList=null}return E(t,[{key:"modify",value:function(t,i){this.chunk.deserialise(t),Rt.run(this.chunk,Xt.reviveSDF(i)),this.message.chunk=this.chunk.serialise(),this.transferList=this.chunk.createTransferList()}}]),t}(),Jt=new Dt,Kt=new Zt;self.addEventListener("message",function(t){var i=t.data;switch(i.action){case _t.EXTRACT:Jt.extract(i.chunk),postMessage(Jt.message,Jt.transferList);break;case _t.MODIFY:Kt.modify(i.chunk,i.sdf),postMessage(Kt.message,Kt.transferList);break;case _t.CLOSE:default:close()}}),self.addEventListener("error",function(t){var i={action:_t.CLOSE,error:t.message,data:null},n=[],e=[Jt.chunk,Kt.chunk];null===e[0].data||e[0].data.neutered?null===e[1].data||e[1].data.neutered||(i.chunk=e[1].serialise(),e[1].createTransferList(n)):(i.chunk=e[0].serialise(),e[0].createTransferList(n)),postMessage(i,n),close()})}();',Nt=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:navigator.hardwareConcurrency;U(this,e);var n=T(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return n.workerURL=URL.createObjectURL(new Blob([Tt],{type:"text/javascript"})),n.maxWorkers=Math.min(navigator.hardwareConcurrency,Math.max(t,1)),n.workers=[],n.busyWorkers=new WeakSet,n}return C(e,t),O(e,[{key:"handleEvent",value:function(t){switch(t.type){case"message":this.busyWorkers.delete(t.target),Ct.worker=t.target,Ct.data=t.data,this.dispatchEvent(Ct);break;case"error":console.error("Encountered an unexpected error.",t.message)}}},{key:"closeWorker",value:function(t){var e=this.workers.indexOf(t);this.busyWorkers.has(t)?(this.busyWorkers.delete(t),t.terminate()):t.postMessage({action:Ot.CLOSE}),t.removeEventListener("message",this),t.removeEventListener("error",this),e>=0&&this.workers.splice(e,1)}},{key:"createWorker",value:function(){var t=new Worker(this.workerURL);return this.workers.push(t),t.addEventListener("message",this),t.addEventListener("error",this),t}},{key:"getWorker",value:function(){var t=null,e=void 0;for(e=this.workers.length-1;e>=0;--e)if(!this.busyWorkers.has(this.workers[e])){t=this.workers[e],this.busyWorkers.add(t);break}return null===t&&this.workers.length<this.maxWorkers&&null!==this.workerURL&&(t=this.createWorker(),this.busyWorkers.add(t)),t}},{key:"clear",value:function(){for(;this.workers.length>0;)this.closeWorker(this.workers.pop())}},{key:"dispose",value:function(){this.clear(),URL.revokeObjectURL(this.workerURL),this.workerURL=null}}]),e}(Y),Rt=function(t){function e(t,n,i){U(this,e);var r=T(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,i));return r.action=t,r.chunk=n,r}return C(e,t),e}(q),Lt=function(t){function e(t){U(this,e);var n=T(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));return n.chunk=null,n}return C(e,t),e}(j),Ft=new Lt("modificationstart"),Bt=new Lt("modificationend"),Vt=new Lt("extractionstart"),qt=new Lt("extractionend"),jt=new e.Box3,Yt=new e.Matrix4,Xt=function(t){function n(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};U(this,n);var i=T(this,(n.__proto__||Object.getPrototypeOf(n)).call(this));return i.object=new e.Object3D,i.object.name="Terrain",i.volume=new gt(t.chunkSize,t.resolution),i.iterator=i.volume.leaves(new e.Frustum),i.levels=void 0!==t.levels?Math.max(1,t.levels):Math.log2(i.volume.resolution),i.iterations=void 0!==t.iterations?Math.max(1,t.iterations):1e3,i.threadPool=new Nt(t.workers),i.threadPool.addEventListener("message",i),i.scheduler=new V(i.levels+1),i.history=new R,i.neutered=new WeakSet,i.chunks=new WeakMap,i.meshes=new WeakMap,i.material=new Z,i}return C(n,t),O(n,[{key:"unlinkMesh",value:function(t){var e=void 0;this.meshes.has(t)&&((e=this.meshes.get(t)).geometry.dispose(),this.meshes.delete(t),this.object.remove(e))}},{key:"handleEvent",value:function(t){var e=t.worker,n=t.data,i=this.chunks.get(e);this.neutered.delete(i),this.chunks.delete(e),i.deserialise(n.chunk),null===i.data&&null===i.csg?(this.scheduler.cancel(i),this.volume.prune(i),this.unlinkMesh(i)):null!==i.csg&&this.scheduler.schedule(i,new Rt(Ot.MODIFY,i,this.scheduler.maxPriority)),n.action!==Ot.CLOSE?(n.action===Ot.EXTRACT?(t=qt,this.consolidate(i,n)):t=Bt,t.chunk=i,this.dispatchEvent(t)):console.error(n.error),this.runNextTask()}},{key:"consolidate",value:function(t,n){var i=n.positions,r=n.normals,s=n.indices,a=void 0,o=void 0;null!==i&&null!==r&&null!==s&&(this.unlinkMesh(t),(a=new e.BufferGeometry).setIndex(new e.BufferAttribute(s,1)),a.addAttribute("position",new e.BufferAttribute(i,3)),a.addAttribute("normal",new e.BufferAttribute(r,3)),a.computeBoundingSphere(),o=new e.Mesh(a,this.material),this.meshes.set(t,o),this.object.add(o))}},{key:"runNextTask",value:function(){var t=void 0,e=void 0,n=void 0,i=void 0;null!==this.scheduler.peek()&&null!==(e=this.threadPool.getWorker())&&(n=(t=this.scheduler.poll()).chunk,t.action===Ot.MODIFY?(i=Ft,e.postMessage({action:t.action,chunk:n.serialise(),sdf:n.csg.poll().serialise()},n.createTransferList()),0===n.csg.size&&(n.csg=null)):(i=Vt,e.postMessage({action:t.action,chunk:n.serialise()},n.createTransferList())),i.chunk=n,this.neutered.add(n),this.chunks.set(e,n),this.dispatchEvent(i))}},{key:"edit",value:function(t){var e=this.volume.edit(t),n=void 0,i=!0,r=!1,s=void 0;try{for(var a,o=e[Symbol.iterator]();!(i=(a=o.next()).done);i=!0)null===(n=a.value).csg&&(n.csg=new L),n.csg.add(t)}catch(t){r=!0,s=t}finally{try{!i&&o.return&&o.return()}finally{if(r)throw s}}this.iterator.reset(),this.history.push(t)}},{key:"union",value:function(t){t.operation=I.UNION,this.edit(t)}},{key:"subtract",value:function(t){t.operation=I.DIFFERENCE,this.edit(t)}},{key:"intersect",value:function(t){t.operation=I.INTERSECTION,this.edit(t)}},{key:"update",value:function(t){var e=this.iterator,n=this.scheduler,i=n.maxPriority,r=this.levels,s=r-1,a=this.iterations,o=void 0,u=void 0,l=void 0,h=void 0,c=void 0,d=void 0,v=void 0;for(e.region.setFromMatrix(Yt.multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse)),v=e.next();!v.done&&(o=v.value,u=o.data,l=o.csg,this.neutered.has(o)||(void 0===(h=n.getTask(o))||h.priority<i)&&(null!==l?(n.schedule(o,new Rt(Ot.MODIFY,o,i)),this.runNextTask()):null!==u&&(c=jt.copy(o).distanceToPoint(t.position),d=Math.min(s,Math.trunc(c/t.far*r)),u.lod!==d&&(u.lod=d,n.schedule(o,new Rt(Ot.EXTRACT,o,s-u.lod)),this.runNextTask()))),--a>0);)v=e.next();v.done&&this.iterator.reset()}},{key:"raycast",value:function(t){var e=this.meshes,n=[],i=[],r=void 0,s=void 0,a=void 0;for(this.volume.raycast(t,n),s=0,a=n.length;s<a;++s)r=n[s],e.has(r)&&(i=i.concat(t.intersectObject(e.get(r))));return i}},{key:"clearMeshes",value:function(){for(var t=this.object,e=void 0;t.children.length>0;)(e=t.children[0]).geometry.dispose(),e.material.dispose(),t.remove(e);this.meshes=new WeakMap}},{key:"clear",value:function(){this.clearMeshes(),this.volume=new gt(this.volume.chunkSize,this.volume.resolution),this.iterator=this.volume.leaves(new e.Frustum),this.neutered=new WeakSet,this.chunks=new WeakMap,this.threadPool.clear(),this.scheduler.clear(),this.history.clear()}},{key:"dispose",value:function(){this.clearMeshes(),this.threadPool.dispose()}},{key:"save",value:function(){var t=this.history.combine();return null===t?null:URL.createObjectURL(new Blob([JSON.stringify(t.serialise())],{type:"text/json"}))}},{key:"load",value:function(t){this.clear(),this.edit(Ut.reviveSDF(JSON.parse(t)))}}]),n}(Y),Ht=new lt,Zt=new lt,Gt=new lt,Wt=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new lt,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new lt;U(this,t),this.a=e,this.b=n,this.t=0,this.n=new lt}return O(t,[{key:"approximateZeroCrossing",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:8,n=Math.max(1,e-1),i=0,r=1,s=0,a=0,o=void 0,u=void 0;for(Ht.subVectors(this.b,this.a);a<=n&&(s=(i+r)/2,Zt.addVectors(this.a,Gt.copy(Ht).multiplyScalar(s)),u=t.sample(Zt),!(Math.abs(u)<=.01||(r-i)/2<=1e-6));)Zt.addVectors(this.a,Gt.copy(Ht).multiplyScalar(i)),o=t.sample(Zt),Math.sign(u)===Math.sign(o)?i=s:r=s,++a;this.t=s}},{key:"computeZeroCrossingPosition",value:function(){return Ht.subVectors(this.b,this.a).multiplyScalar(this.t).add(this.a)}},{key:"computeSurfaceNormal",value:function(t){var e=this.computeZeroCrossingPosition(),n=.001,i=t.sample(Zt.addVectors(e,Gt.set(n,0,0)))-t.sample(Zt.subVectors(e,Gt.set(n,0,0))),r=t.sample(Zt.addVectors(e,Gt.set(0,n,0)))-t.sample(Zt.subVectors(e,Gt.set(0,n,0))),s=t.sample(Zt.addVectors(e,Gt.set(0,0,n)))-t.sample(Zt.subVectors(e,Gt.set(0,0,n)));this.n.set(i,r,s).normalize()}}]),t}(),$t=function(t){function n(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,i=arguments[1],r=arguments[2];U(this,n);var s=T(this,(n.__proto__||Object.getPrototypeOf(n)).call(this));return s.name="ChunkHelper",s.chunk=t,s.add(new e.Object3D),s.add(new e.Object3D),s.add(new e.Object3D),s.gridPoints.name="GridPoints",s.edges.name="Edges",s.normals.name="Normals",s.update(i,r),s}return C(n,t),O(n,[{key:"update",value:function(){var t=arguments.length>0&&void 0!==arguments[0]&&arguments[0],e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=this.chunk;this.dispose(),null!==n&&null!==n.data&&(n.data.decompress(),t&&this.createPoints(n),e&&this.createEdges(n),n.data.compress())}},{key:"createPoints",value:function(t){var n=t.size,i=t.resolution,r=t.data.materialIndices,s=t.min,a=new e.Vector3,o=new e.Vector3,u=new Float32Array([0,0,0]),l=new e.PointsMaterial({vertexColors:e.VertexColors,sizeAttenuation:!1,size:3}),h=new e.BufferGeometry,c=t.data.materials,d=new Float32Array(3*c),v=new Float32Array(3*c),y=void 0,f=void 0,m=void 0,p=void 0,g=void 0;for(p=0,g=0,m=0;m<=i;++m)for(a.z=m*n/i,f=0;f<=i;++f)for(a.y=f*n/i,y=0;y<=i;++y)a.x=y*n/i,r[p++]!==ct.AIR&&(o.addVectors(s,a),d[g]=o.x,v[g++]=u[0],d[g]=o.y,v[g++]=u[1],d[g]=o.z,v[g++]=u[2]);h.addAttribute("position",new e.BufferAttribute(d,3)),h.addAttribute("color",new e.BufferAttribute(v,3)),this.gridPoints.add(new e.Points(h,l))}},{key:"createEdges",value:function(t){var n=t.size,i=t.resolution,r=i+1,s=r*r,a=t.data.edgeData,o=t.min,u=new e.Vector3,l=new e.Vector3,h=new e.Vector3,c=new e.Vector3,d=new Wt,v=[new Float32Array([.6,0,0]),new Float32Array([0,.6,0]),new Float32Array([0,0,.6])],y=new Float32Array([0,1,1]),f=new e.LineBasicMaterial({vertexColors:e.VertexColors}),m=void 0,p=void 0,g=void 0,x=void 0,k=void 0,w=void 0,b=void 0,z=void 0,_=void 0,A=void 0,M=void 0,S=void 0,E=void 0,P=void 0,I=void 0,U=void 0,O=void 0,D=void 0,C=void 0,T=void 0,N=void 0;for(P=4,E=0;E<3;++E,P>>=1){for(M=$[P],m=a.edges[E],p=a.zeroCrossings[E],g=a.normals[E],_=v[E],z=2*m.length,x=new Float32Array(3*z),k=new Float32Array(3*z),w=new Float32Array(3*z),b=new Float32Array(3*z),I=0,U=0,O=0,D=m.length;I<D;++I)C=(S=m[I])%r,T=Math.trunc(S%s/r),N=Math.trunc(S/s),u.set(C*n/i,T*n/i,N*n/i),l.set((C+M[0])*n/i,(T+M[1])*n/i,(N+M[2])*n/i),d.a.addVectors(o,u),d.b.addVectors(o,l),x[U]=d.a.x,k[U++]=_[0],x[U]=d.a.y,k[U++]=_[1],x[U]=d.a.z,k[U++]=_[2],x[U]=d.b.x,k[U++]=_[0],x[U]=d.b.y,k[U++]=_[1],x[U]=d.b.z,k[U++]=_[2],d.t=p[I],d.n.fromArray(g,3*I),h.copy(d.computeZeroCrossingPosition()),c.copy(h).addScaledVector(d.n,.25*n/i),w[O]=h.x,b[O++]=y[0],w[O]=h.y,b[O++]=y[1],w[O]=h.z,b[O++]=y[2],w[O]=c.x,b[O++]=y[0],w[O]=c.y,b[O++]=y[1],w[O]=c.z,b[O++]=y[2];(A=new e.BufferGeometry).addAttribute("position",new e.BufferAttribute(x,3)),A.addAttribute("color",new e.BufferAttribute(k,3)),this.edges.add(new e.LineSegments(A,f)),(A=new e.BufferGeometry).addAttribute("position",new e.BufferAttribute(w,3)),A.addAttribute("color",new e.BufferAttribute(b,3)),this.normals.add(new e.LineSegments(A,f))}}},{key:"dispose",value:function(){var t=void 0,e=void 0,n=void 0,i=void 0,r=void 0,s=void 0;for(n=0,r=this.children.length;n<r;++n){for(i=0,s=(e=(t=this.children[n]).children).length;i<s;++i)e[i].geometry.dispose(),e[i].material.dispose();for(;e.length>0;)t.remove(e[0])}}},{key:"gridPoints",get:function(){return this.children[0]}},{key:"edges",get:function(){return this.children[1]}},{key:"normals",get:function(){return this.children[2]}}]),n}(e.Object3D),Jt=function(){function t(){U(this,t),this.elements=new Float32Array([1,0,0,1,0,1])}return O(t,[{key:"set",value:function(t,e,n,i,r,s){var a=this.elements;return a[0]=t,a[1]=e,a[2]=n,a[3]=i,a[4]=r,a[5]=s,this}},{key:"identity",value:function(){return this.set(1,0,0,1,0,1),this}},{key:"copy",value:function(t){var e=t.elements;return this.set(e[0],e[1],e[2],e[3],e[4],e[5]),this}},{key:"clone",value:function(){return(new this.constructor).copy(this)}},{key:"add",value:function(t){var e=this.elements,n=t.elements;return e[0]+=n[0],e[1]+=n[1],e[2]+=n[2],e[3]+=n[3],e[4]+=n[4],e[5]+=n[5],this}},{key:"norm",value:function(){var t=this.elements,e=t[1]*t[1],n=t[2]*t[2],i=t[4]*t[4];return Math.sqrt(t[0]*t[0]+e+n+e+t[3]*t[3]+i+n+i+t[5]*t[5])}},{key:"off",value:function(){var t=this.elements;return Math.sqrt(2*(t[1]*t[1]+t[2]*t[2]+t[4]*t[4]))}},{key:"applyToVector3",value:function(t){var e=t.x,n=t.y,i=t.z,r=this.elements;return t.x=r[0]*e+r[1]*n+r[2]*i,t.y=r[1]*e+r[3]*n+r[4]*i,t.z=r[2]*e+r[4]*n+r[5]*i,t}}]),t}(),Kt=function(){function t(){U(this,t),this.elements=new Float32Array([1,0,0,0,1,0,0,0,1])}return O(t,[{key:"set",value:function(t,e,n,i,r,s,a,o,u){var l=this.elements;return l[0]=t,l[3]=e,l[6]=n,l[1]=i,l[4]=r,l[7]=s,l[2]=a,l[5]=o,l[8]=u,this}},{key:"identity",value:function(){return this.set(1,0,0,0,1,0,0,0,1),this}},{key:"copy",value:function(t){var e=t.elements;return this.set(e[0],e[3],e[6],e[1],e[4],e[7],e[2],e[5],e[8])}},{key:"clone",value:function(){return(new this.constructor).copy(this)}}]),t}(),Qt=function(){function t(){U(this,t)}return O(t,null,[{key:"rot01Post",value:function(t,e){var n=t.elements,i=n[0],r=n[3],s=n[1],a=n[4],o=n[2],u=n[5],l=e.c,h=e.s;n[0]=l*i-h*r,n[3]=h*i+l*r,n[1]=l*s-h*a,n[4]=h*s+l*a,n[2]=l*o-h*u,n[5]=h*o+l*u}},{key:"rot02Post",value:function(t,e){var n=t.elements,i=n[0],r=n[6],s=n[1],a=n[7],o=n[2],u=n[8],l=e.c,h=e.s;n[0]=l*i-h*r,n[6]=h*i+l*r,n[1]=l*s-h*a,n[7]=h*s+l*a,n[2]=l*o-h*u,n[8]=h*o+l*u}},{key:"rot12Post",value:function(t,e){var n=t.elements,i=n[3],r=n[6],s=n[4],a=n[7],o=n[5],u=n[8],l=e.c,h=e.s;n[3]=l*i-h*r,n[6]=h*i+l*r,n[4]=l*s-h*a,n[7]=h*s+l*a,n[5]=l*o-h*u,n[8]=h*o+l*u}}]),t}(),te={c:0,s:0},ee=function(){function t(){U(this,t)}return O(t,null,[{key:"rot01",value:function(t){var e=t.elements,n=e[0],i=e[1],r=e[2],s=e[3],a=e[4];f(n,i,s);var o=te.c,u=te.s,l=o*o,h=u*u,c=2*o*u*i;return e[0]=l*n-c+h*s,e[1]=0,e[2]=o*r-u*a,e[3]=h*n+c+l*s,e[4]=u*r+o*a,te}},{key:"rot02",value:function(t){var e=t.elements,n=e[0],i=e[1],r=e[2],s=e[4],a=e[5];f(n,r,a);var o=te.c,u=te.s,l=o*o,h=u*u,c=2*o*u*r;return e[0]=l*n-c+h*a,e[1]=o*i-u*s,e[2]=0,e[4]=u*i+o*s,e[5]=h*n+c+l*a,te}},{key:"rot12",value:function(t){var e=t.elements,n=e[1],i=e[2],r=e[3],s=e[4],a=e[5];f(r,s,a);var o=te.c,u=te.s,l=o*o,h=u*u,c=2*o*u*s;return e[1]=o*n-u*i,e[2]=u*n+o*i,e[3]=l*r-c+h*a,e[4]=0,e[5]=h*r+c+l*a,te}}]),t}(),ne=function(){function t(){U(this,t)}return O(t,null,[{key:"solveSymmetric",value:function(t,e,n,i,r,s){var a=new Kt,o=new Kt,u=new Jt,l=void 0;return o.set(0,0,0,0,0,0,0,0,0),u.set(0,0,0,0,0,0),x(t,u,a,i,r),l=w(o,u,a,s),n.copy(e).applyMatrix3(o),l}},{key:"calculateError",value:function(t,e,n){var i=t.elements,r=n.clone(),s=new Kt;return s.set(i[0],i[1],i[2],i[1],i[3],i[4],i[2],i[4],i[5]),r.applyMatrix3(s),r.subVectors(e,r),r.lengthSq()}}]),t}(),ie=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;U(this,t),this.x=e,this.y=n}return O(t,[{key:"set",value:function(t,e){return this.x=t,this.y=e,this}},{key:"copy",value:function(t){return this.x=t.x,this.y=t.y,this}},{key:"fromArray",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return this.x=t[e],this.y=t[e+1],this}},{key:"toArray",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return t[e]=this.x,t[e+1]=this.y,t}},{key:"equals",value:function(t){return t.x===this.x&&t.y===this.y}},{key:"clone",value:function(){return new this.constructor(this.x,this.y)}},{key:"add",value:function(t){return this.x+=t.x,this.y+=t.y,this}},{key:"addScaledVector",value:function(t,e){return this.x+=t.x*e,this.y+=t.y*e,this}},{key:"addScalar",value:function(t){return this.x+=t,this.y+=t,this}},{key:"addVectors",value:function(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this}},{key:"sub",value:function(t){return this.x-=t.x,this.y-=t.y,this}},{key:"subScalar",value:function(t){return this.x-=t,this.y-=t,this}},{key:"subVectors",value:function(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this}},{key:"multiply",value:function(t){return this.x*=t.x,this.y*=t.y,this}},{key:"multiplyScalar",value:function(t){return isFinite(t)?(this.x*=t,this.y*=t):(this.x=0,this.y=0),this}},{key:"multiplyVectors",value:function(t,e){return this.x=t.x*e.x,this.y=t.y*e.y,this}},{key:"divide",value:function(t){return this.x/=t.x,this.y/=t.y,this}},{key:"divideScalar",value:function(t){return this.multiplyScalar(1/t)}},{key:"divideVectors",value:function(t,e){return this.x=t.x/e.x,this.y=t.y/e.y,this}},{key:"negate",value:function(){return this.x=-this.x,this.y=-this.y,this}},{key:"dot",value:function(t){return this.x*t.x+this.y*t.y}},{key:"lengthSq",value:function(){return this.x*this.x+this.y*this.y}},{key:"length",value:function(){return Math.sqrt(this.x*this.x+this.y*this.y)}},{key:"distanceTo",value:function(t){return Math.sqrt(this.distanceToSquared(t))}},{key:"distanceToSquared",value:function(t){var e=this.x-t.x,n=this.y-t.y;return e*e+n*n}},{key:"normalize",value:function(){return this.divideScalar(this.length())}},{key:"min",value:function(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this}},{key:"max",value:function(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this}},{key:"clamp",value:function(t,e){return this.x=Math.max(t.x,Math.min(e.x,this.x)),this.y=Math.max(t.y,Math.min(e.y,this.y)),this}}]),t}(),re=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1e-6,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:4,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1e-6;U(this,t),this.svdThreshold=e,this.svdSweeps=n,this.pseudoInverseThreshold=i,this.data=null,this.massPoint=new lt,this.ata=new Jt,this.atb=new lt,this.x=new lt,this.hasSolution=!1}return O(t,[{key:"computeError",value:function(){var t=this.x,e=1/0,n=void 0;return this.hasSolution&&(n=this.ata.applyToVector3(t.clone()),e=t.dot(n)-2*t.dot(this.atb)+this.data.btb),e}},{key:"setData",value:function(t){return this.data=t,this.hasSolution=!1,this}},{key:"solve",value:function(){var t=this.data,e=this.massPoint,n=this.ata,i=this.atb,r=this.x,s=void 0;return!this.hasSolution&&null!==t&&t.numPoints>0&&(e.copy(t.massPoint),e.divideScalar(t.numPoints),n.copy(t.ata),i.copy(t.atb),s=n.applyToVector3(e.clone()),i.sub(s),r.set(0,0,0),t.massPointDimension=ne.solveSymmetric(n,i,r,this.svdThreshold,this.svdSweeps,this.pseudoInverseThreshold),r.add(e),i.copy(t.atb),this.hasSolution=!0),r}},{key:"clear",value:function(){this.data=null,this.hasSolution=!1}}]),t}(),se=function(){function t(){U(this,t),this.ata=new Jt,this.ata.set(0,0,0,0,0,0),this.atb=new lt,this.btb=0,this.massPoint=new lt,this.numPoints=0,this.massPointDimension=0}return O(t,[{key:"set",value:function(t,e,n,i,r){return this.ata.copy(t),this.atb.copy(e),this.btb=n,this.massPoint.copy(i),this.numPoints=r,this}},{key:"copy",value:function(t){return this.set(t.ata,t.atb,t.btb,t.massPoint,t.numPoints)}},{key:"add",value:function(t,e){var n=e.x,i=e.y,r=e.z,s=e.dot(t),a=this.ata.elements,o=this.atb;a[0]+=n*n,a[1]+=n*i,a[2]+=n*r,a[3]+=i*i,a[4]+=i*r,a[5]+=r*r,o.x+=s*n,o.y+=s*i,o.z+=s*r,this.btb+=s*s,this.massPoint.add(t),++this.numPoints}},{key:"addData",value:function(t){this.ata.add(t.ata),this.atb.add(t.atb),this.btb+=t.btb,this.massPoint.add(t.massPoint),this.numPoints+=t.numPoints}},{key:"clear",value:function(){this.ata.set(0,0,0,0,0,0),this.atb.set(0,0,0),this.btb=0,this.massPoint.set(0,0,0),this.numPoints=0}},{key:"clone",value:function(){return(new this.constructor).copy(this)}}]),t}(),ae=function t(){U(this,t),this.materials=0,this.edgeCount=0,this.index=-1,this.position=new lt,this.normal=new lt,this.qefData=null},oe=0,ue=function(t){function e(t,n){U(this,e);var i=T(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n));return i.voxel=null,i}return C(e,t),O(e,[{key:"contains",value:function(t){var e=this.min,n=this.size;return t.x>=e.x-1e-6&&t.y>=e.y-1e-6&&t.z>=e.z-1e-6&&t.x<=e.x+n+1e-6&&t.y<=e.y+n+1e-6&&t.z<=e.z+n+1e-6}},{key:"collapse",value:function(){var t=this.children,e=new Int16Array([-1,-1,-1,-1,-1,-1,-1,-1]),n=-1,i=null!==t,r=0,s=void 0,a=void 0,o=void 0,u=void 0,l=void 0,h=void 0,c=void 0,d=void 0;if(i){for(s=new se,c=0,d=0;d<8;++d)r+=(o=t[d]).collapse(),l=o.voxel,null!==o.children?i=!1:null!==l&&(s.addData(l.qefData),n=l.materials>>7-d&1,e[d]=l.materials>>d&1,++c);if(i&&(a=new re,h=a.setData(s).solve(),a.computeError()<=oe)){for((l=new ae).position.copy(this.contains(h)?h:a.massPoint),d=0;d<8;++d)u=e[d],o=t[d],-1===u?l.materials|=n<<d:(l.materials|=u<<d,l.normal.add(o.voxel.normal));l.normal.normalize(),l.qefData=s,this.voxel=l,this.children=null,r+=c-1}}return r}},{key:"lod",get:function(){return oe},set:function(t){oe=.01+t*t*t}}]),e}(K),le=function(t){function e(t){U(this,e);var n=T(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return n.root=new ue(t.min,t.size),n.root.lod=t.data.lod,n.voxelCount=0,n.construct(t),n.simplify(),n}return C(e,t),O(e,[{key:"simplify",value:function(){this.voxelCount-=this.root.collapse()}},{key:"getCell",value:function(t,e,n,i){var r=this.root,s=0;for(t>>=1;t>0;t>>=1,s=0)e>=t&&(s+=4,e-=t),n>=t&&(s+=2,n-=t),i>=t&&(s+=1,i-=t),null===r.children&&r.split(),r=r.children[s];return r}},{key:"construct",value:function(t){var e=t.size,n=t.resolution,i=n+1,r=i*i,s=t.data,a=s.edgeData,o=s.materialIndices,u=new re,l=t.min,h=new lt,c=new lt,d=new lt,v=new Wt,y=[new Uint8Array([0,1,2,3]),new Uint8Array([0,1,4,5]),new Uint8Array([0,2,4,6])],f=0,m=void 0,p=void 0,g=void 0,x=void 0,k=void 0,w=void 0,z=void 0,_=void 0,A=void 0,M=void 0,S=void 0,E=void 0,P=void 0,I=void 0,U=void 0,O=void 0,D=void 0,C=void 0,T=void 0,N=void 0,R=void 0;for(M=4,S=0;S<3;++S,M>>=1)for(_=$[M],m=a.edges[S],p=a.zeroCrossings[S],g=a.normals[S],x=y[S],E=0,I=m.length;E<I;++E)for(C=(R=m[E])%i,T=Math.trunc(R%r/i),N=Math.trunc(R/r),h.set(C*e/n,T*e/n,N*e/n),c.set((C+_[0])*e/n,(T+_[1])*e/n,(N+_[2])*e/n),v.a.addVectors(l,h),v.b.addVectors(l,c),v.t=p[E],v.n.fromArray(g,3*E),d.copy(v.computeZeroCrossingPosition()),P=0;P<4;++P)U=C-(k=$[x[P]])[0],O=T-k[1],D=N-k[2],U>=0&&O>=0&&D>=0&&U<n&&O<n&&D<n&&(null===(A=this.getCell(n,U,O,D)).voxel&&(A.voxel=b(n,U,O,D,o),++f),(w=A.voxel).normal.add(v.n),w.qefData.add(d,v.n),w.qefData.numPoints===w.edgeCount&&(z=u.setData(w.qefData).solve(),w.position.copy(A.contains(z)?z:u.massPoint),w.normal.normalize()));this.voxelCount=f}}]),e}(ot),he=function(){function t(){U(this,t)}return O(t,null,[{key:"run",value:function(t,e){null===t.data?e.operation===I.UNION&&(t.data=new ft,t.data.edgeData=new dt(0)):t.data.decompress();var n=e.toCSG(),i=null!==t.data?P(t,n):null;if(null!==i){switch(e.operation){case I.UNION:n=new wt(n);break;case I.DIFFERENCE:n=new bt(n);break;case I.INTERSECTION:n=new zt(n)}E(t,n,t.data,i),t.data.lod=-1}null!==t.data&&(t.data.empty?t.data=null:t.data.compress())}}]),t}();t.History=R,t.PriorityQueue=F,t.Queue=L,t.RunLengthEncoder=B,t.Scheduler=V,t.Task=q,t.Terrain=Xt,t.TerrainEvent=Lt,t.WorkerEvent=Dt,t.ChunkHelper=$t,t.MeshTriplanarPhysicalMaterial=Z,t.Givens=Qt,t.Matrix3=Kt,t.QEFSolver=re,t.QEFData=se,t.Schur=ee,t.SingularValueDecomposition=ne,t.SymmetricMatrix3=Jt,t.Vector2=ie,t.Vector3=lt,t.Edge=Wt,t.EdgeData=dt,t.HermiteData=ft,t.Material=ct,t.Voxel=ae,t.Chunk=mt,t.Volume=gt,t.VoxelBlock=le,t.VoxelCell=ue,t.SignedDistanceFunction=At,t.Heightfield=It,t.Sphere=Mt,t.Torus=Pt,t.Plane=Et,t.Box=St,t.ConstructiveSolidGeometry=he,t.Intersection=zt,t.Difference=bt,t.Union=wt,Object.defineProperty(t,"__esModule",{value:!0})});